:source-highlighter: pygments
:icons: font
:scripts: cjk
:stem: latexmath
:toc:
:toc: right
:toc-title: 目录
:toclevels: 4
:tip-caption: ⚡
:note-caption: ❕
:important-caption: ❗
:warning-caption: ‼️
:caution-caption: ⚠️

= 2026-02-15_调用_api_把人像照片生成卡通像方案研究

++++
<button id="toggleButton">目录开关</button>
<script>
    // 获取按钮和 div 元素
    const toggleButton = document.getElementById('toggleButton');
    const contentDiv = document.getElementById('toc');
    contentDiv.style.display = 'block';

    // 添加点击事件监听器
    toggleButton.addEventListener('click', () => {
        // 切换 div 的显示状态
        // if (contentDiv.style.display === 'none' || contentDiv.style.display === '') {
        if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'block';
        } else {
            contentDiv.style.display = 'none';
        }
    });
</script>
++++

== 大厂API收集
针对“人像转卡通”这一具体需求，以下是经过验证的、直达API功能文档页面的准确入口。

1. 百度智能云 - 人像动漫化接口
*  **直达入口**： https://cloud.baidu.com/doc/IMAGEPROCESS/s/Mk4i6olx5
*  **说明**：这是百度人脸识别技术文档的具体接口页面，搜索“人像动漫化”即可看到API调用方法。该接口专门用于将人脸照片转换为动漫风格，支持API直接调用。


2. 阿里云 - 人脸动漫化接口
*   **直达入口**： https://help.aliyun.com/zh/viapi/developer-reference/api-animation-of-characters?spm=a2c4g.11186623.help-menu-142958.d_4_3_2_3_3.2aa784c7XikaAD&scm=20140722.H_188840._.OR_help-T_cn~zh-V_1
*   **说明**：这是阿里云视觉智能开放平台（ViAPI）的具体接口文档页。文档详细描述了请求参数（ImageURL）和返回结果，可直接用于开发。


3. 腾讯云 - 人像动漫化接口
*   **直达入口**： https://cloud.tencent.com/document/product/1202/47891
*   **说明**：这是腾讯云人脸特效产品的API文档直链，提供了“人像动漫化”动作的接口说明，支持生成多种风格的卡通图片。


4. 火山引擎 - 智能创作服务: #已经测试，目前不符合需求#
*   **直达入口**： https://www.volcengine.com/docs/86081/1660198?lang=zh
*   **说明**：火山引擎将此类功能归类在“智能创作”或“视频特效”中，该文档页面包含了人像风格化的处理能力。

这些链接直接指向具体的API说明文档，您可以直接查阅接口地址和调用示例。

== 2026-02-27 火山引擎图像特效测试
图像特效：
https://www.volcengine.com/docs/86081/1804566?lang=zh

python sdk:
https://www.volcengine.com/docs/6444/1340578?lang=zh#0f05efc9

=== 1. 测试需求
1. 上传一张人像照片，可以生成卡通图片（目的是为了后续将卡通图片转换成 3D 模型供打印机使用）。

2. 生成的图片要有 4 个面，即正面、后面、左侧、右侧（方便生成更精细的 3D 模型）。

3. 生成的卡通图片不要背景。

=== 2. 测试步骤


==== 2.1 环境搭建
使用火山引擎提供的 python SDK (github starts 最多，应该比较完善)

.requirements.txt
....
fastapi
uvicorn
python-multipart
python-dotenv
volcengine
....

.run commands
[source,console]
----
source your env
pip install -r requirements.txt
----

.测试密钥：使用了 sam 提供的 AK/SK，保存于 `.env` 文件中，未上传到仓库
[source,python]
----
VOLC_AK=你的AK号
VOLC_SK=你的密钥
----

==== 2.2 单文件开发并测试 + 封装模块
生成 python 本地运行的测试文件，提供一张网络照片，查看生成效果。

- #火山引擎支持网络照片 url 提供素材#
- 火山引擎不支持本地图片上传
- 火山引擎不支持 base64 照片上传

NOTE: 同时该文件可以作为模块被 main.py 调用。

.初始化密钥
[source,console]
----
load_dotenv()

# 全局初始化，避免被 main.py 调用时每次发起请求都重新建立实例
visual_service = VisualService()
visual_service.set_ak(os.getenv("VOLC_AK"))
visual_service.set_sk(os.getenv("VOLC_SK"))


----

.定义提交图片函数
[source,python]
----
def submit_image_task(submit_form: dict) -> dict:
    """提交异步图像任务"""
    return visual_service.cv_sync2async_submit_task(submit_form)


----

.定义获取卡通图片函数
[source,python]
----
def get_task_result(req_key: str, task_id: str) -> dict:
    """获取异步任务结果"""
    get_form = {"req_key": req_key, "task_id": task_id}
    return visual_service.cv_sync2async_get_result(get_form)


----

.定义主函数，用于本地独立测试
[source,python]
----
def main():
    print(">>> 1. 准备调用 CVSync2AsyncSubmitTask 提交任务...")

    test_image_url = (
        "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=800&q=80"
    )
    req_key = "i2i_multi_style_zx2x"

    submit_form = {
        "req_key": req_key,
        # "template_id": "acrylic_ornaments",
        "template_id": "furry_dream_doll",
        "image_input1": test_image_url,
    }

    submit_resp = submit_image_task(submit_form)
    print(f"提交响应: {submit_resp}")

    if submit_resp.get("code") != 10000:
        print("提交任务失败，请检查上面打印的错误信息。")
        return

    task_id = submit_resp.get("data", {}).get("task_id")
    print(f"提交成功！拿到 Task ID: {task_id}")

    for i in range(30):
        time.sleep(2)
        print(f">>> 2. 第 {i + 1} 次查询结果...")
        result_resp = get_task_result(req_key, task_id)

        # 注意这里获取的是 'status' 字段
        status = result_resp.get("data", {}).get("status")

        # 兼容大小写
        if status and status.lower() == "done":
            images = result_resp.get("data", {}).get("binary_data_base64", [])
            if images:
                with open("img/result_angel_5.jpg", "wb") as f:
                    f.write(base64.b64decode(images[0]))
                print("任务完成！图片已保存为 result_angel.jpg")
            return
        elif status in ["FAILED", "FAIL"]:
            print(f"任务生成失败！服务端返回: {result_resp}")
            return

    print("超时未完成")



----

==== 2.3 fastapi Web服务开发
使用 python fastapi 框架生成 web 后端服务

.获取上传图片并生成URL
[source,python]
----
# 确保 filename 即使为 None 也能安全处理
original_filename = file.filename or "image.jpg"
file_ext = (
    original_filename.split(".")[-1] if "." in original_filename else "jpg"
)

# 为了防止文件名冲突，使用时间戳+随机数
temp_filename = f"img_{int(time.time())}_{os.urandom(4).hex()}.{file_ext}"
temp_filepath = os.path.join(TEMP_IMG_DIR, temp_filename)

# 保存上传的文件到本地挂载的静态目录
with open(temp_filepath, "wb") as buffer:
    buffer.write(await file.read())

# 构造火山引擎可访问的公网路径
# NOTE: 本地开发必须配合 ngrok/localtunnel 等工具，确保 base_url 是公网地址
image_url = f"{str(request.base_url)}static_images/{temp_filename}"
print(f">>> 提交给火山的 URL: {image_url}")
----

.提交任务到火山引擎生成卡通图片
[source,python]
----
req_key = "i2i_multi_style_zx2x"
submit_form = {
    "req_key": req_key,
    # "template_id": "felt_keychain",
    "template_id": "furry_dream_doll",
    "image_input1": image_url,
}

print(">>> 正在提交任务...")

# 使用 asyncio.to_thread 防止同步函数阻塞事件循环
submit_resp = await asyncio.to_thread(submit_image_task, submit_form)

if submit_resp.get("code") != 10000:
    raise HTTPException(status_code=400, detail=f"提交任务失败: {submit_resp}")

task_id = submit_resp.get("data", {}).get("task_id")
if not task_id:
    raise HTTPException(status_code=500, detail="未能获取到 task_id")

print(f">>> 任务提交成功，Task ID: {task_id}")

----

.轮询任务从火山引擎保存卡通图片 forloop 次数
[source,python]
----
max_retries = 20  # 增加轮询次数到 20 次，与测试用例看齐

for attempt in range(max_retries):
    # 使用 asyncio.sleep 避免阻塞 FastAPI 的主事件循环。
    # 因为火山引擎不能马上返回新生成的卡通图片，让 fastapi 去干别的事吧
    await asyncio.sleep(2)  # Very IMPORTANT!!!
    print(f">>> 正在查询结果 (第 {attempt + 1} 次)...")

    # 查询接口也是同步的，同样丢进线程池
    result_resp = await asyncio.to_thread(get_task_result, req_key, task_id)

    if result_resp.get("code") != 10000:
        raise HTTPException(status_code=400, detail=f"查询报错: {result_resp}")

    data = result_resp.get("data", {})
    task_status = data.get("status")

    if task_status and task_status.lower() == "done":
        print(">>> 任务完成，正在返回图片！")
        images = data.get("binary_data_base64", [])

        # 任务成功，清理本地临时图片
        if os.path.exists(temp_filepath):
            os.remove(temp_filepath)

        if images:
            result_bytes = base64.b64decode(images[0])
            return Response(content=result_bytes, media_type="image/jpeg")
        else:
            raise HTTPException(
                status_code=500, detail="任务完成但没有返回图片数据"
            )

    elif task_status in ["FAILED", "FAIL"]:
        raise HTTPException(
            status_code=400, detail="图片生成失败，服务端状态为 FAILED"
        )


# 超时处理
if os.path.exists(temp_filepath):
    os.remove(temp_filepath)
raise HTTPException(status_code=504, detail="处理超时，请稍后再试")

----

=== 3. 测试总结
从火山引擎提供的图像特效模板来看，都是有场景的效果，目前不符合需求。

IMPORTANT: 但是有一个可能的应用，即生成的特定场景的图片，如 acrylic_ornaments：亚克力挂饰、angel_figurine：天使形象手办、furry_dream_doll：毛茸茸梦幻娃娃 等等可能成为新的应用方式。再考虑……

==== 测试方式一: 使用 volc_service.py 上传图片
原始图片来源，gemini 提供的一张网上图片
https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=800&q=80

image:https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=800&q=80[testimg,360,]
image:test_img2carton_from_huoshan_engine/img/result_angel_5.jpg[test5,360,]
image:test_img2carton_from_huoshan_engine/img/result_angel_1.jpg[test1,360,]

下面是生成的图像展示：

image:test_img2carton_from_huoshan_engine/img/result_angel_2.jpg[test2,360,]
image:test_img2carton_from_huoshan_engine/img/result_angel_3.jpg[test3,360,]
image:test_img2carton_from_huoshan_engine/img/result_angel_4.jpg[test4,360,]

==== 测试方式二: 使用 fastapi 上传图片（cloudflared 内网穿透技术）
Swagger 方式测试 Web api 页面: http://127.0.0.1:8000/docs

WARNING: 本地 ip 无法提供外网图片 url 给火山引擎，因为火山引擎要外网图片 url 才行。
参考下面使用 cloudflared 的方法。

.安装并使用 cloudflared
[source,console]
----
brew install cloudflared
cloudflared tunnel --url http://localhost:8000
----

找到终端输出中类似 https://your-random-name.trycloudflare.com 的地址。
再拼接上 /docs 即可。


TIP: 开发调试用 ngrok 很爽！你可以试一试……

===== 网页上传图片测试案例
image:test_img2carton_from_huoshan_engine/waiting_upload_img/boyA.png[testimg,360,]
image:test_img2carton_from_huoshan_engine/img/通过fastapi请求火山返回的图片2.jpeg[test5,360,]
image:test_img2carton_from_huoshan_engine/img/通过fastapi请求火山返回的图片.jpeg[test5,360,]

