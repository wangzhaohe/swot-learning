<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Spring Cloud 微服务</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:45em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
/* table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7} */
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#9e9e9e}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}

/* 自定义输出 HTML 样式 */
/* 固定按钮在左上角 */
#toggleButton {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1000;
    /*background-color: lightgrey;*/
    color: #AB2C21;
    border: none;
    /*padding: 6px 10px;*/
    cursor: pointer;
}
/*#toc.toc2{width:40em}*/
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:85em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}

body.toc2.toc-right {
    padding-left: 0;
    padding-right: 0em;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>Spring Cloud 微服务</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_1_spring_cloud_微服务介绍">1. Spring Cloud 微服务介绍</a>
<ul class="sectlevel2">
<li><a href="#_1_1_什么是微服务">1.1 什么是微服务？</a></li>
<li><a href="#_1_2_微服务带来的新挑战">1.2 微服务带来的新挑战</a></li>
<li><a href="#_1_3_spring_cloud">1.3 Spring Cloud？</a></li>
<li><a href="#_1_4_cloud_的核心组件子项目">1.4 Cloud 的核心组件/子项目</a></li>
<li><a href="#_1_5_cloud_的流派">1.5 Cloud 的流派</a></li>
<li><a href="#_1_6_总结">1.6 总结</a></li>
</ul>
</li>
<li><a href="#_2_创建一个空的工程_micro_service">2. 创建一个空的工程 micro-service</a></li>
<li><a href="#_3_创建商品微服务模块_service_item">3. 创建商品微服务模块 service-item</a>
<ul class="sectlevel2">
<li><a href="#_file_service_itempom_xml">file &#8594; service-item/pom.xml</a></li>
<li><a href="#_file_service_itemsrcmainjavacomtjiseserviceitempojoitem_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/pojo/Item.java</a></li>
<li><a href="#_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemservice_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/service/ItemService.java</a></li>
<li><a href="#_file_service_itemsrcmainjavacomtjiseserviceitemcontrolleritemcontroller_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/controller/ItemController.java</a></li>
<li><a href="#_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemapplication_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/ServiceItemApplication.java</a></li>
<li><a href="#_file_service_itemsrcmainresourcesapplication_yml">file &#8594; service-item/src/main/resources/application.yml</a></li>
</ul>
</li>
<li><a href="#_4_创建订单微服务模块_service_order">4. 创建订单微服务模块 service-order</a>
<ul class="sectlevel2">
<li><a href="#_file_service_orderpom_xml">file &#8594; service-order/pom.xml</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderpojoorder_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/pojo/Order.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderpojoorderdetail_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/pojo/OrderDetail.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderpojoitem_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/pojo/Item.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceordercontrollerordercontroller_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/controller/OrderController.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</a>
<ul class="sectlevel3">
<li><a href="#_class_orderservice">class OrderService</a></li>
</ul>
</li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
<li><a href="#_file_service_ordersrcmainresourcesapplication_yml">file &#8594; service-order/src/main/resources/application.yml</a></li>
</ul>
</li>
<li><a href="#_5_http_客户端">5. HTTP 客户端</a>
<ul class="sectlevel2">
<li><a href="#_5_1_resttemplatespring_提供的传统同步_http_客户端">5.1 RestTemplate&#8201;&#8212;&#8201;Spring 提供的传统同步 HTTP 客户端</a>
<ul class="sectlevel3">
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</a></li>
</ul>
</li>
<li><a href="#_5_2_resttemplate_okhttp_可以兼容老代码">5.2 RestTemplate + OkHttp 可以兼容老代码</a>
<ul class="sectlevel3">
<li><a href="#_file_service_orderpom_xml_2">file &#8594; service-order/pom.xml</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_3">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</a></li>
</ul>
</li>
<li><a href="#_5_3_okhttp单独使用_square_开源的高性能_http_客户端">5.3 OkHttp&#8201;&#8212;&#8201;单独使用 Square 开源的高性能 HTTP 客户端</a>
<ul class="sectlevel3">
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_3">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_4">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</a></li>
</ul>
</li>
<li><a href="#_5_4_webclient_spring_webflux_提供的响应式_http_客户端">5.4 WebClient &#8201;&#8212;&#8201;Spring WebFlux 提供的响应式 HTTP 客户端</a>
<ul class="sectlevel3">
<li><a href="#_file_service_orderpom_xml_3">file &#8594; service-order/pom.xml</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_4">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_5">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</a></li>
</ul>
</li>
<li><a href="#_5_5_restclientspring_6_1_才支持目前的_spring_boot_2_7_18_使用的是_spring_5_3_x">5.5  RestClient&#8201;&#8212;&#8201;Spring 6.1 才支持（目前的 Spring Boot 2.7.18 使用的是 Spring 5.3.x）</a></li>
</ul>
</li>
<li><a href="#_6_service_order_url_硬编码问题在后面引入_eureka_后不用url直接用名字了">6. service-order url 硬编码问题（在后面引入 Eureka 后不用url，直接用名字了）</a>
<ul class="sectlevel2">
<li><a href="#_6_1_解决_service_order_url_硬编码问题以_webclient_为例使用_value">6.1 解决 service-order url 硬编码问题：以 WebClient 为例使用 @Value</a>
<ul class="sectlevel3">
<li><a href="#_file_service_ordersrcmainresourcesapplication_yml_2">file &#8594; service-order/src/main/resources/application.yml</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_5">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
</ul>
</li>
<li><a href="#_6_2_解决_service_order_url_硬编码问题使用_configurationproperties">6.2 解决 service-order url 硬编码问题：使用 @ConfigurationProperties</a>
<ul class="sectlevel3">
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderutilsitemproperties_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/utils/ItemProperties.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_6">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_7_引入微服务注册发现机制">7. 引入微服务注册、发现机制</a>
<ul class="sectlevel2">
<li><a href="#_7_1_eureka_介绍">7.1 Eureka 介绍</a></li>
<li><a href="#_7_2_eureka_server_的创建">7.2 Eureka Server 的创建</a>
<ul class="sectlevel3">
<li><a href="#_file_eurekapom_xml">file &#8594; eureka/pom.xml</a></li>
<li><a href="#_file_eurekasrcmainjavacomtjiseeurekaeurekaapplication_java">file &#8594; eureka/src/main/java/com/tjise/eureka/EurekaApplication.java</a></li>
<li><a href="#_file_eurekasrcmainresourcesapplication_yml">file &#8594; eureka/src/main/resources/application.yml</a></li>
<li><a href="#_启动_eureka_server_并测试网页管理端">启动 Eureka Server 并测试网页管理端</a></li>
</ul>
</li>
<li><a href="#_7_3_eureka_server_注册商品微服务">7.3 Eureka Server 注册商品微服务</a>
<ul class="sectlevel3">
<li><a href="#_file_service_itempom_xml_2">file &#8594; service-item/pom.xml</a></li>
<li><a href="#_file_service_itemsrcmainresourcesapplication_yml_2">file &#8594; service-item/src/main/resources/application.yml</a></li>
<li><a href="#_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemapplication_java_2">file &#8594; service-item/src/main/java/com/tjise/serviceitem/ServiceItemApplication.java</a></li>
<li><a href="#_启动多个_service_item_商品微服务实例">启动多个 service-item 商品微服务实例</a></li>
</ul>
</li>
<li><a href="#_7_4_eureka_中发现商品微服务">7.4 Eureka 中发现商品微服务</a>
<ul class="sectlevel3">
<li><a href="#_file_service_orderpom_xml_4">file &#8594; service-order/pom.xml</a></li>
<li><a href="#_file_service_ordersrcmainresourcesapplication_yml_3">file &#8594; service-order/src/main/resources/application.yml</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_7">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_6">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</a></li>
</ul>
</li>
<li><a href="#_7_5_测试_service_item_被负载均衡分配的结果">7.5 测试 service-item 被负载均衡分配的结果</a>
<ul class="sectlevel3">
<li><a href="#_7_5_1_只在_service_item_的不同实例中打印端口调用信息">7.5.1 只在 service-item 的不同实例中打印端口调用信息</a></li>
<li><a href="#_7_5_2_在_service_order_中集中打印负载均衡端口调用信息">7.5.2 在 service-order 中集中打印负载均衡端口调用信息</a></li>
</ul>
</li>
<li><a href="#_7_6_eureka_添加用户认证">7.6 Eureka 添加用户认证</a>
<ul class="sectlevel3">
<li><a href="#_file_eurekapom_xml_2">file &#8594; eureka/pom.xml</a></li>
<li><a href="#_file_eurekasrcmainresourcesapplication_yml_2">file &#8594; eureka/src/main/resources/application.yml</a></li>
<li><a href="#_file_eurekasrcmainjavacomtjiseeurekaconfwebsecurityconfig_java">file &#8594; eureka/src/main/java/com/tjise/eureka/conf/WebSecurityConfig.java</a></li>
<li><a href="#_file_service_itemsrcmainresourcesapplication_yml_3">file &#8594; service-item/src/main/resources/application.yml</a></li>
<li><a href="#_file_service_ordersrcmainresourcesapplication_yml_4">file &#8594; service-order/src/main/resources/application.yml</a></li>
</ul>
</li>
<li><a href="#_7_7_eureka_集群高可用性">7.7 Eureka 集群（高可用性）</a>
<ul class="sectlevel3">
<li><a href="#_配置_eureka">配置 Eureka</a></li>
<li><a href="#_配置_微服务2个">配置 微服务(2个)</a></li>
<li><a href="#_测试高可用性">测试高可用性</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_8_容错保护resilience4j">8. 容错保护：Resilience4j</a>
<ul class="sectlevel2">
<li><a href="#_雪崩效应">雪崩效应</a></li>
<li><a href="#_resilience4j_快速入门">Resilience4j 快速入门</a>
<ul class="sectlevel3">
<li><a href="#_file_service_orderpom_xml_5">file &#8594; service-order/pom.xml</a></li>
<li><a href="#_file_service_ordersrcmainresourcesapplication_yml_6">file &#8594; service-order/src/main/resources/application.yml</a></li>
<li><a href="#_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_4">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</a></li>
<li><a href="#_测试_resilience4j">测试 Resilience4j</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_9_feign_客户端声明式_rest_调用">9. Feign 客户端（声明式 REST 调用）</a>
<ul class="sectlevel2">
<li><a href="#_feign_与其它客户端差异与关系">Feign 与其它客户端差异与关系</a></li>
<li><a href="#_feign_与其它客户端在微服务架构中的使用场景">Feign 与其它客户端在微服务架构中的使用场景</a></li>
<li><a href="#_feign_与其它客户端代码示例对比">Feign 与其它客户端代码示例对比</a>
<ul class="sectlevel3">
<li><a href="#_项目中使用的_resttemplate_方式">项目中使用的 RestTemplate 方式</a></li>
<li><a href="#_项目中使用的_webclient_方式">项目中使用的 WebClient 方式</a></li>
<li><a href="#_项目中使用的_feign_方式">项目中使用的 Feign 方式</a></li>
</ul>
</li>
<li><a href="#_各自优势和适用场景总结">各自优势和适用场景总结</a></li>
<li><a href="#_feign_客户端配合断路器入门">Feign 客户端配合断路器入门</a>
<ul class="sectlevel3">
<li><a href="#_1_直接使用断路器_resilience4j_纯手工">1) 直接使用断路器 Resilience4j (纯手工)</a></li>
<li><a href="#_2_使用自带断路器_resilience4jspringcloud_自带在服务层更细粒度控制">2) 使用自带断路器 Resilience4j（SpringCloud 自带，在服务层更细粒度控制）</a></li>
<li><a href="#_3_使用自带断路器_feignfeign_集成_springcloud_自带的断路器_resilience4j不需要在服务层手动管理断路器">3) 使用自带断路器 Feign（Feign 集成 SpringCloud 自带的断路器 Resilience4j，不需要在服务层手动管理断路器）</a></li>
<li><a href="#_开启_spring_boot_actuator_查看断路器状态">开启 Spring Boot Actuator 查看断路器状态</a></li>
</ul>
</li>
<li><a href="#_feign_知识点">Feign 知识点</a>
<ul class="sectlevel3">
<li><a href="#_发送请求基本使用步骤总结未使用断路器_resilience4j_的步骤">发送请求基本使用步骤（总结未使用断路器 Resilience4j 的步骤）</a></li>
<li><a href="#_调用第三方api">调用第三方API</a></li>
<li><a href="#_面试题_客户端负载均衡与服务端负载均衡的区别是什么">面试题: 客户端负载均衡与服务端负载均衡的区别是什么？</a></li>
<li><a href="#_日志功能">日志功能</a></li>
<li><a href="#_超时控制">超时控制</a></li>
<li><a href="#_重试机制">重试机制</a></li>
<li><a href="#_请求和响应拦截器">请求和响应拦截器</a></li>
<li><a href="#_兜底返回_feign_with_sentinel_fallback">兜底返回 &#8594; Feign with Sentinel fallback</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_10_sentinel">10. Sentinel</a>
<ul class="sectlevel2">
<li><a href="#_docker_开启_sentinel_dashboard">docker 开启 sentinel-dashboard</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<button id="toggleButton">目录开关</button>
<script>
    // 获取按钮和 div 元素
    const toggleButton = document.getElementById('toggleButton');
    const contentDiv = document.getElementById('toc');
    contentDiv.style.display = 'block';

    // 添加点击事件监听器
    toggleButton.addEventListener('click', () => {
        // 切换 div 的显示状态
        // if (contentDiv.style.display === 'none' || contentDiv.style.display === '') {
        if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'block';
        } else {
            contentDiv.style.display = 'none';
        }
    });
</script>
</div>
</div>
<div class="sect1">
<h2 id="_1_spring_cloud_微服务介绍">1. Spring Cloud 微服务介绍</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_1_什么是微服务">1.1 什么是微服务？</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>单体架构的困境</p>
<div class="paragraph">
<p>在传统单体架构（Monolithic Architecture）中，所有功能模块（如用户管理、订单管理、支付管理等）都被打包在一个大的应用程序中，并部署在一个应用服务器上。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>优点</strong>：开发、测试、部署简单。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<div class="ulist">
<ul>
<li>
<p>复杂性高：代码庞大，耦合度高，维护困难。</p>
</li>
<li>
<p>技术栈僵化：难以引入新的技术或框架。比如多种语言开发。</p>
</li>
<li>
<p>扩展性差：无法针对特定模块进行扩展，必须扩展整个应用。</p>
</li>
<li>
<p>部署不灵活：一个小修改就需要重新部署整个应用，风险高。</p>
</li>
<li>
<p>可靠性低：一个微小的问题可能导致整个应用崩溃。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>微服务架构的解决方案</p>
<div class="paragraph">
<p>微服务架构（Microservices Architecture）是一种将单个应用程序拆分为 <mark>一组小而自治的服务</mark> 的架构风格。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>核心思想</strong>：<strong>拆分</strong> 与 <strong>解耦</strong>。</p>
</li>
<li>
<p><strong>每个服务</strong>：</p>
<div class="ulist">
<ul>
<li>
<p>围绕 <strong>业务能力</strong> 构建。</p>
</li>
<li>
<p>拥有独立的 <strong>数据库</strong> 和 <strong>数据模型</strong>。</p>
</li>
<li>
<p>可以独立 <strong>开发</strong>、<strong>部署</strong>、<strong>扩展</strong> 和 <strong>重启</strong>。</p>
</li>
<li>
<p>通过轻量级的通信机制（如 HTTP/REST、gRPC）进行协作。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>比喻：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>单体应用</strong> 像一个 <strong>大商场</strong> ：所有部门（服装、餐饮、超市）在一个大楼里，共享水电消防。一损俱损。</p>
</li>
<li>
<p><strong>微服务</strong> 像一个 <strong>商业街</strong> ：每个店铺（服务）独立经营，有自己的特色和库存，通过公共街道（网络）连接。一店装修，不影响其他店。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_微服务带来的新挑战">1.2 微服务带来的新挑战</h3>
<div class="paragraph">
<p>拆分成多个服务后，也引入了新的复杂性：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>服务发现：服务实例动态变化，消费者如何找到提供者？</p>
</li>
<li>
<p>配置管理：如何统一管理所有服务的配置，并实现动态更新？</p>
</li>
<li>
<p>负载均衡：如何将请求合理地分发到多个服务实例上？</p>
</li>
<li>
<p>容错与熔断：如何防止一个服务故障导致整个系统雪崩？</p>
</li>
<li>
<p>API 网关：如何为外部客户端提供一个统一的入口，并处理跨切面问题（认证、限流、路由）？</p>
</li>
<li>
<p>分布式事务：如何保证跨多个服务的数据一致性？</p>
</li>
<li>
<p>监控与链路追踪：如何跟踪一个请求穿越多个服务的全过程，以便排查问题？</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_spring_cloud">1.3 Spring Cloud？</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>定义</p>
<div class="paragraph">
<p>Spring Cloud 是一套基于 Spring Boot 的 <mark>微服务生态工具集</mark>。它提供了一系列 <mark>标准化的工具和组件</mark>，用于快速解决微服务架构中的常见问题（如上述挑战），让我们能更专注于业务逻辑的开发。</p>
</div>
<div class="paragraph">
<p><strong>简单来说</strong>：Spring Boot 让开发单个微服务变得简单，而 Spring Cloud 让 <mark>管理和协调</mark> 这些微服务变得简单。</p>
</div>
</li>
<li>
<p>核心定位</p>
<div class="paragraph">
<p>Spring Cloud 通过封装 <strong>Netflix</strong>、<strong>Alibaba</strong> 等公司成熟的微服务解决方案，提供了 <strong>开箱即用</strong> 的分布式系统开发体验。</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_1_4_cloud_的核心组件子项目">1.4 Cloud 的核心组件/子项目</h3>
<div class="paragraph">
<p>Spring Cloud 是一个“全家桶”，包含众多组件，以下是其中最核心的几个：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 50%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">组件名称</th>
<th class="tableblock halign-left valign-top">功能</th>
<th class="tableblock halign-left valign-top">比喻</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Eureka（国外） / Nacos（国内）</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>服务发现与注册</strong>：服务提供者启动后向注册中心注册自己的地址，消费者从注册中心拉取服务列表。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>电话簿</strong>：服务在这里注册和查找彼此的地址。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Ribbon（弃用） / LoadBalancer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>客户端负载均衡</strong>：从服务列表中选择一个实例，将请求分发过去。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>导游</strong>：在多个相同的服务实例中，选择一个带你去。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Feign（停止维护）/ OpenFeign</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>声明式HTTP客户端</strong>：基于接口和注解的方式调用远程服务，像调用本地方法一样简单。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>翻译官</strong>：帮你自动完成HTTP请求的组装和发送。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Hystrix（停止维护）/ Sentinel</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>熔断器</strong>：当服务调用失败率达到阈值时，快速失败（熔断），防止雪崩效应，并提供服务降级。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>保险丝</strong>：电流过大（故障太多）自动熔断，保护整个电路（系统）。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Zuul(停止/未开源) / Gateway</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>API网关</strong>：所有外部请求的统一入口，负责路由、过滤、认证、限流、监控等。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>前台/门卫</strong>：所有访客必须经过这里，由它决定谁可以进、去哪里。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Config / Nacos</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>分布式配置中心</strong>：集中管理所有环境的配置文件，支持动态刷新。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>公告板</strong>：所有服务从这里获取最新配置，无需重启即可生效。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Sleuth / Zipkin</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>分布式链路追踪</strong>：跟踪一个请求从开始到结束的完整路径，用于性能分析和故障排查。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>快递追踪</strong>：可以查看你的包裹（请求）经过了哪些中转站（服务）。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_1_5_cloud_的流派">1.5 Cloud 的流派</h3>
<div class="paragraph">
<p>目前主要有两大主流体系：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Netflix系</strong>：Spring Cloud Netflix（如 Eureka, Hystrix, Zuul）是早期标准，目前已部分进入维护模式。</p>
</li>
<li>
<p><strong>Alibaba系</strong>：<strong>Spring Cloud Alibaba</strong> 是目前国内最主流的方案，它提供了一站式的微服务解决方案（如 Nacos, Sentinel, Seata），与 Spring Cloud 生态无缝集成，功能强大且活跃度高。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>建议</strong>：新项目首选 <strong>Spring Cloud Alibaba</strong>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_6_总结">1.6 总结</h3>
<div class="ulist">
<ul>
<li>
<p>微服务架构通过拆分和解耦，解决了单体应用的痛点，但也带来了分布式系统的复杂性。</p>
</li>
<li>
<p><strong>Spring Cloud</strong> 不是一门新技术，而是一个 <strong>工具箱</strong>，它提供了 <strong>一整套标准化的解决方案</strong> 来轻松应对这些复杂性。</p>
</li>
<li>
<p>使用 <strong>Spring Boot + Spring Cloud</strong>，可以快速构建和治理一套完整、健壮的分布式微服务系统。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_创建一个空的工程_micro_service">2. 创建一个空的工程 micro-service</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="img/create_empty_project.png" alt="create empty project" width="800">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_创建商品微服务模块_service_item">3. 创建商品微服务模块 service-item</h2>
<div class="sectionbody">
<div class="paragraph">
<p>写完下面的代码后，使用 httpie 测试一下</p>
</div>
<div class="paragraph">
<p>http :8081/item/1</p>
</div>
<div class="sect2">
<h3 id="_file_service_itempom_xml">file &#8594; service-item/pom.xml</h3>
<div class="paragraph">
<p>&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 <a href="https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt" class="bare">https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt</a>;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.18&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository -&#8594;
    &lt;/parent&gt;
    &lt;groupId&gt;com.tjise&lt;/groupId&gt;
    &lt;artifactId&gt;service-item&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;service-item&lt;/name&gt;
    &lt;description&gt;service-item&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    &lt;!-- Lombok --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;optional&gt;true&lt;/optional&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>&lt;/project&gt;</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_itemsrcmainjavacomtjiseserviceitempojoitem_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/pojo/Item.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceitem.pojo;</p>
</div>
<div class="paragraph">
<p>import lombok.Data;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;</p>
</div>
<div class="paragraph">
<p>@Data
@NoArgsConstructor
@AllArgsConstructor
public class Item {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>private Long id;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>private String title;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>private String pic;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>private String desc;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    private Long price;
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemservice_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/service/ItemService.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceitem.service;</p>
</div>
<div class="paragraph">
<p>import com.tjise.serviceitem.pojo.Item;
import org.springframework.stereotype.Service;
import java.util.HashMap;
import java.util.Map;</p>
</div>
<div class="paragraph">
<p>@Service
public class ItemService {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>private static final Map&lt;Long, Item&gt; ITEM_MAP = new HashMap&lt;Long, Item&gt;();</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>static {// 准备一些静态数据，模拟数据库，只是为了简单而已，这样就不用 mapper 层了。
    ITEM_MAP.put(1L, new Item(1L, "商品1", "http://图片1", "商品描述1", 1000L));
    ITEM_MAP.put(2L, new Item(2L, "商品2", "http://图片2", "商品描述2", 2000L));
    ITEM_MAP.put(3L, new Item(3L, "商品3", "http://图片3", "商品描述3", 3000L));
    ITEM_MAP.put(4L, new Item(4L, "商品4", "http://图片4", "商品描述4", 4000L));
    ITEM_MAP.put(5L, new Item(5L, "商品5", "http://图片5", "商品描述5", 5000L));
    ITEM_MAP.put(6L, new Item(6L, "商品6", "http://图片6", "商品描述6", 6000L));
    ITEM_MAP.put(7L, new Item(7L, "商品7", "http://图片7", "商品描述7", 7000L));
    ITEM_MAP.put(8L, new Item(8L, "商品8", "http://图片8", "商品描述8", 8000L));
    ITEM_MAP.put(9L, new Item(9L, "商品9", "http://图片9", "商品描述9", 9000L));
    ITEM_MAP.put(10L, new Item(10L, "商品10", "http://图片10", "商品描述10", 10000L));
}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>/**
 * 模拟实现商品查询
 *
 * @param id
 * @return
 */
public Item queryItemById(Long id) {
    return ITEM_MAP.get(id);
}</pre>
</div>
</div>
<div class="paragraph">
<p>}</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_itemsrcmainjavacomtjiseserviceitemcontrolleritemcontroller_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/controller/ItemController.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceitem.controller;</p>
</div>
<div class="paragraph">
<p>import com.tjise.serviceitem.pojo.Item;
import com.tjise.serviceitem.service.ItemService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;</p>
</div>
<div class="paragraph">
<p>@RestController
public class ItemController {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@Autowired
private ItemService itemService;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    /**
     * 对外提供接口服务，查询商品信息
     *
     * @param id
     * @return
     */
    @GetMapping(value = "item/{id}")
    public Item queryItemById(@PathVariable("id") Long id) {
        return this.itemService.queryItemById(id);
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemapplication_java">file &#8594; service-item/src/main/java/com/tjise/serviceitem/ServiceItemApplication.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceitem;</p>
</div>
<div class="paragraph">
<p>import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;</p>
</div>
<div class="paragraph">
<p>@SpringBootApplication
public class ServiceItemApplication {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    public static void main(String[] args) {
        SpringApplication.run(ServiceItemApplication.class, args);
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_itemsrcmainresourcesapplication_yml">file &#8594; service-item/src/main/resources/application.yml</h3>
<div class="paragraph">
<p>server:
  port: 8081</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_创建订单微服务模块_service_order">4. 创建订单微服务模块 service-order</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_file_service_orderpom_xml">file &#8594; service-order/pom.xml</h3>
<div class="paragraph">
<p>&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 <a href="https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt" class="bare">https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt</a>;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.18&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository -&#8594;
    &lt;/parent&gt;
    &lt;groupId&gt;com.tjise&lt;/groupId&gt;
    &lt;artifactId&gt;service-order&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;service-order&lt;/name&gt;
    &lt;description&gt;service-order&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    &lt;!-- Lombok --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;optional&gt;true&lt;/optional&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceorderpojoorder_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/pojo/Order.java</h3>
<div class="listingblock">
<div class="title">订单实体类 Order</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.AllArgsConstructor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.Data</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.NoArgsConstructor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.util.Date</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.util.List</span><span class="tok-p">;</span>

<span class="tok-nd">@Data</span>
<span class="tok-nd">@NoArgsConstructor</span>
<span class="tok-nd">@AllArgsConstructor</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">Order</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">userId</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-w"> </span><span class="tok-n">createDate</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-w"> </span><span class="tok-n">updateDate</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// 包含多个商品</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceorderpojoorderdetail_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/pojo/OrderDetail.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceorder.pojo;</p>
</div>
<div class="paragraph">
<p>import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;</p>
</div>
<div class="paragraph">
<p>@Data
@NoArgsConstructor
@AllArgsConstructor
public class OrderDetail {
    private String orderId;
    private Item item;
}</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceorderpojoitem_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/pojo/Item.java</h3>
<div class="listingblock">
<div class="title">商品实体类 Item</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.AllArgsConstructor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.Data</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.NoArgsConstructor</span><span class="tok-p">;</span>

<span class="tok-nd">@Data</span>
<span class="tok-nd">@NoArgsConstructor</span>
<span class="tok-nd">@AllArgsConstructor</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">Item</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">title</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">pic</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">desc</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">price</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceordercontrollerordercontroller_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/controller/OrderController.java</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.controller</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo.Order</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.service.OrderService</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.beans.factory.annotation.Autowired</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.*</span><span class="tok-p">;</span>

<span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单控制器</span>
<span class="tok-cm"> * 处理订单相关的HTTP请求</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@RestController</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderController</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// 注入订单服务</span>
<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">OrderService</span><span class="tok-w"> </span><span class="tok-n">orderService</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 根据订单ID查询订单信息</span>
<span class="tok-cm">     *</span>
<span class="tok-cm">     * @param orderId 订单ID</span>
<span class="tok-cm">     * @return Order 订单信息</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;order/{orderId}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;orderId&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">orderService</span><span class="tok-p">.</span><span class="tok-na">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>httpie 测试:
http :8091/order/201810300001</p>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h3>
<div class="sect3">
<h4 id="_class_orderservice">class OrderService</h4>
<div class="paragraph">
<p>/**
 * 订单服务类
 * 提供订单查询功能，并通过调用商品服务获取商品详细信息
 */
@Service
public class OrderService {
    @others
}</p>
</div>
<div class="sect4">
<h5 id="_order_data_模拟数据">ORDER_DATA 模拟数据</h5>
<div class="paragraph">
<p>private static final Map&lt;String, Order&gt; ORDER_DATA = new HashMap&lt;String, Order&gt;();
static {
    // 模拟数据库，构造测试数据
    @others
}</p>
</div>
<div class="sect5">
<h6 id="_订单_order">订单 order</h6>
<div class="paragraph">
<p>Order order = new Order();
order.setOrderId("201810300001");
order.setCreateDate(new Date());
order.setUpdateDate(order.getCreateDate());  // 真会偷懒呀
order.setUserId(1L);
List&lt;OrderDetail&gt; orderDetails = new ArrayList&lt;OrderDetail&gt;();</p>
</div>
<div class="paragraph">
<p>Item item = new Item();
item.setId(1L);
orderDetails.add(new OrderDetail(order.getOrderId(), item));</p>
</div>
<div class="paragraph">
<p>item = new Item();
item.setId(2L);
orderDetails.add(new OrderDetail(order.getOrderId(), item));</p>
</div>
<div class="paragraph">
<p>order.setOrderDetails(orderDetails);</p>
</div>
<div class="paragraph">
<p>ORDER_DATA.put(order.getOrderId(), order);</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_queryorderbyid">queryOrderById</h5>
<div class="paragraph">
<p>@Autowired
private ItemService itemService;
/**
 * 根据订单ID查询订单数据
 *
 * @param orderId 订单ID
 * @return Order 订单信息，包含完整的商品详情
 */
public Order queryOrderById(String orderId) throws IOException {
    // 从模拟数据库中查询订单
    Order order = ORDER_DATA.get(orderId);
    if (null == order) {
        return null;
    }
    // 获取订单详情列表
    List&lt;OrderDetail&gt; orderDetails = order.getOrderDetails();</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    // 遍历订单详情，通过商品微服务查询商品详细数据
    for (OrderDetail orderDetail : orderDetails) {
        // 通过商品微服务查询商品详细数据
        Item item = itemService.queryItemById(orderDetail.getItem().getId());
        if (null == item) {
            continue;
        }
        // 将查询到的商品详细信息设置到订单详情中
        orderDetail.setItem(item);
    }
    return order;
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceorder.service;</p>
</div>
<div class="paragraph">
<p>import com.tjise.serviceorder.pojo.Item;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;</p>
</div>
<div class="paragraph">
<p>/**
 * 商品服务类
 * 通过 REST 方式调用商品微服务获取商品信息
 */
@Service
public class ItemService {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// Spring 框架对 RESTful 方式的 http 请求做了封装，来简化操作
@Autowired
private RestTemplate restTemplate;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    /**
     * 根据商品 ID 查询商品信息
     * 通过 REST 调用商品微服务获取商品详细数据
     *
     * @param id 商品ID
     * @return Item 商品信息
     */
    public Item queryItemById(Long id) {
        return restTemplate.getForObject("http://127.0.0.1:8081/item/"
                + id, Item.class);
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h3>
<div class="paragraph">
<p>package com.tjise.serviceorder;</p>
</div>
<div class="paragraph">
<p>import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;</p>
</div>
<div class="paragraph">
<p>/**
 * 订单服务启动类
 * Spring Boot 应用程序入口点
 */
@SpringBootApplication
public class ServiceOrderApplication {
    public static void main(String[] args) {
        SpringApplication.run(ServiceOrderApplication.class, args);
    }</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    /**
     * 创建RestTemplate实例
     * 用于调用其他微服务
     *
     * @return RestTemplate
     */
    @Bean
    public RestTemplate restTemplate() {
        // 可以在这里添加拦截器来统一处理URL前缀
        return new RestTemplate();
    }
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_service_ordersrcmainresourcesapplication_yml">file &#8594; service-order/src/main/resources/application.yml</h3>
<div class="paragraph">
<p>server:
  port: 8091</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_http_客户端">5. HTTP 客户端</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_1_resttemplatespring_提供的传统同步_http_客户端">5.1 RestTemplate&#8201;&#8212;&#8201;Spring 提供的传统同步 HTTP 客户端</h3>
<div class="paragraph">
<p>前面演示的是 方式一：字段注入（需要 @Autowired），
下面演示一下使用 方式二单个构造函数注入的例子。</p>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h4>
<div class="sect4">
<h5 id="_class_itemservice">class ItemService</h5>
<div class="paragraph">
<p>/**
 * 商品服务类
 * 通过 REST 方式调用商品微服务获取商品信息
 */
@Service
public class ItemService {
    @others
}</p>
</div>
<div class="sect5">
<h6 id="_方式二_单个构造函数注入">方式二 单个构造函数注入</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ItemService</span><span class="tok-p">(</span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">restTemplate</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_resttemplate_okhttp_可以兼容老代码">5.2 RestTemplate + OkHttp 可以兼容老代码</h3>
<div class="paragraph">
<p>为了兼容老的 RestTemplate 代码，也可以在 RestTemplate 中配置 OkHttp。</p>
</div>
<div class="sect3">
<h4 id="_file_service_orderpom_xml_2">file &#8594; service-order/pom.xml</h4>
<div class="sect4">
<h5 id="_okhttp_依赖">okhttp 依赖</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">使用</span><span class="tok-w"> </span><span class="tok-nt">Spring</span><span class="tok-w"> </span><span class="tok-nt">Boot</span><span class="tok-w"> </span><span class="tok-nt">管理的版本</span><span class="tok-err">：</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">com</span><span class="tok-nc">.squareup.okhttp3</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">okhttp</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h4>
<div class="sect4">
<h5 id="_resttemplate_resttemplate">RestTemplate restTemplate</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 创建RestTemplate实例</span>
<span class="tok-cm"> * 用于调用其他微服务</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @return RestTemplate</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Bean</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-nf">restTemplate</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 可以在这里添加拦截器来统一处理URL前缀</span>
<span class="tok-w">    </span><span class="tok-c1">// return new RestTemplate();  // 未使用 OkHttp</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OkHttp3ClientHttpRequestFactory</span><span class="tok-p">());</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_3">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h4>
<div class="sect4">
<h5 id="_方式二_单个构造函数注入增加了查看是否成功使用了_okhttp_打印">方式二 单个构造函数注入&#8201;&#8212;&#8201;增加了查看是否成功使用了 OkHttp 打印</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ItemService</span><span class="tok-p">(</span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><span class="tok-c1">// 单个构造函数</span>
<span class="tok-w">    </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">restTemplate</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-c1">// 检查请求工厂类型</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Request Factory: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">.</span><span class="tok-na">getRequestFactory</span><span class="tok-p">().</span><span class="tok-na">getClass</span><span class="tok-p">().</span><span class="tok-na">getName</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-c1">// 成功使用 OkHttp 会打印</span>
<span class="tok-w">    </span><span class="tok-c1">// Request Factory: org.springframework.http.client.OkHttp3ClientHttpRequestFactory</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_3_okhttp单独使用_square_开源的高性能_http_客户端">5.3 OkHttp&#8201;&#8212;&#8201;单独使用 Square 开源的高性能 HTTP 客户端</h3>
<div class="paragraph">
<p>OkHttp 的异步 API 在应用程序层面实现了与 Node.js 类似的高并发编程模型：通过非阻塞 I/O 和回调机制，最大化利用少量线程来处理海量网络连接，从而高效地处理高并发 HTTP 请求。</p>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_3">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h4>
<div class="sect4">
<h5 id="_okhttpclient_okhttpclient">OkHttpClient okHttpClient</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Bean</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-w"> </span><span class="tok-nf">okHttpClient</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">connectTimeout</span><span class="tok-p">(</span><span class="tok-mi">30</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">readTimeout</span><span class="tok-p">(</span><span class="tok-mi">30</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_4">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.service</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo.Item</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">okhttp3.OkHttpClient</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">okhttp3.Request</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">okhttp3.Response</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.stereotype.Service</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.io.IOException</span><span class="tok-p">;</span>

<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemService</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 下面这两种方式是等价的，看自己的使用方式而定</span>
<span class="tok-w">    </span><span class="tok-c1">// 方式一：字段注入（需要 @Autowired）</span>
<span class="tok-w">    </span><span class="tok-c1">// @Autowired</span>
<span class="tok-w">    </span><span class="tok-c1">// private OkHttpClient client;</span>

<span class="tok-w">    </span><span class="tok-c1">// 方式二 单个构造函数注入</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-w"> </span><span class="tok-n">client</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// 单个构造函数注入（不需要 @Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">ObjectMapper</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// 可支持 json 序列化</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ItemService</span><span class="tok-p">(</span><span class="tok-n">OkHttpClient</span><span class="tok-w"> </span><span class="tok-n">client</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ObjectMapper</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">client</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">client</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">objectMapper</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-c1">// 检查请求工厂类型</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Using OkHttpClient: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">getClass</span><span class="tok-p">().</span><span class="tok-na">getName</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-c1">// 打印：Using OkHttpClient: okhttp3.OkHttpClient</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Request</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Request</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-p">()</span>
<span class="tok-w">                </span><span class="tok-p">.</span><span class="tok-na">url</span><span class="tok-p">(</span><span class="tok-s">&quot;http://127.0.0.1:8081/item/&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span>
<span class="tok-w">                </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Response</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">client</span><span class="tok-p">.</span><span class="tok-na">newCall</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-c1">// 读取响应体</span>
<span class="tok-w">            </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">json</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">.</span><span class="tok-na">body</span><span class="tok-p">().</span><span class="tok-na">string</span><span class="tok-p">();</span>
<span class="tok-w">            </span><span class="tok-c1">// 使用注入的 objectMapper 反序列化成 JSON 字符串</span>
<span class="tok-w">            </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">.</span><span class="tok-na">readValue</span><span class="tok-p">(</span><span class="tok-n">json</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_4_webclient_spring_webflux_提供的响应式_http_客户端">5.4 WebClient &#8201;&#8212;&#8201;Spring WebFlux 提供的响应式 HTTP 客户端</h3>
<div class="sect3">
<h4 id="_file_service_orderpom_xml_3">file &#8594; service-order/pom.xml</h4>
<div class="sect4">
<h5 id="_webclient">WebClient</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.boot</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-boot-starter-webflux</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_4">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h4>
<div class="sect4">
<h5 id="_webclient_2">WebClient</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Bean</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-nf">webClient</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-p">.</span><span class="tok-na">builder</span><span class="tok-p">()</span>
<span class="tok-w">          </span><span class="tok-p">.</span><span class="tok-na">baseUrl</span><span class="tok-p">(</span><span class="tok-s">&quot;http://127.0.0.1:8081/item&quot;</span><span class="tok-p">)</span>
<span class="tok-w">          </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_5">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.service</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo.Item</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">okhttp3.OkHttpClient</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">okhttp3.Request</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">okhttp3.Response</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.stereotype.Service</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.reactive.function.client.WebClient</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.io.IOException</span><span class="tok-p">;</span>

<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemService</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 下面这两种方式是等价的，看自己的使用方式而定</span>
<span class="tok-w">    </span><span class="tok-c1">// 方式一：字段注入（需要 @Autowired）</span>
<span class="tok-w">    </span><span class="tok-c1">// @Autowired</span>
<span class="tok-w">    </span><span class="tok-c1">// private WebClient webClient;</span>

<span class="tok-w">    </span><span class="tok-c1">// 方式二 单个构造函数注入</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ItemService</span><span class="tok-p">(</span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">webClient</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">uri</span><span class="tok-p">(</span><span class="tok-s">&quot;/{id}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">retrieve</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">bodyToMono</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">block</span><span class="tok-p">();</span><span class="tok-w"> </span><span class="tok-c1">// 同步调用，如需要异步可去掉block()</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_5_restclientspring_6_1_才支持目前的_spring_boot_2_7_18_使用的是_spring_5_3_x">5.5  RestClient&#8201;&#8212;&#8201;Spring 6.1 才支持（目前的 Spring Boot 2.7.18 使用的是 Spring 5.3.x）</h3>
<div class="paragraph">
<p>RestClient 的主要价值在于它提供了一个现代化但又不失简单的 API，结合了 RestTemplate 的易用性和 WebClient 的功能强大，是未来 Spring 应用HTTP 客户端调用的推荐选择。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_6_service_order_url_硬编码问题在后面引入_eureka_后不用url直接用名字了">6. service-order url 硬编码问题（在后面引入 Eureka 后不用url，直接用名字了）</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_6_1_解决_service_order_url_硬编码问题以_webclient_为例使用_value">6.1 解决 service-order url 硬编码问题：以 WebClient 为例使用 @Value</h3>
<div class="paragraph">
<p>通过以上的测试发现，在订单系统中要调用商品微服务中的查询接口来获取数据，在订单微服务中将 url 硬编码到代码中，这样显然不好，因为，运行环境一旦发生变化这个 url 地址将不可用。</p>
</div>
<div class="paragraph">
<p>如何解决呢？</p>
</div>
<div class="paragraph">
<p>解决方案：将 url 地址写入到 yml 配置文件中。</p>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainresourcesapplication_yml_2">file &#8594; service-order/src/main/resources/application.yml</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">server</span><span class="tok-p">:</span>
  <span class="tok-n">port</span><span class="tok-p">:</span> <span class="tok-mi">8091</span>

<span class="tok-c1"># 新增 url 配置</span>
<span class="tok-n">myspcloud</span><span class="tok-p">:</span>
  <span class="tok-n">item</span><span class="tok-p">:</span>
    <span class="tok-n">url</span><span class="tok-p">:</span> <span class="tok-n">http</span><span class="tok-p">:</span><span class="tok-o">//</span><span class="tok-mf">127.0.0.1</span><span class="tok-p">:</span><span class="tok-mi">8081</span><span class="tok-o">/</span><span class="tok-n">item</span><span class="tok-o">/</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_5">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h4>
<div class="sect4">
<h5 id="_class_serviceorderapplication">class ServiceOrderApplication</h5>
<div class="paragraph">
<p>/**
 * 订单服务启动类
 * Spring Boot 应用程序入口点
 */
@SpringBootApplication
public class ServiceOrderApplication {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// 新增使用 @Value 注解获取配置的 url
@Value("${myspcloud.item.url}")
private String itemUrl;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    public static void main(String[] args) {
        SpringApplication.run(ServiceOrderApplication.class, args);
    }
    @others
}</pre>
</div>
</div>
<div class="sect5">
<h6 id="_webclient_3">WebClient</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Bean</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-nf">webClient</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-p">.</span><span class="tok-na">builder</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">baseUrl</span><span class="tok-p">(</span><span class="tok-n">itemUrl</span><span class="tok-p">)</span><span class="tok-w">   </span><span class="tok-c1">// 使用注入的 Url</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_6_2_解决_service_order_url_硬编码问题使用_configurationproperties">6.2 解决 service-order url 硬编码问题：使用 @ConfigurationProperties</h3>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderutilsitemproperties_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/utils/ItemProperties.java</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.utils</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">lombok.Data</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.stereotype.Component</span><span class="tok-p">;</span>


<span class="tok-nd">@Data</span>
<span class="tok-nd">@Component</span>
<span class="tok-nd">@ConfigurationProperties</span><span class="tok-p">(</span><span class="tok-n">prefix</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;myspcloud.item&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemProperties</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 下面属性值的内容会从配置文件中被自动获取到</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">url</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_6">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h4>
<div class="sect4">
<h5 id="_class_serviceorderapplication_2">class ServiceOrderApplication</h5>
<div class="paragraph">
<p>/**
 * 订单服务启动类
 * Spring Boot 应用程序入口点
 */
@SpringBootApplication
public class ServiceOrderApplication {
    @others
}</p>
</div>
<div class="sect5">
<h6 id="_di_itempropertiesnew_added">DI itemProperties&#8201;&#8212;&#8201;New Added</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 成员注入的方式</span>
<span class="tok-c1">// @Autowired</span>
<span class="tok-c1">// private ItemProperties itemProperties;</span>

<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">ItemProperties</span><span class="tok-w"> </span><span class="tok-n">itemProperties</span><span class="tok-p">;</span>
<span class="tok-c1">// 单构造器注入，不用 @Autowired</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ServiceOrderApplication</span><span class="tok-p">(</span><span class="tok-n">ItemProperties</span><span class="tok-w"> </span><span class="tok-n">itemProperties</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">itemProperties</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">itemProperties</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_public_static_void_main">public static void main</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">SpringApplication</span><span class="tok-p">.</span><span class="tok-na">run</span><span class="tok-p">(</span><span class="tok-n">ServiceOrderApplication</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_bean_webclientnew_added">@Bean WebClient&#8201;&#8212;&#8201;New Added</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 方法参数注入（直接从 Spring 容器里获取 ItemProperties）</span>
<span class="tok-nd">@Bean</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-nf">webClient</span><span class="tok-p">(</span><span class="tok-n">ItemProperties</span><span class="tok-w"> </span><span class="tok-n">properties</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-p">.</span><span class="tok-na">builder</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">baseUrl</span><span class="tok-p">(</span><span class="tok-n">properties</span><span class="tok-p">.</span><span class="tok-na">getUrl</span><span class="tok-p">())</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_7_引入微服务注册发现机制">7. 引入微服务注册、发现机制</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>问题：商品微服务 ip 发生变更则需要更改订单微服务的配置文件</p>
</li>
<li>
<p>问题：商品微服务有多个，订单微服务该链接哪个？</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>从而引入微服务注册、发现机制，如下。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/service_register.png" alt="service register" width="640">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>服务提供者将服务注册到注册中心</p>
</li>
<li>
<p>服务消费者通过注册中心查找服务</p>
</li>
<li>
<p>查找到服务后进行调用（这里就是无需硬编码 url 的解决方案）</p>
</li>
<li>
<p>服务的消费者与服务注册中心保持心跳连接，一旦服务提供者的地址发生变更时，注册中心会通知服务消费者</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_7_1_eureka_介绍">7.1 Eureka 介绍</h3>
<div class="paragraph">
<p>Eureka 是 Netfix 开源的服务发现组件，本身是一个基于 REST 的服务。它包含 Server 和 Client 两部分。SpringCloud 将它集成在子项目 SpringCloud Netfix 中，从而实现微服务的注册与发现。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eureka Server 提供服务注册服务，各个节点启动后，会在 Eureka Server 中进行注册，这样 EurekaServer 中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观的看到。</p>
</li>
<li>
<p>Eureka Client 是一个 java 客户端，用于简化与 Eureka Server 的交互，客户端同时也有一个内置的、使用轮询(round-robin)负载算法的负载均衡器。</p>
</li>
<li>
<p>在应用启动后，将会向 Eureka Server 发送心跳,默认周期为 30 秒，如果 Eureka Server 在多个心跳周期内没有接收到某个节点的心跳，Eureka Server 将会从服务注册表中把这个服务节点移除(默认90秒)。</p>
</li>
<li>
<p>Eureka Server 之间通过复制的方式完成数据的同步，Eureka 还提供了客户端缓存机制，即使所有的 Eureka Server 都挂掉，客户端依然可以利用缓存中的信息消费其他服务的 API。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>综上，Eureka 通过心跳检查、客户端缓存等机制，确保了系统的高可用性、灵活性和可伸缩性。</p>
</div>
</div>
<div class="sect2">
<h3 id="_7_2_eureka_server_的创建">7.2 Eureka Server 的创建</h3>
<div class="paragraph">
<p>创建一个 maven 的项目，命名为 eureka。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/create_eureka_module.png" alt="create eureka module" width="800">
</div>
</div>
<div class="sect3">
<h4 id="_file_eurekapom_xml">file &#8594; eureka/pom.xml</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">project</span><span class="tok-w"> </span><span class="tok-nt">xmlns</span><span class="tok-o">=</span><span class="tok-s2">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
<span class="tok-w">         </span><span class="tok-nt">xmlns</span><span class="tok-nd">:xsi</span><span class="tok-o">=</span><span class="tok-s2">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="tok-w">         </span><span class="tok-nt">xsi</span><span class="tok-nd">:schemaLocation</span><span class="tok-o">=</span><span class="tok-s2">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">modelVersion</span><span class="tok-o">&gt;</span><span class="tok-nt">4</span><span class="tok-nc">.0.0</span><span class="tok-o">&lt;/</span><span class="tok-nt">modelVersion</span><span class="tok-o">&gt;</span>

<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">com</span><span class="tok-nc">.tjise</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">eureka</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-nt">1</span><span class="tok-nc">.0-SNAPSHOT</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">加入下面各项内容</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">@</span><span class="tok-nt">others</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">project</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_properties_配置项目属性java_版本spring_boot_和_spring_cloud_版本">properties 配置项目属性：Java 版本、Spring Boot 和 Spring Cloud 版本</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">properties</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">maven</span><span class="tok-nc">.compiler.source</span><span class="tok-o">&gt;</span><span class="tok-nt">8</span><span class="tok-o">&lt;/</span><span class="tok-nt">maven</span><span class="tok-nc">.compiler.source</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">maven</span><span class="tok-nc">.compiler.target</span><span class="tok-o">&gt;</span><span class="tok-nt">8</span><span class="tok-o">&lt;/</span><span class="tok-nt">maven</span><span class="tok-nc">.compiler.target</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">project</span><span class="tok-nc">.build.sourceEncoding</span><span class="tok-o">&gt;</span><span class="tok-nt">UTF-8</span><span class="tok-o">&lt;/</span><span class="tok-nt">project</span><span class="tok-nc">.build.sourceEncoding</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">这两个版本要匹配才行</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">spring</span><span class="tok-nc">.boot.version</span><span class="tok-o">&gt;</span><span class="tok-nt">2</span><span class="tok-nc">.7.18</span><span class="tok-o">&lt;/</span><span class="tok-nt">spring</span><span class="tok-nc">.boot.version</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">spring</span><span class="tok-nc">.cloud.version</span><span class="tok-o">&gt;</span><span class="tok-nt">2021</span><span class="tok-nc">.0.8</span><span class="tok-o">&lt;/</span><span class="tok-nt">spring</span><span class="tok-nc">.cloud.version</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">properties</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dependencymanagement_依赖管理导入_spring_boot_和_spring_cloud_的依赖管理">dependencyManagement 依赖管理：导入 Spring Boot 和 Spring Cloud 的依赖管理</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependencyManagement</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">Spring</span><span class="tok-w"> </span><span class="tok-nt">Boot</span><span class="tok-w"> </span><span class="tok-nt">依赖管理</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.boot</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-boot-dependencies</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-err">$</span><span class="tok-p">{</span><span class="tok-nt">spring</span><span class="tok-nc">.boot.version</span><span class="tok-p">}</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span><span class="tok-nt">pom</span><span class="tok-o">&lt;/</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span><span class="tok-nt">import</span><span class="tok-o">&lt;/</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">Spring</span><span class="tok-w"> </span><span class="tok-nt">Cloud依赖管理</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-dependencies</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-err">$</span><span class="tok-p">{</span><span class="tok-nt">spring</span><span class="tok-nc">.cloud.version</span><span class="tok-p">}</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span><span class="tok-nt">pom</span><span class="tok-o">&lt;/</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span><span class="tok-nt">import</span><span class="tok-o">&lt;/</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependencyManagement</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dependencies_项目依赖添加_eureka_server_依赖">dependencies 项目依赖：添加 Eureka Server 依赖</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">Eureka</span><span class="tok-w"> </span><span class="tok-nt">Server核心依赖</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-starter-netflix-eureka-server</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_plugins_构建配置添加_spring_boot_maven_插件">plugins 构建配置：添加 Spring Boot Maven 插件</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">build</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">plugins</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">Spring</span><span class="tok-w"> </span><span class="tok-nt">Boot</span><span class="tok-w"> </span><span class="tok-nt">Maven插件</span><span class="tok-err">，</span><span class="tok-nt">用于打包可执行jar</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">plugin</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.boot</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-boot-maven-plugin</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-err">$</span><span class="tok-p">{</span><span class="tok-nt">spring</span><span class="tok-nc">.boot.version</span><span class="tok-p">}</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;/</span><span class="tok-nt">plugin</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;/</span><span class="tok-nt">plugins</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">build</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_eurekasrcmainjavacomtjiseeurekaeurekaapplication_java">file &#8594; eureka/src/main/java/com/tjise/eureka/EurekaApplication.java</h4>
<div class="paragraph">
<p>package com.tjise.eureka;</p>
</div>
<div class="paragraph">
<p>import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</p>
</div>
<div class="paragraph">
<p>/**
 * Eureka Server启动类
 *
 * @EnableEurekaServer 注解启用 Eureka Server 功能
 */
@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_eurekasrcmainresourcesapplication_yml">file &#8594; eureka/src/main/resources/application.yml</h4>
<div class="paragraph">
<p>server:
  port: 8761  # 1. Eureka Server端口设置为8761（默认端口）</p>
</div>
<div class="paragraph">
<p>eureka:
  instance:
    hostname: localhost  # 2. 设置主机名为localhost
  client:
    register-with-eureka: false  # 3. Eureka Server不向自己注册
    fetch-registry: false        # 4. Eureka 自己不需要获取服务注册信息
    service-url:
      # 5. 设置 Eureka Server 的访问地址
      defaultZone: <a href="http://${eureka.instance.hostname}:${server.port}/eureka/" class="bare">http://${eureka.instance.hostname}:${server.port}/eureka/</a></p>
</div>
<div class="literalblock">
<div class="content">
<pre>server:
  enable-self-preservation: false  # 6. 关闭自我保护机制（开发环境建议关闭，但是会有红色警告提示，属于正常）
                                   # 设置成 false 后保证服务不可用时及时剔除相应的微服务，易测试。</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_启动_eureka_server_并测试网页管理端">启动 Eureka Server 并测试网页管理端</h4>
<div class="paragraph">
<p>现在可以通过以下命令启动 Eureka Server：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>进入eureka项目目录</p>
<div class="ulist">
<ul>
<li>
<p>cd /Users/swot/swot-learning/java/SpringCloud/eureka</p>
</li>
</ul>
</div>
</li>
<li>
<p>使用 IDEA 启动应用</p>
<div class="ulist">
<ul>
<li>
<p>mvn spring-boot:run</p>
</li>
</ul>
</div>
</li>
<li>
<p>或者先打包再运行</p>
<div class="ulist">
<ul>
<li>
<p>mvn clean package</p>
</li>
<li>
<p>java -jar target/eureka-1.0-SNAPSHOT.jar</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>启动后访问 <a href="http://localhost:8761" class="bare">http://localhost:8761</a> 即可看到 Eureka Server 的管理界面。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/eureka_admin_no_instance.png" alt="eureka admin no instance">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_7_3_eureka_server_注册商品微服务">7.3 Eureka Server 注册商品微服务</h3>
<div class="paragraph">
<p>成功注册 service-item 到 eureka 是这样的，如下图</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/eureka_admin_with_service-item.png" alt="eureka admin with service item">
</div>
</div>
<div class="sect3">
<h4 id="_file_service_itempom_xml_2">file &#8594; service-item/pom.xml</h4>
<div class="sect4">
<h5 id="_properties_add_cloud_version_2021_0_8">properties Add cloud Version 2021.0.8</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">properties</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">java</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span><span class="tok-nt">1</span><span class="tok-nc">.8</span><span class="tok-o">&lt;/</span><span class="tok-nt">java</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">spring-cloud</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span><span class="tok-nt">2021</span><span class="tok-nc">.0.8</span><span class="tok-o">&lt;/</span><span class="tok-nt">spring-cloud</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">properties</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dependencymanagement_add_cloud_dependency">dependencyManagement Add cloud dependency</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependencyManagement</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-dependencies</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-err">$</span><span class="tok-p">{</span><span class="tok-nt">spring-cloud</span><span class="tok-nc">.version</span><span class="tok-p">}</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span><span class="tok-nt">pom</span><span class="tok-o">&lt;/</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span><span class="tok-nt">import</span><span class="tok-o">&lt;/</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependencyManagement</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_spring_cloud_starter_netflix_eureka_client">spring-cloud-starter-netflix-eureka-client</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">添加</span><span class="tok-w"> </span><span class="tok-nt">Eureka</span><span class="tok-w"> </span><span class="tok-nt">客户端依赖</span><span class="tok-o">,</span><span class="tok-w"> </span><span class="tok-nt">用于将服务注册到</span><span class="tok-w"> </span><span class="tok-nt">Eureka</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-starter-netflix-eureka-client</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_itemsrcmainresourcesapplication_yml_2">file &#8594; service-item/src/main/resources/application.yml</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1">### 服务端口号(本身是一个web项目)</span>
<span class="tok-n">server</span><span class="tok-p">:</span>
    <span class="tok-n">port</span><span class="tok-p">:</span> <span class="tok-mi">8081</span>

<span class="tok-c1">### 起个名字作为服务名称(该服务注册到eureka注册中心的名称，比如商品服务)</span>
<span class="tok-n">spring</span><span class="tok-p">:</span>
    <span class="tok-n">application</span><span class="tok-p">:</span>
        <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">app</span><span class="tok-o">-</span><span class="tok-n">item</span>

<span class="tok-c1">### 服务注册到eureka注册中心的地址</span>
<span class="tok-n">eureka</span><span class="tok-p">:</span>
    <span class="tok-n">client</span><span class="tok-p">:</span>
        <span class="tok-n">service</span><span class="tok-o">-</span><span class="tok-n">url</span><span class="tok-p">:</span>
            <span class="tok-n">defaultZone</span><span class="tok-p">:</span> <span class="tok-n">http</span><span class="tok-p">:</span><span class="tok-o">//</span><span class="tok-mf">127.0.0.1</span><span class="tok-p">:</span><span class="tok-mi">8761</span><span class="tok-o">/</span><span class="tok-n">eureka</span><span class="tok-o">/</span>
        <span class="tok-c1">### 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
        <span class="tok-n">register</span><span class="tok-o">-</span><span class="tok-k">with</span><span class="tok-o">-</span><span class="tok-n">eureka</span><span class="tok-p">:</span> <span class="tok-n">true</span>
        <span class="tok-c1">### 是否需要从 eureka 上检索服务</span>
        <span class="tok-n">fetch</span><span class="tok-o">-</span><span class="tok-n">registry</span><span class="tok-p">:</span> <span class="tok-n">true</span>
    <span class="tok-n">instance</span><span class="tok-p">:</span>
        <span class="tok-c1"># 使用IP地址注册而不是主机名</span>
        <span class="tok-n">prefer</span><span class="tok-o">-</span><span class="tok-n">ip</span><span class="tok-o">-</span><span class="tok-n">address</span><span class="tok-p">:</span> <span class="tok-n">true</span>
        <span class="tok-c1"># 客户端在注册时使用自己的IP，而不是主机名，是生产环境的最佳实践。避免主机名解析问题</span>
        <span class="tok-n">ip</span><span class="tok-o">-</span><span class="tok-n">address</span><span class="tok-p">:</span> <span class="tok-mf">127.0.0.1</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>name 和 instance 两者都有重要作用，缺一不可：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring.application.name：服务的逻辑名称，用于服务发现和负载均衡</p>
</li>
<li>
<p>eureka.instance 配置：实例的网络地址，用于实际通信</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>即使使用IP注册，仍然需要服务名称来进行服务发现和调用。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemapplication_java_2">file &#8594; service-item/src/main/java/com/tjise/serviceitem/ServiceItemApplication.java</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceitem</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.boot.SpringApplication</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="tok-p">;</span>

<span class="tok-nd">@SpringBootApplication</span>
<span class="tok-nd">@EnableEurekaClient</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ServiceItemApplication</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">SpringApplication</span><span class="tok-p">.</span><span class="tok-na">run</span><span class="tok-p">(</span><span class="tok-n">ServiceItemApplication</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>启用 uereka 客户端注解</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_启动多个_service_item_商品微服务实例">启动多个 service-item 商品微服务实例</h4>
<div class="paragraph">
<p>重复操作下面步骤 2 次，一共启动 3 个 service-item 实例。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/serviceItem_copy_config.png" alt="serviceItem copy config">
</div>
<div class="title">Figure 1. 复制 service-item 配置</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/serviceItem_copy_config_edit_8082.png" alt="serviceItem copy config edit 8082" width="520">
</div>
<div class="title">Figure 2. 编辑 service-item 配置启动新端口</div>
</div>
<div class="paragraph">
<p>启动 3 个实例，如下图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/three_serviceItem_in_eureka.png" alt="three serviceItem in eureka">
</div>
<div class="title">Figure 3. 在 Eureka 中发现有 3 个 service-item 实例已经注册成功</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_7_4_eureka_中发现商品微服务">7.4 Eureka 中发现商品微服务</h3>
<div class="paragraph">
<p>之前我们在订单系统中是将商品微服务的地址进行了硬编码，现在，由于已经将商品服务注册到 Eureka 中，所以，只需要从 Eureka 中发现服务即可。</p>
</div>
<div class="paragraph">
<p>想要从 Eureka 中发现服务，需要先将 service-order 成功注册到 eureka，如下图是成功注册后的截图。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/eureka_admin_with_service-order.png" alt="eureka admin with service order">
</div>
</div>
<div class="paragraph">
<p>httpie 测试注册 service-order 到 Eureka 后，也是可以正常运行的:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">http :8091/order/201810300001</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_orderpom_xml_4">file &#8594; service-order/pom.xml</h4>
<div class="sect4">
<h5 id="_properties_version">properties version</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">properties</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">java</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span><span class="tok-nt">1</span><span class="tok-nc">.8</span><span class="tok-o">&lt;/</span><span class="tok-nt">java</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">spring-cloud</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span><span class="tok-nt">2021</span><span class="tok-nc">.0.8</span><span class="tok-o">&lt;/</span><span class="tok-nt">spring-cloud</span><span class="tok-nc">.version</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">properties</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_add_cloud_dependency">Add cloud dependency</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependencyManagement</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-dependencies</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-err">$</span><span class="tok-p">{</span><span class="tok-nt">spring-cloud</span><span class="tok-nc">.version</span><span class="tok-p">}</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span><span class="tok-nt">pom</span><span class="tok-o">&lt;/</span><span class="tok-nt">type</span><span class="tok-o">&gt;</span>
<span class="tok-w">            </span><span class="tok-o">&lt;</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span><span class="tok-nt">import</span><span class="tok-o">&lt;/</span><span class="tok-nt">scope</span><span class="tok-o">&gt;</span>
<span class="tok-w">        </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependencies</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependencyManagement</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eureka_client_依赖">eureka-client 依赖</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">添加</span><span class="tok-w"> </span><span class="tok-nt">Eureka</span><span class="tok-w"> </span><span class="tok-nt">客户端依赖</span><span class="tok-o">,</span><span class="tok-w"> </span><span class="tok-nt">用于将服务注册到</span><span class="tok-w"> </span><span class="tok-nt">Eureka</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-starter-netflix-eureka-client</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainresourcesapplication_yml_3">file &#8594; service-order/src/main/resources/application.yml</h4>
<div class="sect4">
<h5 id="_port">port</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8091</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_name">name</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eureka">eureka</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 服务注册到 eureka 注册中心的地址</span>
<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://127.0.0.1:8761/eureka</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">        </span><span class="tok-c1"># 是否需要从 eureka 上检索服务</span>
<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">     </span><span class="tok-c1"># 使用 IP地址 注册而不是主机名</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span><span class="tok-w">       </span><span class="tok-c1"># 客户端在注册时使用自己的 IP，而不是主机名</span>
<span class="tok-w">                                    </span><span class="tok-c1"># 这是生产环境的最佳实践。避免主机名解析问题</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_7">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h4>
<div class="sect4">
<h5 id="_class_serviceorderapplication_note下面的三个客户端任选一个即可">class ServiceOrderApplication &#8594; NOTE:下面的三个客户端任选一个即可</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务启动类，Spring Boot 应用程序入口点。</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@SpringBootApplication</span>
<span class="tok-nd">@EnableEurekaClient</span><span class="tok-w">  </span><span class="tok-c1">// new -&gt; 启用 Eureka 客户端功能</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ServiceOrderApplication</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">SpringApplication</span><span class="tok-p">.</span><span class="tok-na">run</span><span class="tok-p">(</span><span class="tok-n">ServiceOrderApplication</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 包含其他代码</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">负载均衡使用拦截器原理：</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>拦截请求URL</p>
</li>
<li>
<p>识别服务名</p>
</li>
<li>
<p>通过服务发现获取实际地址</p>
</li>
<li>
<p>替换URL并发起请求</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_resttemplate">RestTemplate</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 创建 RestTemplate 实例，用于调用其他微服务。</span>
<span class="tok-cm"> * @return RestTemplate</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Bean</span>
<span class="tok-nd">@LoadBalanced</span><span class="tok-w"> </span><span class="tok-c1">// new -&gt; 使用负载均衡</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-nf">restTemplate</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 可以在这里添加拦截器来统一处理URL前缀</span>
<span class="tok-w">    </span><span class="tok-c1">// return new RestTemplate();  // not use OkHttp</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-p">(</span>
<span class="tok-w">           </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OkHttp3ClientHttpRequestFactory</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// use OkHttp</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_okhttpclient_不支持_loadbalanced">OkHttpClient 不支持 @LoadBalanced</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Bean</span>
<span class="tok-c1">// @LoadBalanced  // OkHttpClient 不支持负载均衡，在这儿写该注解没用。</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-w"> </span><span class="tok-nf">okHttpClient</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">connectTimeout</span><span class="tok-p">(</span><span class="tok-mi">30</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">readTimeout</span><span class="tok-p">(</span><span class="tok-mi">30</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_webclient_4">WebClient</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 配置负载均衡的 WebClient.Builder</span>
<span class="tok-nd">@Bean</span>
<span class="tok-nd">@LoadBalanced</span><span class="tok-w"> </span><span class="tok-c1">// new -&gt; 使用负载均衡</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-w"> </span><span class="tok-nf">loadBalancedWebClientBuilder</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-p">.</span><span class="tok-na">builder</span><span class="tok-p">();</span>
<span class="tok-p">}</span>

<span class="tok-c1">// 使用 Builder 创建 WebClient</span>
<span class="tok-nd">@Bean</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-nf">webClient</span><span class="tok-p">(</span><span class="tok-n">WebClient</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-w"> </span><span class="tok-n">builder</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">builder</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">baseUrl</span><span class="tok-p">(</span><span class="tok-s">&quot;http://app-item/item&quot;</span><span class="tok-p">)</span><span class="tok-w">  </span><span class="tok-c1">// 使用 eureka 注册中心调用(去注册中心查找服务 app-item，这种方式必须先开启负载均衡 @LoadBalanced)</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">总结</div>
<div class="paragraph">
<p>WebClient 也需要使用 @LoadBalanced 注解，但需要注解在 WebClient.Builder 上，而不是 WebClient 实例上。
这与 WebClient 的设计有关：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>WebClient 是不可变的（immutable）</p>
</li>
<li>
<p>WebClient.Builder 是可变的，用于构建 WebClient 实例</p>
</li>
<li>
<p>Spring Cloud 需要在 Builder 层面注入负载均衡能力</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>这样设计是为了与 WebClient 的不可变性设计保持一致，同时也提供了更灵活的配置方式。</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_6">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h4>
<div class="sect4">
<h5 id="_import">import</h5>
<div class="paragraph">
<p>package com.tjise.serviceorder.service;</p>
</div>
<div class="paragraph">
<p>import com.fasterxml.jackson.databind.ObjectMapper;
import com.tjise.serviceorder.pojo.Item;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.loadbalancer.LoadBalancerClient;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.reactive.function.client.WebClient;</p>
</div>
<div class="paragraph">
<p>import java.io.IOException;</p>
</div>
</div>
<div class="sect4">
<h5 id="_class_itemservice_2">class ItemService</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 根据商品 ID 查询商品信息：通过 REST 调用商品微服务获取商品详细数据</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemService</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><span class="tok-c1">// 商品服务类</span>
<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-w"> </span><span class="tok-n">okHttpClient</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">ObjectMapper</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// 可支持 json 序列化</span>

<span class="tok-w">    </span><span class="tok-c1">// 单个构造方法注入</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ItemService</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-nd">@Autowired</span><span class="tok-p">(</span><span class="tok-n">required</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">OkHttpClient</span><span class="tok-w"> </span><span class="tok-n">okHttpClient</span><span class="tok-p">,</span>
<span class="tok-w">            </span><span class="tok-nd">@Autowired</span><span class="tok-p">(</span><span class="tok-n">required</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">ObjectMapper</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">webClient</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">okHttpClient</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">okHttpClient</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">objectMapper</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 包含其他代码</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_方式一_resttemplate_queryitembyid">方式一: RestTemplate &#8594; queryItemById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">.</span><span class="tok-na">getForObject</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-s">&quot;http://app-item/item/&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>app-item 是 service-item 在 Eureka 中注册的服务名。</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_方式二_okhttpclient_queryitembyidwithokhttpclient_okhttpclient_本身不支持服务发现功能需要自己实现">方式二: OkHttpClient &#8594; queryItemByIdWithOkHttpClient &#8594; OkHttpClient 本身不支持服务发现功能，需要自己实现</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">LoadBalancerClient</span><span class="tok-w"> </span><span class="tok-n">loadBalancerClient</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithOkHttpClient</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 使用 LoadBalancerClient 获取负载均衡的实例</span>
<span class="tok-w">    </span><span class="tok-n">ServiceInstance</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">loadBalancerClient</span><span class="tok-p">.</span><span class="tok-na">choose</span><span class="tok-p">(</span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">actualUrl</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;http://&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">.</span><span class="tok-na">getHost</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;:&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">.</span><span class="tok-na">getPort</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;/item/&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">Request</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Request</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-p">().</span><span class="tok-na">url</span><span class="tok-p">(</span><span class="tok-n">actualUrl</span><span class="tok-p">).</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Response</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">okHttpClient</span><span class="tok-p">.</span><span class="tok-na">newCall</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><span class="tok-c1">// 执行 OkHttpClient 调用</span>
<span class="tok-w">        </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">json</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">.</span><span class="tok-na">body</span><span class="tok-p">().</span><span class="tok-na">string</span><span class="tok-p">();</span><span class="tok-w">  </span><span class="tok-c1">// 读取响应体</span>
<span class="tok-w">        </span><span class="tok-c1">// 使用注入的 objectMapper 反序列化成 JSON 字符串</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">.</span><span class="tok-na">readValue</span><span class="tok-p">(</span><span class="tok-n">json</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_方式三_webclient_queryitembyidwithwebclient">方式三: WebClient    &#8594; queryItemByIdWithWebClient</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithWebClient</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">uri</span><span class="tok-p">(</span><span class="tok-s">&quot;/{id}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">retrieve</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">bodyToMono</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">block</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h4>
<div class="sect4">
<h5 id="_order_queryorderbyid">Order queryOrderById</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 注入商品服务，用于查询商品详细信息</span>
<span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>
<span class="tok-cm">/**</span>
<span class="tok-cm"> * 根据订单ID查询订单数据</span>
<span class="tok-cm"> * @param orderId 订单ID</span>
<span class="tok-cm"> * @return Order 订单信息，包含完整的商品详情</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 从模拟数据库中查询订单</span>
<span class="tok-w">    </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 获取订单详情列表</span>
<span class="tok-w">    </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderDetails</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-c1">// 遍历订单详情，通过商品微服务查询商品详细数据</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">OrderDetail</span><span class="tok-w"> </span><span class="tok-n">orderDetail</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 通过商品微服务查询商品详细数据</span>
<span class="tok-w">        </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">());</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-c1">// Item item = itemService.queryItemByIdWithOkHttpClient(orderDetail.getItem().getId());  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-c1">// Item item = itemService.queryItemByIdWithWebClient(orderDetail.getItem().getId());  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">continue</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// 将查询到的商品详细信息设置到订单详情中</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>使用 RestTemplate</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>使用 OkHttpClient</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>使用 WebClient</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_7_5_测试_service_item_被负载均衡分配的结果">7.5 测试 service-item 被负载均衡分配的结果</h3>
<div class="paragraph">
<p>下面代码使用 @Value("${server.port}") 可以获取到运行时的实际端口号，即使是在通过 Edit Configuration 传递 --server.port=8082 或 8083
参数启动多个实例的情况下。这是 Spring Boot 的一个强大功能，它会自动解析运行时的实际配置值。</p>
</div>
<div class="paragraph">
<p>现在已经修改了 ItemController，在每次请求时会打印当前处理请求的端口号。以下是简单的负载均衡测试方法：</p>
</div>
<div class="paragraph">
<p>负载均衡测试步骤：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>确认所有服务都已启动：</p>
<div class="ulist">
<ul>
<li>
<p>Eureka Server (端口 8761)</p>
</li>
<li>
<p>3 个 service-item 实例 (端口 8081, 8082, 8083)</p>
</li>
<li>
<p>service-order (端口 8091)</p>
</li>
</ul>
</div>
</li>
<li>
<p>在 3 个 service-item 实例的控制台分别观察日志输出。</p>
</li>
<li>
<p>通过 service-order 发起请求：</p>
<div class="literalblock">
<div class="content">
<pre># 重复执行以下命令，观察哪个实例在处理请求
http :8091/order/201810300001</pre>
</div>
</div>
</li>
<li>
<p>每次执行上述命令时，观察 3 个 service-item 实例的控制台，应该会看到类似下面的日志，显示哪个端口在处理请求：</p>
<div class="literalblock">
<div class="content">
<pre>Processing request on port: 8081 for item ID: 1
Processing request on port: 8083 for item ID: 2
Processing request on port: 8082 for item ID: 1</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>这样就能清楚地看到负载均衡在工作，请求被分发到不同的 service-item 实例上。</p>
</div>
<div class="sect3">
<h4 id="_7_5_1_只在_service_item_的不同实例中打印端口调用信息">7.5.1 只在 service-item 的不同实例中打印端口调用信息</h4>
<div class="sect4">
<h5 id="_file_service_itemsrcmainjavacomtjiseserviceitemcontrolleritemcontroller_java_2">file &#8594; service-item/src/main/java/com/tjise/serviceitem/controller/ItemController.java</h5>
<div class="paragraph">
<p>package com.tjise.serviceitem.controller;</p>
</div>
<div class="paragraph">
<p>import com.tjise.serviceitem.pojo.Item;
import com.tjise.serviceitem.service.ItemService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;</p>
</div>
<div class="paragraph">
<p>import java.util.logging.Logger;</p>
</div>
<div class="paragraph">
<p>@RestController
public class ItemController {</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@Autowired
private ItemService itemService;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@Value("${server.port}")
private int serverPort;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>private static final Logger logger = Logger.getLogger(ItemController.class.getName());</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    /**
     * 对外提供接口服务，查询商品信息
     *
     * @param id
     * @return
     */
    @GetMapping(value = "item/{id}")
    public Item queryItemById(@PathVariable("id") Long id) {
        // 增加了日志打印功能，方便查看是哪个 service-item 提供的服务。
        logger.info("Handling request on port: " + serverPort + " for item ID: " + id);
        System.out.println("Processing request on port: " + serverPort + " for item ID: " + id);
        return this.itemService.queryItemById(id);
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_7_5_2_在_service_order_中集中打印负载均衡端口调用信息">7.5.2 在 service-order 中集中打印负载均衡端口调用信息</h4>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceitemservice_java_7">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ItemService.java</h5>
<div class="sect5">
<h6 id="_import_2">import</h6>
<div class="paragraph">
<p>package com.tjise.serviceorder.service;</p>
</div>
<div class="paragraph">
<p>import com.fasterxml.jackson.databind.ObjectMapper;
import com.tjise.serviceorder.pojo.Item;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.loadbalancer.LoadBalancerClient;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.reactive.function.client.WebClient;</p>
</div>
<div class="paragraph">
<p>import java.io.IOException;</p>
</div>
</div>
<div class="sect5">
<h6 id="_class_itemservice_3">class ItemService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 根据商品 ID 查询商品信息：通过 REST 调用商品微服务获取商品详细数据</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemService</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><span class="tok-c1">// 商品服务类</span>
<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-c1">// 包含其他代码</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_方式一_resttemplate_queryitembyid_2">方式一: RestTemplate &#8594; queryItemById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// 获取实际被选择的实例</span>
<span class="tok-w">    </span><span class="tok-n">ServiceInstance</span><span class="tok-w"> </span><span class="tok-n">serviceInstance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">loadBalancerClient</span><span class="tok-p">.</span><span class="tok-na">choose</span><span class="tok-p">(</span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">serviceInstance</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// String targetUrl = serviceInstance.getUri().toString() + &quot;/item/&quot; + id;</span>
<span class="tok-w">        </span><span class="tok-c1">// logger.info(&quot;Load Balancer: Requesting instance at &quot; +</span>
<span class="tok-w">                </span><span class="tok-c1">// serviceInstance.getHost() + &quot;:&quot; + serviceInstance.getPort() +</span>
<span class="tok-w">                </span><span class="tok-c1">// &quot; for item ID: &quot; + id);</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;负载均衡选择了端口: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">serviceInstance</span><span class="tok-p">.</span><span class="tok-na">getPort</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-c1">// restTemplate 会自动应用负载均衡，上面的实例选取只是为了能演示出负载均衡的策略。</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">.</span><span class="tok-na">getForObject</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-s">&quot;http://app-item/item/&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">    </span><span class="tok-c1">// logger.info(&quot;Load Balancer: Got response fro item ID: &quot; + id +</span>
<span class="tok-w">                </span><span class="tok-c1">// &quot;, result: &quot; + (item != null ? &quot;SUCCESS&quot; : &quot;FAILED&quot;));</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>app-item 是 service-item 在 Eureka 中注册的服务名。</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_方式二_okhttpclient_queryitembyidwithokhttpclient_okhttpclient_本身不支持服务发现功能需要自己实现_2">方式二: OkHttpClient &#8594; queryItemByIdWithOkHttpClient &#8594; OkHttpClient 本身不支持服务发现功能，需要自己实现</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">LoadBalancerClient</span><span class="tok-w"> </span><span class="tok-n">loadBalancerClient</span><span class="tok-p">;</span>

<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithOkHttpClient</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 使用 LoadBalancerClient 获取负载均衡的实例</span>
<span class="tok-w">    </span><span class="tok-n">ServiceInstance</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">loadBalancerClient</span><span class="tok-p">.</span><span class="tok-na">choose</span><span class="tok-p">(</span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">actualUrl</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;http://&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">.</span><span class="tok-na">getHost</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;:&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">.</span><span class="tok-na">getPort</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;/item/&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">Request</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Request</span><span class="tok-p">.</span><span class="tok-na">Builder</span><span class="tok-p">().</span><span class="tok-na">url</span><span class="tok-p">(</span><span class="tok-n">actualUrl</span><span class="tok-p">).</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Response</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">okHttpClient</span><span class="tok-p">.</span><span class="tok-na">newCall</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">).</span><span class="tok-na">execute</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><span class="tok-c1">// 执行 OkHttpClient 调用</span>
<span class="tok-w">        </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">json</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">.</span><span class="tok-na">body</span><span class="tok-p">().</span><span class="tok-na">string</span><span class="tok-p">();</span><span class="tok-w">  </span><span class="tok-c1">// 读取响应体</span>
<span class="tok-w">        </span><span class="tok-c1">// 使用注入的 objectMapper 反序列化成 JSON 字符串</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">objectMapper</span><span class="tok-p">.</span><span class="tok-na">readValue</span><span class="tok-p">(</span><span class="tok-n">json</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_方式三_webclient_queryitembyidwithwebclient_2">方式三: WebClient    &#8594; queryItemByIdWithWebClient</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithWebClient</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">uri</span><span class="tok-p">(</span><span class="tok-s">&quot;/{id}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">retrieve</span><span class="tok-p">()</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">bodyToMono</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">block</span><span class="tok-p">();</span><span class="tok-w">  </span><span class="tok-c1">// 在同步方法中使用 block</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_7_6_eureka_添加用户认证">7.6 Eureka 添加用户认证</h3>
<div class="paragraph">
<p>在前面的示例中，我们可以看到不需要登录即可访问到 Eureka 服务，这样其实是不安全的。
所以需要为 Eureka 添加用户认证功能。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/eureka_login.png" alt="eureka login" width="800">
</div>
<div class="title">Figure 4. 加入用户认证功能后需要登录界面</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/eureka_admin_with_user_and_pass.png" alt="eureka admin with user and pass">
</div>
<div class="title">Figure 5. 加入用户认证功能后依然可以注册成功</div>
</div>
<div class="sect3">
<h4 id="_file_eurekapom_xml_2">file &#8594; eureka/pom.xml</h4>
<div class="sect4">
<h5 id="_security_安全认证依赖">security 安全认证依赖</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.boot</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-boot-starter-security</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_eurekasrcmainresourcesapplication_yml_2">file &#8594; eureka/src/main/resources/application.yml</h4>
<div class="sect4">
<h5 id="_server">server</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8761</span><span class="tok-w">  </span><span class="tok-c1"># 1. Eureka Server端口设置为8761（默认端口）</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_spring_new_added">spring &#8594; new added</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-eureka-center</span>
<span class="tok-w">  </span><span class="tok-nt">security</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">basic</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">enable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 开启基于 HTTP basic 的认证</span>
<span class="tok-w">    </span><span class="tok-nt">user</span><span class="tok-p">:</span><span class="tok-w">  </span><span class="tok-c1"># 配置用户的账号信息</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
<span class="tok-w">      </span><span class="tok-nt">password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eureka_new_changed">eureka &#8594; new changed</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">hostname</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">localhost</span><span class="tok-w">  </span><span class="tok-c1"># 2. 设置主机名为localhost</span>
<span class="tok-w">  </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span><span class="tok-w">  </span><span class="tok-c1"># 3. Eureka Server不向自己注册</span>
<span class="tok-w">    </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span><span class="tok-w">        </span><span class="tok-c1"># 4. Eureka 自己不需要获取服务注册信息</span>
<span class="tok-w">    </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-c1"># 5. 设置 Eureka Server 的访问地址</span>
<span class="tok-w">      </span><span class="tok-c1"># defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/</span>
<span class="tok-w">      </span><span class="tok-c1"># 改成需要账号和密码的形式</span>
<span class="tok-w">      </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://${spring.security.user.name}:${spring.security.user.password}@${eureka.instance.hostname}:${server.port}/eureka/</span>
<span class="tok-w">  </span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">enable-self-preservation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 6. 关闭自我保护机制（开发环境建议关闭）</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_eurekasrcmainjavacomtjiseeurekaconfwebsecurityconfig_java">file &#8594; eureka/src/main/java/com/tjise/eureka/conf/WebSecurityConfig.java</h4>
<div class="sect4">
<h5 id="_websecurityconfig_新建安全配置类">WebSecurityConfig 新建安全配置类</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Configuration</span>
<span class="tok-nd">@EnableWebSecurity</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">WebSecurityConfig</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Bean</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">SecurityFilterChain</span><span class="tok-w"> </span><span class="tok-nf">filterChain</span><span class="tok-p">(</span><span class="tok-n">HttpSecurity</span><span class="tok-w"> </span><span class="tok-n">http</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">http</span><span class="tok-p">.</span><span class="tok-na">sessionManagement</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">sessionCreationPolicy</span><span class="tok-p">(</span><span class="tok-n">SessionCreationPolicy</span><span class="tok-p">.</span><span class="tok-na">NEVER</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">and</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">csrf</span><span class="tok-p">().</span><span class="tok-na">disable</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">authorizeHttpRequests</span><span class="tok-p">(</span><span class="tok-n">authz</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">authz</span>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">anyRequest</span><span class="tok-p">().</span><span class="tok-na">authenticated</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">httpBasic</span><span class="tok-p">(</span><span class="tok-n">Customizer</span><span class="tok-p">.</span><span class="tok-na">withDefaults</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">http</span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_itemsrcmainresourcesapplication_yml_3">file &#8594; service-item/src/main/resources/application.yml</h4>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>name 和 instance 两者都有重要作用，缺一不可：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring.application.name：服务的逻辑名称，用于服务发现和负载均衡</p>
</li>
<li>
<p>eureka.instance 配置：实例的网络地址，用于实际通信</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>即使使用 IP 注册，仍然需要服务名称来进行服务发现和调用。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_port_2">port</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1">### 服务端口号(本身是一个web项目)</span>
<span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8081</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_name_2">name</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1">### 起个名字作为服务名称(该服务注册到eureka注册中心的名称，比如商品服务)</span>
<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-item</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eureka_2">eureka</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1">### 服务注册到eureka注册中心的地址</span>
<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-c1"># defaultZone: http://127.0.0.1:8761/eureka/</span>
<span class="tok-w">            </span><span class="tok-c1"># 更改：加入用户名和密码</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@127.0.0.1:8761/eureka/</span>

<span class="tok-w">        </span><span class="tok-c1">### 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-c1">### 是否需要从 eureka 上检索服务</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 使用IP地址注册而不是主机名</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span><span class="tok-w">    </span><span class="tok-c1"># 客户端在注册时使用自己的IP，而不是主机名。</span>
<span class="tok-w">                                 </span><span class="tok-c1"># 这是生产环境的最佳实践，避免主机名解析问题。</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainresourcesapplication_yml_4">file &#8594; service-order/src/main/resources/application.yml</h4>
<div class="sect4">
<h5 id="_port_3">port</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8082</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_name_3">name</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eureka_3">eureka</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 服务注册到 eureka 注册中心的地址</span>
<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-c1"># defaultZone: http://127.0.0.1:8761/eureka/</span>
<span class="tok-w">            </span><span class="tok-c1"># 更改：加入用户名和密码</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@127.0.0.1:8761/eureka/</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">        </span><span class="tok-c1"># 是否需要从 eureka 上检索服务</span>
<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">     </span><span class="tok-c1"># 使用 IP地址 注册而不是主机名</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span><span class="tok-w">       </span><span class="tok-c1"># 客户端在注册时使用自己的 IP，而不是主机名</span>
<span class="tok-w">                                    </span><span class="tok-c1"># 这是生产环境的最佳实践。避免主机名解析问题</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_7_7_eureka_集群高可用性">7.7 Eureka 集群（高可用性）</h3>
<div class="paragraph">
<p>前面的测试发现，Eureka 服务是一个单点服务，在生产环境就会出现单点故障，为了确保 Eureka 服务的高可用，需要搭建 Eureka 服务的集群。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>sudo vim /etc/hosts 增加 3 个主机名</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-m">127</span>.0.0.1<span class="tok-w"> </span>eureka1
<span class="tok-m">127</span>.0.0.1<span class="tok-w"> </span>eureka2
<span class="tok-m">127</span>.0.0.1<span class="tok-w"> </span>eureka3</code></pre>
</div>
</div>
</li>
<li>
<p>在 eureka 中创建 3 个配置文件: application-peer[1,2,3].yml</p>
<div class="ulist">
<ul>
<li>
<p>defaultZone 配置多个地址在 Eureka 集群中的作用：</p>
<div class="ulist">
<ul>
<li>
<p>相互注册: 每个 Eureka Server 实例都需要知道集群中其他实例的地址，以便它们能够互相注册和同步服务注册信息。</p>
<div class="ulist">
<ul>
<li>
<p>application-peer1.yml 中的这个配置告诉 eureka1 实例，它需要向 eureka2 和 eureka3 进行注册，并从它们那里获取服务注册信息。</p>
</li>
<li>
<p>同理，application-peer2.yml 会配置 eureka1 和 eureka3 的地址，application-peer3.yml 会配置 eureka1 和 eureka2 的地址。</p>
</li>
</ul>
</div>
</li>
<li>
<p>高可用性: 通过相互注册，整个 Eureka 集群形成了一个去中心化的结构。即使其中一个 Eureka Server 实例宕机，其他实例仍然可以提供服务注册与发现功能，保证了服务的持续可用性。</p>
</li>
<li>
<p>信息同步: Eureka Server 实例之间会定期同步服务注册信息，确保所有实例上的服务列表保持一致。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>按下图在开发机器上配置 3 个 Eureka 服务的集群。</p>
<div class="imageblock">
<div class="content">
<img src="img/eureka_multi.png" alt="eureka multi">
</div>
</div>
</li>
<li>
<p>访问三个 eureka 管理端网址，查看注册情况。</p>
<div class="paragraph">
<p><a href="http://localhost:8761/" class="bare">http://localhost:8761/</a> | <a href="http://localhost:8762/" class="bare">http://localhost:8762/</a> | <a href="http://localhost:8763/" class="bare">http://localhost:8763/</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/eureka_multi_admin.png" alt="eureka multi admin">
</div>
<div class="title">Figure 6. 三个网址内容类似</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
用户名: root 密码: root
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>为了实现高可用性，service-item 和 service-order 应该像 Eureka Server 之间相互注册那样，将所有 Eureka Server 的地址都配置上。这样做可以确保即使其中一个 Eureka Server 实例宕机，服务仍然能够成功注册和发现其他服务，从而提高整个系统的可用性。</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_配置_eureka">配置 Eureka</h4>
<div class="sect4">
<h5 id="_file_eurekasrcmainresourcesapplication_peer2_yml">file &#8594; eureka/src/main/resources/application-peer2.yml</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8762</span>

<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">eureka-server-clustered</span>
<span class="tok-w">  </span><span class="tok-nt">security</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">basic</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">enable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">user</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
<span class="tok-w">      </span><span class="tok-nt">password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>

<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">hostname</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">eureka2</span>
<span class="tok-w">  </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka1:8761/eureka/,http://root:root@eureka3:8763/eureka/</span>
<span class="tok-w">  </span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">enable-self-preservation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">    </span><span class="tok-c1"># Eureka Server 的核心配置参数，用于控制服务失效实例的清理频率 10s。</span>
<span class="tok-w">    </span><span class="tok-nt">eviction-interval-timer-in-ms</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10000</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_eurekasrcmainresourcesapplication_peer1_yml">file &#8594; eureka/src/main/resources/application-peer1.yml</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8761</span>

<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">eureka-server-clustered</span>
<span class="tok-w">  </span><span class="tok-nt">security</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">basic</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">enable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">user</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
<span class="tok-w">      </span><span class="tok-nt">password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>

<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">hostname</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">eureka1</span>
<span class="tok-w">  </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/</span>
<span class="tok-w">  </span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">enable-self-preservation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">    </span><span class="tok-c1"># Eureka Server 的核心配置参数，用于控制服务失效实例的清理频率 10s。</span>
<span class="tok-w">    </span><span class="tok-nt">eviction-interval-timer-in-ms</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10000</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_eurekasrcmainresourcesapplication_peer3_yml">file &#8594; eureka/src/main/resources/application-peer3.yml</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8763</span>

<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">eureka-server-clustered</span>
<span class="tok-w">  </span><span class="tok-nt">security</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">basic</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">enable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">user</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>
<span class="tok-w">      </span><span class="tok-nt">password</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">root</span>

<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">hostname</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">eureka3</span>
<span class="tok-w">  </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/</span>
<span class="tok-w">  </span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">enable-self-preservation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">    </span><span class="tok-c1"># Eureka Server 的核心配置参数，用于控制服务失效实例的清理频率 10s。</span>
<span class="tok-w">    </span><span class="tok-nt">eviction-interval-timer-in-ms</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10000</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_反例_创建_nginx_容器实现访问_eureka_3_台服务器集群的负载均衡会引入_nginx_单点故障问题">反例: 创建 nginx 容器实现访问 Eureka 3 台服务器集群的负载均衡（会引入 nginx 单点故障问题）</h5>
<div class="listingblock">
<div class="title">创建 nginx 容器</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">docker run -d --name nginx \</span>
<span class="tok-go">-p 80:80 \</span>
<span class="tok-go">-p 8760:8760 \</span>
<span class="tok-go">-v ./eureka.conf:/etc/nginx/conf.d/eureka.conf \</span>
<span class="tok-go">nginx</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
使用命令行可以同时映射多个端口。docker desktop GUI 客户端无法映射多个端口。
</td>
</tr>
</table>
</div>
<hr>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
nginx 出现单点故障，则整个 Eureka 集群无法访问。所以这种方式用的很少。
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">好好理解一下</div>
<div class="ulist">
<ul>
<li>
<p><strong>Eureka 自己带了客户端负载均衡思想</strong></p>
</li>
<li>
<p>客户端直接配置多台 <code>Eureka Server</code>，会自动轮询、重试。</p>
</li>
<li>
<p>集群节点之间数据同步，不需要额外中间层。</p>
</li>
<li>
<p><strong>Nginx 放在这里反而引入了单点</strong></p>
</li>
<li>
<p>Eureka 是 peer-to-peer 对等架构，本来就没有“主从”问题。</p>
</li>
<li>
<p>加个 Nginx 只会让本来不需要的层变成潜在风险点。</p>
</li>
<li>
<p><strong>现在更清楚 Nginx 的定位</strong></p>
</li>
<li>
<p>它更适合放在 <strong>网关层</strong>（对外入口），做统一访问、鉴权、流量控制。</p>
</li>
<li>
<p>不适合放在 <strong>注册中心层</strong>。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_eurekasrcmainresourceseureka_conf">file &#8594; eureka/src/main/resources/eureka.conf</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">upstream</span> <span class="tok-n">eureka</span><span class="tok-o">-</span><span class="tok-n">cluster</span> <span class="tok-p">{</span>
    <span class="tok-n">server</span> <span class="tok-n">host</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">internal</span><span class="tok-p">:</span><span class="tok-mi">8761</span><span class="tok-p">;</span>
    <span class="tok-n">server</span> <span class="tok-n">host</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">internal</span><span class="tok-p">:</span><span class="tok-mi">8762</span><span class="tok-p">;</span>
    <span class="tok-n">server</span> <span class="tok-n">host</span><span class="tok-o">.</span><span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-n">internal</span><span class="tok-p">:</span><span class="tok-mi">8763</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-n">server</span> <span class="tok-p">{</span>
    <span class="tok-n">listen</span> <span class="tok-mi">8760</span><span class="tok-p">;</span>
    <span class="tok-n">location</span> <span class="tok-o">/</span> <span class="tok-p">{</span>
        <span class="tok-n">proxy_pass</span> <span class="tok-n">http</span><span class="tok-p">:</span><span class="tok-o">//</span><span class="tok-n">eureka</span><span class="tok-o">-</span><span class="tok-n">cluster</span><span class="tok-p">;</span>
        <span class="tok-n">proxy_set_header</span> <span class="tok-n">Host</span> <span class="tok-err">$</span><span class="tok-n">host</span><span class="tok-p">;</span>
        <span class="tok-n">proxy_set_header</span> <span class="tok-n">X</span><span class="tok-o">-</span><span class="tok-n">Real</span><span class="tok-o">-</span><span class="tok-n">IP</span> <span class="tok-err">$</span><span class="tok-n">remote_addr</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要让容器里的 Nginx 把请求转发到“宿主机上的 Eureka”，就得用宿主机在 Docker 网络中的地址。<br>
Docker 已经预留了一个特殊 DNS 名：host.docker.internal<br>
它自动解析成宿主机在 Docker 网桥里的 IP。</p>
</div>
<div class="paragraph">
<p>访问 <a href="http://localhost:8760/" class="bare">http://localhost:8760/</a> 会按 nginx 默认的负载均衡访问 3 台 Eureka 服务器。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置_微服务2个">配置 微服务(2个)</h4>
<div class="sect4">
<h5 id="_file_service_itemsrcmainresourcesapplication_yml_4">file &#8594; service-item/src/main/resources/application.yml</h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>name 和 instance 两者都有重要作用，缺一不可：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring.application.name：服务的逻辑名称，用于服务发现和负载均衡</p>
</li>
<li>
<p>eureka.instance 配置：实例的网络地址，用于实际通信</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>即使使用 IP 注册，仍然需要服务名称来进行服务发现和调用。</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_port_4">port</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1">### 服务端口号(本身是一个web项目)</span>
<span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8081</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_name_4">name</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1">### 起个名字作为服务名称(该服务注册到eureka注册中心的名称，比如商品服务)</span>
<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-item</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_eureka_4">eureka</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1">### 服务注册到 eureka 注册中心的地址</span>
<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-c1"># defaultZone: http://root:root@127.0.0.1:8761/eureka/</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w"> </span><span class="tok-c1"># 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">       </span><span class="tok-c1"># 是否需要从 eureka 上检索服务</span>

<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">    </span><span class="tok-c1"># 使用IP地址注册而不是主机名</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span><span class="tok-w">      </span><span class="tok-c1"># 客户端在注册时使用自己的IP，而不是主机名。</span>
<span class="tok-w">                                   </span><span class="tok-c1"># 这是生产环境的最佳实践，避免主机名解析问题。</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainresourcesapplication_yml_5">file &#8594; service-order/src/main/resources/application.yml</h5>
<div class="sect5">
<h6 id="_port_5">port</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8091</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_name_5">name</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_eureka_5">eureka</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 服务注册到 eureka 注册中心的地址</span>
<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-c1"># defaultZone: http://root:root@127.0.0.1:8761/eureka/</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">        </span><span class="tok-c1"># 是否需要从 eureka 上检索服务</span>
<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">     </span><span class="tok-c1"># 使用 IP地址 注册而不是主机名</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span><span class="tok-w">       </span><span class="tok-c1"># 客户端在注册时使用自己的 IP，而不是主机名</span>
<span class="tok-w">                                    </span><span class="tok-c1"># 这是生产环境的最佳实践。避免主机名解析问题</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_测试高可用性">测试高可用性</h4>
<div class="sect4">
<h5 id="_httpie_测试">httpie 测试</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">http :8091/order/201810300001</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>HTTP/1.1 200
Connection: keep-alive
Content-Type: application/json
Date: Mon, 22 Sep 2025 16:32:37 GMT
Keep-Alive: timeout=60
Transfer-Encoding: chunked

{
    "createDate": "2025-09-22T16:30:20.174+00:00",
    "orderDetails": [
        {
            "item": {
                "desc": "商品描述1",
                "id": 1,
                "pic": "http://图片1",
                "price": 1000,
                "title": "商品1"
            },
            "orderId": "201810300001"
        },
        {
            "item": {
                "desc": "商品描述2",
                "id": 2,
                "pic": "http://图片2",
                "price": 2000,
                "title": "商品2"
            },
            "orderId": "201810300001"
        }
    ],
    "orderId": "201810300001",
    "updateDate": "2025-09-22T16:30:20.174+00:00",
    "userId": 1
}</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_停止一个_eureka_服务再测试">停止一个 eureka 服务再测试</h5>
<div class="paragraph">
<p>停掉端口为 8761 的 eureka 服务，再测试应该还是能正常访问的。</p>
</div>
</div>
<div class="sect4">
<h5 id="_创建新订单再测试">创建新订单再测试</h5>
<div class="paragraph">
<p>为了防止是缓存的效果，再创建一个订单 order2，如下。</p>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_3">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h6>

</div>
<div class="sect5">
<h6 id="_class_orderservice_2">class OrderService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务类</span>
<span class="tok-cm"> * 提供订单查询功能，并通过调用商品服务获取商品详细信息</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderService</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_order_data_模拟数据_2">ORDER_DATA 模拟数据</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 使用静态Map模拟数据库存储订单数据</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">Map</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">HashMap</span><span class="tok-o">&lt;</span><span class="tok-n">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>
<span class="tok-c1">// 初始化订单数据</span>
<span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 模拟数据库，构造测试数据</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_第一个订单_order">第一个订单 order</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-p">();</span>
<span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">setOrderId</span><span class="tok-p">(</span><span class="tok-s">&quot;201810300001&quot;</span><span class="tok-p">);</span>
<span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">setCreateDate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-p">());</span>
<span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">setUpdateDate</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getCreateDate</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// 真会偷懒呀</span>
<span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">setUserId</span><span class="tok-p">(</span><span class="tok-mi">1L</span><span class="tok-p">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>

<span class="tok-c1">// 创建第一个商品详情（仅保存商品ID，需要调用商品微服务获取详细信息）</span>
<span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">1L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">));</span>

<span class="tok-c1">// 创建第二个商品详情</span>
<span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">2L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">));</span>

<span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">setOrderDetails</span><span class="tok-p">(</span><span class="tok-n">orderDetails</span><span class="tok-p">);</span>

<span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_第二个订单_order2">第二个订单 order2</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-p">();</span>
<span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">setOrderId</span><span class="tok-p">(</span><span class="tok-s">&quot;201810300002&quot;</span><span class="tok-p">);</span>
<span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">setCreateDate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-p">());</span>
<span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">setUpdateDate</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getCreateDate</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// 真会偷懒呀</span>
<span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">setUserId</span><span class="tok-p">(</span><span class="tok-mi">2L</span><span class="tok-p">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>

<span class="tok-c1">// 创建第一个商品详情（仅保存商品ID，需要调用商品微服务获取详细信息）</span>
<span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item2</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">3L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails2</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item2</span><span class="tok-p">));</span>

<span class="tok-c1">// 创建第二个商品详情</span>
<span class="tok-n">item2</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item2</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">4L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails2</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item2</span><span class="tok-p">));</span>

<span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">setOrderDetails</span><span class="tok-p">(</span><span class="tok-n">orderDetails2</span><span class="tok-p">);</span>

<span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">order2</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">order2</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_queryorderbyid_2">queryOrderById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 注入商品服务，用于查询商品详细信息</span>
<span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>
<span class="tok-cm">/**</span>
<span class="tok-cm"> * 根据订单ID查询订单数据</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param orderId 订单ID</span>
<span class="tok-cm"> * @return Order 订单信息，包含完整的商品详情</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 从模拟数据库中查询订单</span>
<span class="tok-w">    </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 获取订单详情列表</span>
<span class="tok-w">    </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderDetails</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-c1">// 遍历订单详情，通过商品微服务查询商品详细数据</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">OrderDetail</span><span class="tok-w"> </span><span class="tok-n">orderDetail</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 通过商品微服务查询商品详细数据</span>
<span class="tok-w">        </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-k">continue</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-c1">// 将查询到的商品详细信息设置到订单详情中</span>
<span class="tok-w">        </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_重启_service_order_后httpie_测试">重启 service-order 后，httpie 测试:</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">http :8091/order/201810300002</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="title">测试结果说明 Eureka 高可用无问题</div>
<div class="content">
<pre>HTTP/1.1 200
Connection: keep-alive
Content-Type: application/json
Date: Mon, 22 Sep 2025 16:31:11 GMT
Keep-Alive: timeout=60
Transfer-Encoding: chunked

{
    "createDate": "2025-09-22T16:30:20.175+00:00",
    "orderDetails": [
        {
            "item": {
                "desc": "商品描述3",
                "id": 3,
                "pic": "http://图片3",
                "price": 3000,
                "title": "商品3"
            },
            "orderId": "201810300002"
        },
        {
            "item": {
                "desc": "商品描述4",
                "id": 4,
                "pic": "http://图片4",
                "price": 4000,
                "title": "商品4"
            },
            "orderId": "201810300002"
        }
    ],
    "orderId": "201810300002",
    "updateDate": "2025-09-22T16:30:20.174+00:00",
    "userId": 2
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_8_容错保护resilience4j">8. 容错保护：Resilience4j</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_雪崩效应">雪崩效应</h3>
<div class="paragraph">
<p>在微服务架构中通常会有多个服务层调用，基础服务的故障可能会导致级联故障，进而造成整个系统不可用的情况，这种现象被称为服务雪崩效应。</p>
</div>
<div class="paragraph">
<p>服务雪崩效应是一种因“服务提供者”的不可用导致“服务消费者”的不可用，并将不可用逐渐放大的过程。</p>
</div>
<div class="paragraph">
<p>如下图所示：A 作为服务提供者，B 为 A 的服务消费者，C 和 D 是 B 的服务消费者。A 不可用引起了 B 的不可用，并将不可用像滚雪球一样放大到 C 和 D 时，雪崩效应就形成了。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/avalanche.png" alt="avalanche" width="600">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resilience4j_快速入门">Resilience4j 快速入门</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
我们是启了负载均衡的，所以不能使用注解的方式来使用 queryItemByIdFallback，会被负载均衡给拦截掉。
只能使用手动通过 circuitBreakerRegistry 的方式来启用断路器 Resilience4j，这点要注意了。因为通过多次调试发现，Resilience4j 不起作用的原因就在这儿了。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_file_service_orderpom_xml_5">file &#8594; service-order/pom.xml</h4>
<div class="sect4">
<h5 id="_resilience4j_依赖">resilience4j 依赖</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">io</span><span class="tok-nc">.github.resilience4j</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">resilience4j-spring-boot2</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-nt">1</span><span class="tok-nc">.7.0</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainresourcesapplication_yml_6">file &#8594; service-order/src/main/resources/application.yml</h4>
<div class="sect4">
<h5 id="_port_6">port</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">server</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8091</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_name_6">name</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_eureka_6">eureka</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># 服务注册到 eureka 注册中心的地址</span>
<span class="tok-nt">eureka</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">service-url</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-c1"># defaultZone: http://root:root@127.0.0.1:8761/eureka/</span>
<span class="tok-w">            </span><span class="tok-nt">defaultZone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/</span>
<span class="tok-w">        </span><span class="tok-nt">register-with-eureka</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心</span>
<span class="tok-w">        </span><span class="tok-nt">fetch-registry</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">        </span><span class="tok-c1"># 是否需要从 eureka 上检索服务</span>
<span class="tok-w">    </span><span class="tok-nt">instance</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">prefer-ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">     </span><span class="tok-c1"># 使用 IP地址 注册而不是主机名</span>
<span class="tok-w">        </span><span class="tok-nt">ip-address</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">127.0.0.1</span><span class="tok-w">       </span><span class="tok-c1"># 客户端在注册时使用自己的 IP，而不是主机名</span>
<span class="tok-w">                                    </span><span class="tok-c1"># 这是生产环境的最佳实践。避免主机名解析问题</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_resilience4j">resilience4j</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">resilience4j</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">instances</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-c1"># OrderService 这个名称是在代码中创建 CircuitBreaker 实例时指定的标识符，配置中的名称必须与代码中的名称完全一致才能生效。</span>
<span class="tok-w">      </span><span class="tok-nt">OrderService</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">sliding-window-size</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span><span class="tok-w">                  </span><span class="tok-c1"># 需要 5次调用来计算失败率</span>
<span class="tok-w">        </span><span class="tok-nt">failure-rate-threshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span><span class="tok-w">              </span><span class="tok-c1"># 50% 失败率才跳闸</span>
<span class="tok-w">        </span><span class="tok-nt">wait-duration-in-open-state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10s</span><span class="tok-w">        </span><span class="tok-c1"># 10 秒后进入半开状态</span>
<span class="tok-w">        </span><span class="tok-nt">permitted-number-of-calls-in-half-open-state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span><span class="tok-w">     </span><span class="tok-c1"># 半开状态允许 2 次调用</span>
<span class="tok-w">        </span><span class="tok-nt">sliding-window-type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">COUNT_BASED</span><span class="tok-w">        </span><span class="tok-c1"># 基于调用次数</span>
<span class="tok-w">        </span><span class="tok-nt">record-exceptions</span><span class="tok-p">:</span><span class="tok-w">                      </span><span class="tok-c1"># 哪些异常算失败</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">org.springframework.web.reactive.function.client.WebClientResponseException</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">java.lang.RuntimeException</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">java.io.IOException</span>
<span class="tok-w">        </span><span class="tok-nt">ignore-exceptions</span><span class="tok-p">:</span><span class="tok-w">                      </span><span class="tok-c1"># 忽略的异常类型</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">java.lang.IllegalArgumentException</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
实际生产要宽松一些的。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>测试 vs 生产</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">场景</th>
<th class="tableblock halign-left valign-top">测试配置</th>
<th class="tableblock halign-left valign-top">生产配置</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">窗口大小</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 次调用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100次调用</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">故障阈值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">75%</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">恢复时间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 秒</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">目的</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">快速验证</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">稳定运行</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_4">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h4>
<div class="sect4">
<h5 id="_class_orderservice_3">class OrderService</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务类</span>
<span class="tok-cm"> * 提供订单查询功能，并通过调用商品服务获取商品详细信息</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">CircuitBreakerRegistry</span><span class="tok-w"> </span><span class="tok-n">circuitBreakerRegistry</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidwithcircuitbreaker">Item queryItemByIdWithCircuitBreaker</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// name 对应 application.yml 中的配置</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">CircuitBreaker</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">circuitBreakerRegistry</span><span class="tok-p">.</span><span class="tok-na">circuitBreaker</span><span class="tok-p">(</span><span class="tok-s">&quot;OrderService&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器状态: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">getState</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器失败率: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">getMetrics</span><span class="tok-p">().</span><span class="tok-na">getFailureRate</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器调用次数: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">getMetrics</span><span class="tok-p">().</span><span class="tok-na">getNumberOfBufferedCalls</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; ===&quot;</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">executeSupplier</span><span class="tok-p">(()</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">.</span><span class="tok-na">queryItemByIdWithWebClient</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">));</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== WebClient 调用成功 ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器抛出异常: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getClass</span><span class="tok-p">().</span><span class="tok-na">getSimpleName</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; - &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidfallback_断路器降级方法">Item queryItemByIdFallback 断路器降级方法</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 断路器降级方法</span>
<span class="tok-cm"> * @param id 商品 ID</span>
<span class="tok-cm"> * @param throwable 抛出的异常</span>
<span class="tok-cm"> * @return 降级后的默认商品信息</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdFallback</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=======CircuitBreaker 降级处理，原因：&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;查询商品信息出错&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_queryorderbyid_3">queryOrderById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 注入商品服务，用于查询商品详细信息</span>
<span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>
<span class="tok-cm">/**</span>
<span class="tok-cm"> * 根据订单ID查询订单数据</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param orderId 订单ID</span>
<span class="tok-cm"> * @return Order 订单信息，包含完整的商品详情</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 从模拟数据库中查询订单</span>
<span class="tok-w">    </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 获取订单详情列表</span>
<span class="tok-w">    </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderDetails</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-c1">// 遍历订单详情，通过商品微服务查询商品详细数据</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">OrderDetail</span><span class="tok-w"> </span><span class="tok-n">orderDetail</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 通过商品微服务查询商品详细数据</span>
<span class="tok-w">        </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">());</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">continue</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-c1">// 将查询到的商品详细信息设置到订单详情中</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-c1">// 如果断路器抛出异常，使用降级商品</span>
<span class="tok-w">            </span><span class="tok-c1">// 注意：这里不再打印日志，因为 queryItemByIdWithCircuitBreaker 中已经处理了异常</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">fallbackItem</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdFallback</span><span class="tok-p">(</span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">fallbackItem</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_测试_resilience4j">测试 Resilience4j</h4>
<div class="paragraph">
<p>测试步骤：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>启动 Eureka 服务注册中心</p>
</li>
<li>
<p>启动 service-item 服务（也可以不启动）</p>
</li>
<li>
<p>启动 service-order 服务</p>
</li>
<li>
<p>关闭 service-item 服务（这样调用会失败）</p>
</li>
<li>
<p>调用 order 服务的相关接口</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">http :8091/order/201810300001</span></code></pre>
</div>
</div>
</li>
<li>
<p>重复调用几次（超过 failure-rate-threshold 设置的阈值）</p>
</li>
<li>
<p>观察日志输出，应该会看到降级方法被调用</p>
<div class="literalblock">
<div class="title">输出结果如下</div>
<div class="content">
<pre>2025-10-01 17:17:40.308  INFO 4711 --- [nio-8091-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2025-10-01 17:17:40.309  INFO 4711 --- [nio-8091-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms
=== 断路器状态: CLOSED ===
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 0 ===
2025-10-01 17:17:40.437  WARN 4711 --- [nio-8091-exec-1] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:17:40.438  WARN 4711 --- [nio-8091-exec-1] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: CLOSED ===
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 1 ===
2025-10-01 17:17:40.478  WARN 4711 --- [nio-8091-exec-1] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:17:40.478  WARN 4711 --- [nio-8091-exec-1] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: CLOSED ===
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 2 ===
2025-10-01 17:18:04.135  WARN 4711 --- [nio-8091-exec-3] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:18:04.135  WARN 4711 --- [nio-8091-exec-3] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: CLOSED ===
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 3 ===
2025-10-01 17:18:04.136  WARN 4711 --- [nio-8091-exec-3] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:18:04.136  WARN 4711 --- [nio-8091-exec-3] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: CLOSED ===
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 4 ===
2025-10-01 17:18:10.612  WARN 4711 --- [nio-8091-exec-5] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:18:10.612  WARN 4711 --- [nio-8091-exec-5] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: OPEN ===  --&gt; 断路器已经是打开状态了
=== 断路器失败率: 100.0 ===
=== 断路器调用次数: 5 ===  --&gt; 第 5 次才开始计算的
=== 断路器抛出异常: CallNotPermittedException - CircuitBreaker 'OrderService' is OPEN and does not permit further calls ===
=======CircuitBreaker 降级处理，原因：CircuitBreaker 'OrderService' is OPEN and does not permit further calls
--&gt; 不会进行实际的网络调用了，断路器直接返回降级结果
=== 断路器状态: OPEN ===
=== 断路器失败率: 100.0 ===
=== 断路器调用次数: 5 ===
2025-10-01 17:18:37.444  WARN 4711 --- [nio-8091-exec-7] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:18:37.444  WARN 4711 --- [nio-8091-exec-7] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: HALF_OPEN ===  --&gt; 10s 以后断路器就变成半开状态，且允许 2 次实际的网络调用，可以看见负载均衡又起作用了。
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 1 ===
2025-10-01 17:18:37.446  WARN 4711 --- [nio-8091-exec-7] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:18:37.446  WARN 4711 --- [nio-8091-exec-7] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: OPEN ===
=== 断路器失败率: 100.0 ===  --&gt; 2 次调用都失败了，断路器又打开了
=== 断路器调用次数: 2 ===
2025-10-01 17:19:07.312  WARN 4711 --- [nio-8091-exec-9] o.s.c.l.core.RoundRobinLoadBalancer      : No servers available for service: app-item
2025-10-01 17:19:07.312  WARN 4711 --- [nio-8091-exec-9] eactorLoadBalancerExchangeFilterFunction : LoadBalancer does not contain an instance for the service app-item
=== 断路器抛出异常: ServiceUnavailable - 503 Service Unavailable from UNKNOWN  ===
=======CircuitBreaker 降级处理，原因：503 Service Unavailable from UNKNOWN
=== 断路器状态: HALF_OPEN ===  --&gt; 10s 以后又变成了半开状态，如此反复吧......
=== 断路器失败率: -1.0 ===
=== 断路器调用次数: 1 ===</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>这个日志完美展示了：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>✅ 断路器状态管理：CLOSED → OPEN → HALF_OPEN</p>
</li>
<li>
<p>✅ 阈值触发机制： 失败率达到50%时跳闸</p>
</li>
<li>
<p>✅ 自动恢复尝试： 定期试探服务可用性</p>
</li>
<li>
<p>✅ 性能优化：OPEN状态时避免无效调用</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>断路器完全按照设计工作，在系统层面提供了有效的故障保护和自动恢复机制！</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_9_feign_客户端声明式_rest_调用">9. Feign 客户端（声明式 REST 调用）</h2>
<div class="sectionbody">
<div class="paragraph">
<p>虽然使用了 WebClient 或 RestTemplate + @LoadBalanced + Resilience4j 可以实现负载均衡和容错处理，但是这个编码在实现大量业务时会显得太过于冗余（如，多参数的URL拼接）。</p>
</div>
<div class="paragraph">
<p>思考：有没有更加优雅的实现呢？有，那就是 Feign。</p>
</div>
<div class="sect2">
<h3 id="_feign_与其它客户端差异与关系">Feign 与其它客户端差异与关系</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>基本概念差异</p>
<div class="paragraph">
<p>Feign:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>是一个声明式的 Web 服务客户端</p>
</li>
<li>
<p>通过注解驱动，将 HTTP 请求抽象为接口方法</p>
</li>
<li>
<p>本质上是对 HTTP 客户端的高层次封装</p>
</li>
<li>
<p>专注于微服务间的通信</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WebClient/RestTemplate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>是底层的 HTTP 客户端工具</p>
</li>
<li>
<p>RestTemplate 是同步阻塞的</p>
</li>
<li>
<p>WebClient 是响应式异步的</p>
</li>
<li>
<p>提供基础的 HTTP 操作能力</p>
</li>
</ul>
</div>
</li>
<li>
<p>关系梳理</p>
<div class="paragraph">
<p>实际上，Feign 与其他工具的关系是：Feign 是一个抽象层，它可以使用不同的底层 HTTP 客户端实现：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>默认使用 HttpURLConnection</p>
</li>
<li>
<p>可以配置使用 Apache HttpClient</p>
</li>
<li>
<p>可以配置使用 OkHttp</p>
</li>
<li>
<p>甚至可以与 WebClient 集成</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>但是，Feign 不能直接使用 RestTemplate 或 WebClient 作为其底层实现，因为它们的设计理念不同。</p>
</div>
</div>
<div class="sect2">
<h3 id="_feign_与其它客户端在微服务架构中的使用场景">Feign 与其它客户端在微服务架构中的使用场景</h3>
<div class="paragraph">
<p>Feign 专为微服务设计:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>与 Eureka、LoadBalancer 无缝集成</p>
</li>
<li>
<p>内置负载均衡支持</p>
</li>
<li>
<p>提供声明式服务调用</p>
</li>
<li>
<p>天然支持熔断器模式</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WebClient/RestTemplate 需要额外配置:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RestTemplate: 需要 @LoadBalanced 注解与服务发现集成</p>
</li>
<li>
<p>WebClient: 需要手动配置与 LoadBalancer 的集成</p>
</li>
<li>
<p>都需要额外配置熔断机制</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_feign_与其它客户端代码示例对比">Feign 与其它客户端代码示例对比</h3>
<div class="sect3">
<h4 id="_项目中使用的_resttemplate_方式">项目中使用的 RestTemplate 方式</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">RestTemplate</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">restTemplate</span><span class="tok-p">.</span><span class="tok-na">getForObject</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-s">&quot;http://app-item/item/&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_项目中使用的_webclient_方式">项目中使用的 WebClient 方式</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-c1">// 单构造器注入</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">ItemService</span><span class="tok-p">(</span><span class="tok-n">WebClient</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">webClient</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithWebClient</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">webClient</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">uri</span><span class="tok-p">(</span><span class="tok-s">&quot;/{id}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">retrieve</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">bodyToMono</span><span class="tok-p">(</span><span class="tok-n">Item</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span><span class="tok-w">  </span><span class="tok-c1">// 类似于 js Promise</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">block</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_项目中使用的_feign_方式">项目中使用的 Feign 方式</h4>
<div class="paragraph">
<p>先展示一下，具体内容参后面详细步骤。注意：这是发送请求哟！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 要访问在 Eureka 中的服务名，并指定实现该接口的降级类名</span>
<span class="tok-nd">@FeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">fallback</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ItemFallback</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">interface</span> <span class="tok-nc">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_各自优势和适用场景总结">各自优势和适用场景总结</h3>
<div class="paragraph">
<p>Feign 优势:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>声明式接口: 代码简洁，像调用本地方法</p>
</li>
<li>
<p>开箱即用: 自动集成负载均衡、熔断器</p>
</li>
<li>
<p>微服务友好的: 与 Spring Cloud 生态无缝集成</p>
</li>
<li>
<p>配置简单: 通过注解和配置文件即可完成大部分配置</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>WebClient/RestTemplate 优势:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>灵活性: 完全控制 HTTP 请求的每个细节</p>
</li>
<li>
<p>通用性: 不仅适用于微服务，也适用于一般 HTTP 客户端场景</p>
</li>
<li>
<p>响应式: WebClient 支持非阻塞异步编程</p>
</li>
<li>
<p>性能: 底层控制，理论上性能更高</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>关系总结:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Feign 是面向微服务的高级抽象层</p>
</li>
<li>
<p>WebClient/RestTemplate 是通用的底层 HTTP 客户端</p>
</li>
<li>
<p>三者解决的问题层次不同</p>
</li>
<li>
<p>Feign 自动处理了很多微服务特有的问题（负载均衡、熔断等）</p>
</li>
<li>
<p>WebClient/RestTemplate 需要手动配置这些微服务特性</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在你的 Spring Cloud 微服务项目中，Feign 提供了更优雅的解决方案，减少了样板代码，让开发者更专注于业务逻辑。</p>
</div>
<div class="paragraph">
<p>总的来说，Feign 与 WebClient/RestTemplate 并不是直接竞争关系，而是解决不同层次问题的工具。Feign 更专注于微服务间的声明式通信，而 WebClient/RestTemplate 是更通用的 HTTP 客户端工具。在微服务架构中，Feign 提供了更高层次的抽象和更好的开发体验。</p>
</div>
</div>
<div class="sect2">
<h3 id="_feign_客户端配合断路器入门">Feign 客户端配合断路器入门</h3>
<div class="sect3">
<h4 id="_1_直接使用断路器_resilience4j_纯手工">1) 直接使用断路器 Resilience4j (纯手工)</h4>
<div class="paragraph">
<p>正常测试</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300001</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>item3 id 为 -1，会抛出异常，查看 8091 打印</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300003</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_file_service_orderpom_xml_6">file &#8594; service-order/pom.xml</h5>
<div class="sect5">
<h6 id="_openfeign">openfeign</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-starter-openfeign</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_8">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h5>
<div class="sect5">
<h6 id="_class_serviceorderapplication_enablefeignclients">class ServiceOrderApplication &#8594; @EnableFeignClients</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务启动类，Spring Boot 应用程序入口点。</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@SpringBootApplication</span>
<span class="tok-nd">@EnableEurekaClient</span><span class="tok-w">  </span><span class="tok-c1">// 启用 Eureka 客户端功能</span>
<span class="tok-nd">@EnableFeignClients</span><span class="tok-w">  </span><span class="tok-c1">// --- New Added --- 会初始化和配置 feign</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ServiceOrderApplication</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">SpringApplication</span><span class="tok-p">.</span><span class="tok-na">run</span><span class="tok-p">(</span><span class="tok-n">ServiceOrderApplication</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 包含其他代码</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">负载均衡使用拦截器原理：</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>拦截请求URL</p>
</li>
<li>
<p>识别服务名</p>
</li>
<li>
<p>通过服务发现获取实际地址</p>
</li>
<li>
<p>替换URL并发起请求</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderclientitemfeignclient_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/client/ItemFeignClient.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.client</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo.Item</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.cloud.openfeign.FeignClient</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.GetMapping</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.PathVariable</span><span class="tok-p">;</span>

<span class="tok-nd">@FeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">)</span><span class="tok-w">  </span><span class="tok-c1">// 要访问的在 Eureka 中的服务名</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">interface</span> <span class="tok-nc">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_5">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h5>
<div class="sect5">
<h6 id="_class_orderservice_4">class OrderService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务类</span>
<span class="tok-cm"> * 提供订单查询功能，并通过调用商品服务获取商品详细信息</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">CircuitBreakerRegistry</span><span class="tok-w"> </span><span class="tok-n">circuitBreakerRegistry</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-n">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// --- New Added ---</span>

<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_第三个订单_order3item5_setid_1l_设为_1_itemcontroller_java_会抛出异常">第三个订单 order3&#8201;&#8212;&#8201;item5.setId(-1L) 设为 -1 ItemController.java 会抛出异常</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-p">();</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setOrderId</span><span class="tok-p">(</span><span class="tok-s">&quot;201810300003&quot;</span><span class="tok-p">);</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setCreateDate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-p">());</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setUpdateDate</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getCreateDate</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// 真会偷懒呀</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setUserId</span><span class="tok-p">(</span><span class="tok-mi">3L</span><span class="tok-p">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>

<span class="tok-c1">// 创建第一个商品详情（仅保存商品ID，需要调用商品微服务获取详细信息）</span>
<span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item3</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-mi">1L</span><span class="tok-p">);</span><span class="tok-w">          </span><span class="tok-c1">// --- 注意这里设置了 -1 哟! ---</span>
<span class="tok-n">orderDetails3</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-p">));</span>

<span class="tok-c1">// 创建第二个商品详情</span>
<span class="tok-n">item3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item3</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">6L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails3</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-p">));</span>

<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setOrderDetails</span><span class="tok-p">(</span><span class="tok-n">orderDetails3</span><span class="tok-p">);</span>

<span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">order3</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidwithcircuitbreaker_2">Item queryItemByIdWithCircuitBreaker</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// name 对应 application.yml 中的配置</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">CircuitBreaker</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">circuitBreakerRegistry</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">circuitBreaker</span><span class="tok-p">(</span><span class="tok-s">&quot;OrderService&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器状态: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">getState</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器失败率: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">getMetrics</span><span class="tok-p">().</span><span class="tok-na">getFailureRate</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器调用次数: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">            </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">getMetrics</span><span class="tok-p">().</span><span class="tok-na">getNumberOfBufferedCalls</span><span class="tok-p">());</span>

<span class="tok-w">    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 这是之前使用 WebClient 的方式</span>
<span class="tok-w">        </span><span class="tok-c1">// Item result = circuitBreaker.executeSupplier(</span>
<span class="tok-w">            </span><span class="tok-c1">// () -&gt; itemService.queryItemByIdWithWebClient(id));</span>

<span class="tok-w">        </span><span class="tok-c1">// 启用断路器</span>
<span class="tok-w">        </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">circuitBreaker</span><span class="tok-p">.</span><span class="tok-na">executeSupplier</span><span class="tok-p">(</span>
<span class="tok-w">            </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w">  </span><span class="tok-c1">// 使用 feign</span>
<span class="tok-w">        </span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;result:&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 断路器抛出异常: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">                </span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getClass</span><span class="tok-p">().</span><span class="tok-na">getSimpleName</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">+</span>
<span class="tok-w">                </span><span class="tok-s">&quot; - &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidfallback_断路器降级方法_2">Item queryItemByIdFallback 断路器降级方法</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 断路器降级方法</span>
<span class="tok-cm"> * @param id 商品 ID</span>
<span class="tok-cm"> * @param throwable 抛出的异常</span>
<span class="tok-cm"> * @return 降级后的默认商品信息</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdFallback</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=======CircuitBreaker 降级处理，原因：&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;查询商品信息出错&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_order_queryorderbyid_2">Order queryOrderById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 注入商品服务，用于查询商品详细信息</span>
<span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>
<span class="tok-cm">/**</span>
<span class="tok-cm"> * 根据订单ID查询订单数据</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param orderId 订单ID</span>
<span class="tok-cm"> * @return Order 订单信息，包含完整的商品详情</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 从模拟数据库中查询订单</span>
<span class="tok-w">    </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 获取订单详情列表</span>
<span class="tok-w">    </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderDetails</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-c1">// 遍历订单详情，通过商品微服务查询商品详细数据</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">OrderDetail</span><span class="tok-w"> </span><span class="tok-n">orderDetail</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 通过商品微服务查询商品详细数据</span>
<span class="tok-w">        </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">continue</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-c1">// 将查询到的商品详细信息设置到订单详情中</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-c1">// 如果断路器抛出异常，使用降级商品</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">fallbackItem</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdFallback</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">e</span>
<span class="tok-w">            </span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">fallbackItem</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_itemsrcmainjavacomtjiseserviceitemcontrolleritemcontroller_java_3">file &#8594; service-item/src/main/java/com/tjise/serviceitem/controller/ItemController.java</h5>
<div class="sect5">
<h6 id="_public_class_itemcontrollernew_added_当_id_为_1_时抛出异常">public class ItemController&#8201;&#8212;&#8201;New Added 当 ID 为 -1 时抛出异常</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@RestController</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemController</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@Value</span><span class="tok-p">(</span><span class="tok-s">&quot;${server.port}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">serverPort</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">Logger</span><span class="tok-w"> </span><span class="tok-n">logger</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Logger</span><span class="tok-p">.</span><span class="tok-na">getLogger</span><span class="tok-p">(</span><span class="tok-n">ItemController</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">.</span><span class="tok-na">getName</span><span class="tok-p">());</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 对外提供接口服务，查询商品信息</span>
<span class="tok-cm">     *</span>
<span class="tok-cm">     * @param id</span>
<span class="tok-cm">     * @return</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 增加了日志打印功能，方便查看是哪个 service-item 提供的服务。</span>
<span class="tok-w">        </span><span class="tok-n">logger</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;Handling request on port: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">serverPort</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; for item ID: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Processing request on port: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">serverPort</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; for item ID: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-c1">// -- New Added Begin --- 测试用例，当 ID 为 -1 时抛出异常</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 触发异常测试，ID 为 -1 ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">RuntimeException</span><span class="tok-p">(</span><span class="tok-s">&quot;服务内部错误&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-c1">// -- New Added End --</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">itemService</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// 正常返回</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_2_使用自带断路器_resilience4jspringcloud_自带在服务层更细粒度控制">2) 使用自带断路器 Resilience4j（SpringCloud 自带，在服务层更细粒度控制）</h4>
<div class="paragraph">
<p>正常测试</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300001</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>item3 id 为 -1，会抛出异常，查看 8091 打印</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300003</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_file_service_orderpom_xml_7">file &#8594; service-order/pom.xml</h5>
<div class="sect5">
<h6 id="_resilience4j_注释掉不用">resilience4j 注释掉不用</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">io</span><span class="tok-nc">.github.resilience4j</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">resilience4j-spring-boot2</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-nt">1</span><span class="tok-nc">.7.0</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_spring_cloud_resilience4j">spring-cloud-&#8230;&#8203;resilience4j</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-o">&lt;</span><span class="tok-n">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-n">groupId</span><span class="tok-o">&gt;</span><span class="tok-n">org</span><span class="tok-p">.</span><span class="tok-na">springframework</span><span class="tok-p">.</span><span class="tok-na">cloud</span><span class="tok-o">&lt;/</span><span class="tok-n">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-n">artifactId</span><span class="tok-o">&gt;</span><span class="tok-n">spring</span><span class="tok-o">-</span><span class="tok-n">cloud</span><span class="tok-o">-</span><span class="tok-n">starter</span><span class="tok-o">-</span><span class="tok-n">circuitbreaker</span><span class="tok-o">-</span><span class="tok-n">resilience4j</span><span class="tok-o">&lt;/</span><span class="tok-n">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-n">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_6">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h5>
<div class="sect5">
<h6 id="_class_orderservice_5">class OrderService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务类</span>
<span class="tok-cm"> * 提供订单查询功能，并通过调用商品服务获取商品详细信息</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-c1">// private CircuitBreakerRegistry circuitBreakerRegistry;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">CircuitBreakerFactory</span><span class="tok-w"> </span><span class="tok-n">circuitBreakerFactory</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// 更改为工厂模式</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-n">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// --- New Added ---</span>

<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_第三个订单_order3item5_setid_1l_设为_1_itemcontroller_java_会抛出异常_2">第三个订单 order3&#8201;&#8212;&#8201;item5.setId(-1L) 设为 -1 ItemController.java 会抛出异常</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-p">();</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setOrderId</span><span class="tok-p">(</span><span class="tok-s">&quot;201810300003&quot;</span><span class="tok-p">);</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setCreateDate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-p">());</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setUpdateDate</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getCreateDate</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// 真会偷懒呀</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setUserId</span><span class="tok-p">(</span><span class="tok-mi">3L</span><span class="tok-p">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>

<span class="tok-c1">// 创建第一个商品详情（仅保存商品ID，需要调用商品微服务获取详细信息）</span>
<span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item3</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-mi">1L</span><span class="tok-p">);</span><span class="tok-w">          </span><span class="tok-c1">// --- 注意这里设置了 -1 哟! ---</span>
<span class="tok-n">orderDetails3</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-p">));</span>

<span class="tok-c1">// 创建第二个商品详情</span>
<span class="tok-n">item3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item3</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">6L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails3</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-p">));</span>

<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setOrderDetails</span><span class="tok-p">(</span><span class="tok-n">orderDetails3</span><span class="tok-p">);</span>

<span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">order3</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidwithcircuitbreaker主要更改的代码">Item queryItemByIdWithCircuitBreaker&#8201;&#8212;&#8201;主要更改的代码</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// Using Spring Cloud Circuit Breaker with CircuitBreakerFactory</span>
<span class="tok-w">    </span><span class="tok-c1">// 使用 Factory 创建断路器</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">circuitBreakerFactory</span><span class="tok-p">.</span><span class="tok-na">create</span><span class="tok-p">(</span><span class="tok-s">&quot;OrderService&quot;</span><span class="tok-p">).</span><span class="tok-na">run</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// 使用 feign</span>
<span class="tok-w">            </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;result:&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-p">},</span>
<span class="tok-w">        </span><span class="tok-n">throwable</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdFallback</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidfallback_断路器降级方法_3">Item queryItemByIdFallback 断路器降级方法</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 断路器降级方法</span>
<span class="tok-cm"> * @param id 商品 ID</span>
<span class="tok-cm"> * @param throwable 抛出的异常</span>
<span class="tok-cm"> * @return 降级后的默认商品信息</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdFallback</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=======CircuitBreaker 降级处理，原因：&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;查询商品信息出错&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_order_queryorderbyid_3">Order queryOrderById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 注入商品服务，用于查询商品详细信息</span>
<span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>
<span class="tok-cm">/**</span>
<span class="tok-cm"> * 根据订单ID查询订单数据</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param orderId 订单ID</span>
<span class="tok-cm"> * @return Order 订单信息，包含完整的商品详情</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 从模拟数据库中查询订单</span>
<span class="tok-w">    </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 获取订单详情列表</span>
<span class="tok-w">    </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderDetails</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-c1">// 遍历订单详情，通过商品微服务查询商品详细数据</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">OrderDetail</span><span class="tok-w"> </span><span class="tok-n">orderDetail</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 通过商品微服务查询商品详细数据</span>
<span class="tok-w">        </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">continue</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-c1">// 将查询到的商品详细信息设置到订单详情中</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-c1">// 如果断路器抛出异常，使用降级商品</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">fallbackItem</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdFallback</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">e</span>
<span class="tok-w">            </span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">fallbackItem</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_3_使用自带断路器_feignfeign_集成_springcloud_自带的断路器_resilience4j不需要在服务层手动管理断路器">3) 使用自带断路器 Feign（Feign 集成 SpringCloud 自带的断路器 Resilience4j，不需要在服务层手动管理断路器）</h4>
<div class="paragraph">
<p>正常测试</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300001</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>item3 id 为 -1，会抛出异常，查看 8091 打印，可以查看断路器工作状态的切换。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300003</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>查看负载均衡情况：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>把 8081 | 8082 | 8083 端口的服务都启动。</p>
</li>
<li>
<p>发送上面的命令查看各个端口的微服务是否有日志打印。</p>
<div class="literalblock">
<div class="title">日志类似于这样</div>
<div class="content">
<pre>2025-10-06 18:33:17.112  INFO 91339 --- [nio-8082-exec-3] c.t.s.controller.ItemController          : Handling request on port: 8082 for item ID: 2
Processing request on port: 8082 for item ID: 2</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainresourcesapplication_yml_7">file &#8594; service-order/src/main/resources/application.yml</h5>
<div class="sect5">
<h6 id="_feign_开启断路器">feign 开启断路器</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">feign</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_resilience4j_要改_orderservice_app_item">resilience4j 要改 OrderService &#8594; app-item</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">resilience4j</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">instances</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-c1"># OrderService:  这里就要改成与 Feign 要使用的 Eureka 服务名一样才行，如下面改成 app-item</span>
<span class="tok-w">      </span><span class="tok-nt">app-item</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">sliding-window-size</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span><span class="tok-w">                  </span><span class="tok-c1"># 需要 5次调用来计算失败率</span>
<span class="tok-w">        </span><span class="tok-nt">failure-rate-threshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span><span class="tok-w">              </span><span class="tok-c1"># 50% 失败率才跳闸</span>
<span class="tok-w">        </span><span class="tok-nt">wait-duration-in-open-state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10s</span><span class="tok-w">        </span><span class="tok-c1"># 10 秒后进入半开状态</span>
<span class="tok-w">        </span><span class="tok-nt">permitted-number-of-calls-in-half-open-state</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span><span class="tok-w">     </span><span class="tok-c1"># 半开状态允许 2 次调用</span>
<span class="tok-w">        </span><span class="tok-nt">sliding-window-type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">COUNT_BASED</span><span class="tok-w">        </span><span class="tok-c1"># 基于调用次数</span>
<span class="tok-w">        </span><span class="tok-nt">record-exceptions</span><span class="tok-p">:</span><span class="tok-w">                      </span><span class="tok-c1"># 哪些异常算失败</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">org.springframework.web.reactive.function.client.WebClientResponseException</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">java.lang.RuntimeException</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">java.io.IOException</span>
<span class="tok-w">        </span><span class="tok-nt">ignore-exceptions</span><span class="tok-p">:</span><span class="tok-w">                      </span><span class="tok-c1"># 忽略的异常类型</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">java.lang.IllegalArgumentException</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
实际生产要宽松一些的。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>测试 vs 生产</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">场景</th>
<th class="tableblock halign-left valign-top">测试配置</th>
<th class="tableblock halign-left valign-top">生产配置</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">窗口大小</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 次调用</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100次调用</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">故障阈值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">75%</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">恢复时间</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 秒</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60秒</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">目的</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">快速验证</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">稳定运行</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderclientitemfeignclient_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/client/ItemFeignClient.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.client</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo.Item</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.cloud.openfeign.FeignClient</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.GetMapping</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.PathVariable</span><span class="tok-p">;</span>

<span class="tok-c1">// 要访问的在 Eureka 中的服务名，并指定实现该接口的降级类名</span>
<span class="tok-nd">@FeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">fallback</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ItemFallback</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">interface</span> <span class="tok-nc">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderclientitemfallback_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/client/ItemFallback.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.client</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.pojo.Item</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.stereotype.Component</span><span class="tok-p">;</span>

<span class="tok-nd">@Component</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemFallback</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== ItemFallback.queryItemById 兜底回调被调用 ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;Feign 降级商品&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_7">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h5>
<div class="sect5">
<h6 id="_class_orderservice_6">class OrderService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务类</span>
<span class="tok-cm"> * 提供订单查询功能，并通过调用商品服务获取商品详细信息</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// @Autowired</span>
<span class="tok-w">    </span><span class="tok-c1">// private CircuitBreakerRegistry circuitBreakerRegistry;</span>
<span class="tok-w">    </span><span class="tok-c1">// private CircuitBreakerFactory circuitBreakerFactory;  // 更改为工厂模式</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-n">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// --- New Added ---</span>

<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_第三个订单_order3item3_setid_1l_设为_1_itemcontroller_java_会抛出异常">第三个订单 order3&#8201;&#8212;&#8201;item3.setId(-1L) 设为 -1 ItemController.java 会抛出异常</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-p">();</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setOrderId</span><span class="tok-p">(</span><span class="tok-s">&quot;201810300003&quot;</span><span class="tok-p">);</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setCreateDate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-p">());</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setUpdateDate</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getCreateDate</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// 真会偷懒呀</span>
<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setUserId</span><span class="tok-p">(</span><span class="tok-mi">3L</span><span class="tok-p">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>

<span class="tok-c1">// 创建第一个商品详情（仅保存商品ID，需要调用商品微服务获取详细信息）</span>
<span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item3</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-mi">1L</span><span class="tok-p">);</span><span class="tok-w">          </span><span class="tok-c1">// --- 注意这里设置了 -1 哟! ---</span>
<span class="tok-n">orderDetails3</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-p">));</span>

<span class="tok-c1">// 创建第二个商品详情</span>
<span class="tok-n">item3</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item3</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-mi">6L</span><span class="tok-p">);</span>
<span class="tok-n">orderDetails3</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item3</span><span class="tok-p">));</span>

<span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">setOrderDetails</span><span class="tok-p">(</span><span class="tok-n">orderDetails3</span><span class="tok-p">);</span>

<span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">order3</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">order3</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidwithcircuitbreaker主要更改的代码_2">Item queryItemByIdWithCircuitBreaker&#8201;&#8212;&#8201;主要更改的代码</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// 简化为直接调用，断路器由 Feign 自动处理</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// 使用 feign</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;result:&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_item_queryitembyidfallback_断路器降级方法没用了可以删除了">Item queryItemByIdFallback 断路器降级方法&#8201;&#8212;&#8201;没用了，可以删除了</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 断路器降级方法</span>
<span class="tok-cm"> * @param id 商品 ID</span>
<span class="tok-cm"> * @param throwable 抛出的异常</span>
<span class="tok-cm"> * @return 降级后的默认商品信息</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdFallback</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Throwable</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=======CircuitBreaker 降级处理，原因：&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">throwable</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;查询商品信息出错&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_order_queryorderbyid_4">Order queryOrderById</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 注入商品服务，用于查询商品详细信息</span>
<span class="tok-nd">@Autowired</span>
<span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>
<span class="tok-cm">/**</span>
<span class="tok-cm"> * 根据订单ID查询订单数据</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param orderId 订单ID</span>
<span class="tok-cm"> * @return Order 订单信息，包含完整的商品详情</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-nf">queryOrderById</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">orderId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-kd">throws</span><span class="tok-w"> </span><span class="tok-n">IOException</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 从模拟数据库中查询订单</span>
<span class="tok-w">    </span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">orderId</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 获取订单详情列表</span>
<span class="tok-w">    </span><span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getOrderDetails</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-c1">// 遍历订单详情，通过商品微服务查询商品详细数据</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">OrderDetail</span><span class="tok-w"> </span><span class="tok-n">orderDetail</span><span class="tok-w"> </span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">orderDetails</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-c1">// 通过商品微服务查询商品详细数据</span>
<span class="tok-w">        </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kc">null</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">item</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-k">continue</span><span class="tok-p">;</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-c1">// 将查询到的商品详细信息设置到订单详情中</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">item</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">Exception</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-c1">// 如果断路器抛出异常，使用降级商品</span>
<span class="tok-w">            </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">fallbackItem</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">queryItemByIdFallback</span><span class="tok-p">(</span>
<span class="tok-w">                </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">getItem</span><span class="tok-p">().</span><span class="tok-na">getId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">e</span>
<span class="tok-w">            </span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">orderDetail</span><span class="tok-p">.</span><span class="tok-na">setItem</span><span class="tok-p">(</span><span class="tok-n">fallbackItem</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">order</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_开启_spring_boot_actuator_查看断路器状态">开启 Spring Boot Actuator 查看断路器状态</h4>
<div class="paragraph">
<p>启动应用后，您可以访问以下端点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300004</p>
<div class="literalblock">
<div class="content">
<pre>HTTP/1.1 200
Connection: keep-alive
Content-Type: application/json
Date: Sun, 05 Oct 2025 14:15:05 GMT
Keep-Alive: timeout=60
Transfer-Encoding: chunked

{
    "createDate": "2025-10-05T14:14:44.090+00:00",
    "orderDetails": [
        {
            "item": {
                "desc": null,
                "id": -1,
                "pic": null,
                "price": null,
                "title": "Feign 降级商品"
            },
            "orderId": "201810300004"
        }
    ],
    "orderId": "201810300004",
    "updateDate": "2025-10-05T14:14:44.089+00:00",
    "userId": 4
}</pre>
</div>
</div>
</li>
<li>
<p>http :8091/actuator/health - 查看断路器健康状态</p>
</li>
<li>
<p>http :8091/actuator/circuitbreakerevents - 查看断路器事件历史</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_file_service_orderpom_xml_8">file &#8594; service-order/pom.xml</h5>
<div class="sect5">
<h6 id="_actuator">actuator</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.boot</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-boot-starter-actuator</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>

<span class="tok-o">&lt;!</span><span class="tok-nt">--</span><span class="tok-w"> </span><span class="tok-nt">Spring</span><span class="tok-w"> </span><span class="tok-nt">Retry</span><span class="tok-w"> </span><span class="tok-nt">--</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.retry</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-retry</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainresourcesapplication_yml_8">file &#8594; service-order/src/main/resources/application.yml</h5>
<div class="sect5">
<h6 id="_management">management</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">management</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">endpoints</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">web</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">exposure</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">include</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">health,info,circuitbreakerevents</span><span class="tok-w">  </span><span class="tok-c1"># 暴露断路器事件端点</span>
<span class="tok-w">  </span><span class="tok-nt">endpoint</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">health</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">show-details</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">always</span>
<span class="tok-w">  </span><span class="tok-nt">health</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">circuitbreakers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># 启用断路器健康检查</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderservice_java_8">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/OrderService.java</h5>
<div class="sect5">
<h6 id="_class_orderservice_7">class OrderService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务类</span>
<span class="tok-cm"> * 提供订单查询功能，并通过调用商品服务获取商品详细信息</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">OrderService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// @Autowired</span>
<span class="tok-w">    </span><span class="tok-c1">// private CircuitBreakerRegistry circuitBreakerRegistry;</span>
<span class="tok-w">    </span><span class="tok-c1">// private CircuitBreakerFactory circuitBreakerFactory;  // 更改为工厂模式</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-n">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">;</span><span class="tok-w">  </span><span class="tok-c1">// --- New Added ---</span>

<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_第四个订单_order4item4_setid_1l_设为_1_itemcontroller_java_会抛出异常">第四个订单 order4&#8201;&#8212;&#8201;item4.setId(-1L) 设为 -1 ItemController.java 会抛出异常</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">Order</span><span class="tok-w"> </span><span class="tok-n">order4</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Order</span><span class="tok-p">();</span>
<span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">setOrderId</span><span class="tok-p">(</span><span class="tok-s">&quot;201810300004&quot;</span><span class="tok-p">);</span>
<span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">setCreateDate</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Date</span><span class="tok-p">());</span>
<span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">setUpdateDate</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">.</span><span class="tok-na">getCreateDate</span><span class="tok-p">());</span><span class="tok-w">  </span><span class="tok-c1">// 真会偷懒呀</span>
<span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">setUserId</span><span class="tok-p">(</span><span class="tok-mi">4L</span><span class="tok-p">);</span>
<span class="tok-n">List</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">orderDetails4</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">ArrayList</span><span class="tok-o">&lt;</span><span class="tok-n">OrderDetail</span><span class="tok-o">&gt;</span><span class="tok-p">();</span>

<span class="tok-c1">// 创建一个商品详情（仅保存商品ID，需要调用商品微服务获取详细信息）</span>
<span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">item4</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">();</span>
<span class="tok-n">item4</span><span class="tok-p">.</span><span class="tok-na">setId</span><span class="tok-p">(</span><span class="tok-o">-</span><span class="tok-mi">1L</span><span class="tok-p">);</span><span class="tok-w">          </span><span class="tok-c1">// --- 注意这里设置了 -1 哟! ---</span>
<span class="tok-n">orderDetails4</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">OrderDetail</span><span class="tok-p">(</span><span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">item4</span><span class="tok-p">));</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">setOrderDetails</span><span class="tok-p">(</span><span class="tok-n">orderDetails4</span><span class="tok-p">);</span>

<span class="tok-n">ORDER_DATA</span><span class="tok-p">.</span><span class="tok-na">put</span><span class="tok-p">(</span><span class="tok-n">order4</span><span class="tok-p">.</span><span class="tok-na">getOrderId</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">order4</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>就创建一个商品，逐个累加计数，方便查看断路器的状态，不会跳数字，能看到半开状态 HALF_OPEN。
<div class="imageblock">
<div class="content">
<img src="img/actuator_health.png" alt="actuator health" width="900">
</div>
</div></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_feign_知识点">Feign 知识点</h3>
<div class="paragraph">
<p>Declarative rest Client 声明式 rest 客户端（之前叫编程式 rest 客户端，如 RestTemplate）。</p>
</div>
<div class="paragraph">
<p>注解驱动</p>
</div>
<div class="ulist">
<ul>
<li>
<p>指定远程地址: @FeignClient</p>
</li>
<li>
<p>指定请求方式: @GetMapping @PostMapping @DeleteMapping &#8230;&#8203;</p>
</li>
<li>
<p>指定携带数据: @PathVariable(路径参数) @RequestHeader @RequestParam @RequestBody &#8230;&#8203;</p>
</li>
<li>
<p>指定结果返回: 封装成的响应模型，如商品对象 Item</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_发送请求基本使用步骤总结未使用断路器_resilience4j_的步骤">发送请求基本使用步骤（总结未使用断路器 Resilience4j 的步骤）</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>引入依赖 openfeign</p>
<div class="listingblock">
<div class="title">service-order/pom.xml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-starter-openfeign</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>启动类开启 openfeign 远程调用功能 &#8594; @EnableFeignClients</p>
<div class="listingblock">
<div class="title">service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@SpringBootApplication</span>
<span class="tok-nd">@EnableEurekaClient</span><span class="tok-w">  </span><span class="tok-c1">// 启用 Eureka 客户端功能</span>
<span class="tok-nd">@EnableFeignClients</span><span class="tok-w">  </span><span class="tok-c1">// --- New Added --- 会初始化和配置 feign</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ServiceOrderApplication</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">SpringApplication</span><span class="tok-p">.</span><span class="tok-na">run</span><span class="tok-p">(</span><span class="tok-n">ServiceOrderApplication</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 包含其他代码</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>定义 feign 客户端接口</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// 要访问的在 Eureka 中的服务名，feign 已经实现了负载均衡，不用再写 @LoadBalanced</span>
<span class="tok-c1">// 会自动注入 ItemFeignClient 对象到 IOC 容器中，后面使用时直接 @Autowired 即可</span>
<span class="tok-nd">@FeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;app-item&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">interface</span> <span class="tok-nc">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// 使用 MVC 的注解，在 controller 上是接收请求，在 FeignClient 上是发送请求</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-c1">// 接收到的数据封装成商品对象 Item</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// id 由下往上传递</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>使用注入的 itemFeignClient（不要忘记先使用 @Autowired 注入）</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemByIdWithCircuitBreaker</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// 简化为直接调用，断路器由 Feign 自动处理</span>
<span class="tok-w">    </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// 使用 feign</span>
<span class="tok-w">    </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;result:&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_调用第三方api">调用第三方API</h4>
<div class="paragraph">
<p>测试天气 api
<a href="http://t.weather.sojson.com/api/weather/city/101030100" class="bare">http://t.weather.sojson.com/api/weather/city/101030100</a></p>
</div>
<div class="paragraph">
<p>citycode.json 文件下载:
<a href="https://github.com/LS-KR/China-Citycode/blob/main/citycode.json" class="bare">https://github.com/LS-KR/China-Citycode/blob/main/citycode.json</a></p>
</div>
<div class="listingblock">
<div class="title">通过 url 判断为第三方 API</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-c1">// weather-client 是自己随便起的名字，在这儿没具体作用</span>
<span class="tok-c1">// url 是第三方 API 的域名，有 url 则是第三方 API</span>
<span class="tok-nd">@FeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;weather-client&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">url</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;http://t.weather.sojson.com&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里只是最简单的一个 API，您可以自己找个复杂的 API 去练习一下，比如有 @PathVariable(路径参数) @RequestHeader @RequestParam @RequestBody &#8230;&#8203;</p>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderclientweatherfeignclient_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/client/WeatherFeignClient.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.client</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.cloud.openfeign.FeignClient</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.GetMapping</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.web.bind.annotation.PathVariable</span><span class="tok-p">;</span>

<span class="tok-c1">// weather-client 是自己随便起的名字，在这儿没具体作用</span>
<span class="tok-c1">// url 是第三方 API 的域名，有 url 则是第三方 API</span>
<span class="tok-nd">@FeignClient</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;weather-client&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">url</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;http://t.weather.sojson.com&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">interface</span> <span class="tok-nc">WeatherFeignClient</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/api/weather/city/{citycode}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-nf">getWeather</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;citycode&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">citycode</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrctestjavacomtjiseserviceorderweathertest_java">file &#8594; service-order/src/test/java/com/tjise/serviceorder/WeatherTest.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.client.WeatherFeignClient</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.junit.jupiter.api.Test</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.beans.factory.annotation.Autowired</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.boot.test.context.SpringBootTest</span><span class="tok-p">;</span>

<span class="tok-nd">@SpringBootTest</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">WeatherTest</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">WeatherFeignClient</span><span class="tok-w"> </span><span class="tok-n">weatherFeignClient</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@Test</span>
<span class="tok-w">    </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">testGetWeather</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">weather</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">weatherFeignClient</span><span class="tok-p">.</span><span class="tok-na">getWeather</span><span class="tok-p">(</span><span class="tok-s">&quot;101030100&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;weather: &quot;</span><span class="tok-w">  </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">weather</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_面试题_客户端负载均衡与服务端负载均衡的区别是什么">面试题: 客户端负载均衡与服务端负载均衡的区别是什么？</h4>
<div class="paragraph">
<p>看下面的图就明白了</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/client_and_server_balanced.png" alt="client and server balanced" width="700">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_日志功能">日志功能</h4>
<div class="paragraph">
<p>参考文档:
<a href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#feign-logging" class="bare">https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#feign-logging</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/feign_before_open_log.png" alt="feign before open log">
</div>
<div class="title">Figure 7. 打开 feign 日志前</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/feign_after_open_log.png" alt="feign after open log">
</div>
<div class="title">Figure 8. 打开 feign 日志后</div>
</div>
<div class="paragraph">
<p>下面是开启 Feign 日志的方法，开启后直接测试就行，不用启动任何微服务。</p>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainresourcesapplication_yml_9">file &#8594; service-order/src/main/resources/application.yml</h5>
<div class="sect5">
<h6 id="_logging">logging</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">logging</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">level</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">com.tjise.serviceorder.client</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">debug</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderconfigfeignconfig_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/config/FeignConfig.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.config</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">feign.Logger</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.context.annotation.Bean</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.context.annotation.Configuration</span><span class="tok-p">;</span>

<span class="tok-nd">@Configuration</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FeignConfig</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Bean</span>
<span class="tok-w">    </span><span class="tok-n">Logger</span><span class="tok-p">.</span><span class="tok-na">Level</span><span class="tok-w"> </span><span class="tok-nf">feignLoggerLevel</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">Logger</span><span class="tok-p">.</span><span class="tok-na">Level</span><span class="tok-p">.</span><span class="tok-na">FULL</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_超时控制">超时控制</h4>
<div class="imageblock">
<div class="content">
<img src="img/feign_timeout.png" alt="feign timeout" width="800">
</div>
<div class="title">Figure 9. 超时控制流程图</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/feign_timeout_category.png" alt="feign timeout category" width="800">
</div>
<div class="title">Figure 10. 超时控制分类</div>
</div>
<div class="sect4">
<h5 id="_测试默认_readtimeout_60s_超时注意要关闭_feign_断路器功能">测试默认 readTimeout 60s 超时（注意要关闭 feign 断路器功能）</h5>
<div class="paragraph">
<p>下面先模拟查询商品微服务返回超时 readTimeout 大于 FeignClient 默认的 60s，设置为 100s，这样可以模拟出超时的效果来。</p>
</div>
<div class="paragraph">
<p>测试步骤：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>启动 Eureka-server 注册中心</p>
</li>
<li>
<p>启动 service-item 微服务</p>
</li>
<li>
<p>启动 service-order 微服务</p>
</li>
<li>
<p>访问下面链接会在 60s 超时</p>
<div class="ulist">
<ul>
<li>
<p>http :8091/order/201810300001</p>
<div class="literalblock">
<div class="content">
<pre>HTTP/1.1 500
Connection: close
Content-Type: application/json
Date: Tue, 07 Oct 2025 12:28:55 GMT
Transfer-Encoding: chunked

{
    "error": "Internal Server Error",
    "path": "/order/201810300001",
    "status": 500,
    "timestamp": "2025-10-07T12:28:55.156+00:00"
}</pre>
</div>
</div>
<div class="literalblock">
<div class="title">微服务 service-order 显示 readTimeout</div>
<div class="content">
<pre>java.net.SocketTimeoutException: Read timed out -&gt; 显示读取超时了
	at java.net.SocketInputStream.socketRead0(Native Method) ~[na:1.8.0_301]
	at java.net.SocketInputStream.socketRead(SocketInputStream.java:116) ~[na:1.8.0_301]
	at java.net.SocketInputStream.read(SocketInputStream.java:171) ~[na:1.8.0_301]
	at java.net.SocketInputStream.read(SocketInputStream.java:141) ~[na:1.8.0_301]
	at java.io.BufferedInputStream.fill(BufferedInputStream.java:246) ~[na:1.8.0_301]
	at java.io.BufferedInputStream.read1(BufferedInputStream.java:286) ~[na:1.8.0_301]
	at java.io.BufferedInputStream.read(BufferedInputStream.java:345) ~[na:1.8.0_301]
	at sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:735) ~[na:1.8.0_301]</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemservice_java_2">file &#8594; service-item/src/main/java/com/tjise/serviceitem/service/ItemService.java</h6>

</div>
<div class="sect5">
<h6 id="_item_queryitembyid_增加超时_100s_模拟">Item queryItemById &#8594; 增加超时 100s 模拟</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 模拟实现商品查询</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param id</span>
<span class="tok-cm"> * @return</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// 模拟超时 100s 大于 FeignClient 默认的 60s 超时，可以实现 FeignClient readTimeout 效果。</span>
<span class="tok-w">    </span><span class="tok-k">try</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">.</span><span class="tok-na">sleep</span><span class="tok-p">(</span><span class="tok-mi">100</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">catch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">InterruptedException</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">RuntimeException</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ITEM_MAP</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainresourcesapplication_yml_10">file &#8594; service-order/src/main/resources/application.yml</h6>

</div>
<div class="sect5">
<h6 id="_feign_关闭断路器_如果开启spring_cloud_设置了_5s_默认的慢超时">feign 关闭断路器 &#8594; 如果开启，Spring Cloud 设置了 5s 默认的慢超时</h6>
<div class="listingblock">
<div class="title">注释 feign 的断路器功能才能测出来我们自定义的 readTimeout 60s</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># feign:</span>
<span class="tok-w">  </span><span class="tok-c1"># circuitbreaker:</span>
<span class="tok-w">    </span><span class="tok-c1"># enabled: true</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">参考知识</div>
<div class="paragraph">
<p>在 Resilience4JCircuitBreakerFactory 或 Resilience4JAutoConfiguration 类中，Spring Cloud 会覆盖 Resilience4j 的默认配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Configuration</span>
<span class="tok-nd">@ConditionalOnClass</span><span class="tok-p">(</span><span class="tok-n">CircuitBreaker</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">Resilience4JAutoConfiguration</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Bean</span>
<span class="tok-w">    </span><span class="tok-nd">@ConditionalOnMissingBean</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CircuitBreakerConfig</span><span class="tok-w"> </span><span class="tok-nf">circuitBreakerConfig</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">CircuitBreakerConfig</span><span class="tok-p">.</span><span class="tok-na">custom</span><span class="tok-p">()</span>
<span class="tok-w">            </span><span class="tok-c1">// Spring Cloud 会设置更严格的默认值</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">slowCallDurationThreshold</span><span class="tok-p">(</span><span class="tok-n">Duration</span><span class="tok-p">.</span><span class="tok-na">ofSeconds</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">))</span><span class="tok-w">  </span><span class="tok-c1">// 这里设置为5秒</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">slowCallRateThreshold</span><span class="tok-p">(</span><span class="tok-mi">100</span><span class="tok-p">)</span>
<span class="tok-w">            </span><span class="tok-p">.</span><span class="tok-na">build</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_配置_connecttimeout_和_readtimeout">配置 connectTimeout 和 readTimeout</h5>
<div class="sect5">
<h6 id="_file_service_ordersrcmainresourcesapplication_yml_11">file &#8594; service-order/src/main/resources/application.yml</h6>

</div>
<div class="sect5">
<h6 id="_spring_import_application_feign_yml">spring &#8594; import application-feign.yml</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># -- New Added import application-feign.yml 文件 --</span>
<span class="tok-w">        </span><span class="tok-nt">import</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">application-feign.yml</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span>
<span class="tok-w">    </span><span class="tok-nt">cloud</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">resilience4j</span><span class="tok-p">:</span>
<span class="tok-w">                </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_feign_开启断路器测试时不用再关闭_feign_断路器功能">feign 开启断路器（测试时不用再关闭 feign 断路器功能）</h6>
<div class="paragraph">
<p>connectTimeout &amp; readTimeout 以配置为准，如 readTimeout 不再是 spring cloud 断路器的默认值 5s。
所以在测试时，是否开启该功能则没有影响了。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">feign</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainresourcesapplication_feign_yml">file &#8594; service-order/src/main/resources/application-feign.yml</h6>

</div>
<div class="sect5">
<h6 id="_spring_专门定义_openfeign_会被_application_yml_导入">spring &#8594; 专门定义 openfeign 会被 application.yml 导入</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">feign</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">client</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-c1"># 默认设置</span>
<span class="tok-w">            </span><span class="tok-nt">default</span><span class="tok-p">:</span>
<span class="tok-w">                </span><span class="tok-nt">connectTimeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5000</span>
<span class="tok-w">                </span><span class="tok-nt">readTimeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5000</span>

<span class="tok-w">            </span><span class="tok-c1"># -- NOTE: feignName 写要调用的微服务名，会覆盖 default 默认设置 --</span>
<span class="tok-w">            </span><span class="tok-nt">app-item</span><span class="tok-p">:</span>
<span class="tok-w">                </span><span class="tok-nt">connectTimeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3000</span>
<span class="tok-w">                </span><span class="tok-nt">readTimeout</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000</span>
<span class="tok-w">                </span><span class="tok-c1"># 优先级低于 config/FeignConfig.java 中的 Logger.Level</span>
<span class="tok-w">                </span><span class="tok-c1"># loggerLevel: full</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_重试机制">重试机制</h4>
<div class="paragraph">
<p>远程调用超时失败后，还可以进行多次尝试。如果某次成功返回 ok，如果多次依然失败则结束调用，返回错误。</p>
</div>
<div class="paragraph">
<p>测试：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="console"><span></span><span class="tok-go">&gt; http :8091/order/201810300001</span>
<span class="tok-go">HTTP/1.1 500</span>
<span class="tok-go">Connection: close</span>
<span class="tok-go">Content-Type: application/json</span>
<span class="tok-go">Date: Wed, 08 Oct 2025 02:40:29 GMT</span>
<span class="tok-go">Transfer-Encoding: chunked</span>

<span class="tok-go">{</span>
<span class="tok-go">    &quot;error&quot;: &quot;Internal Server Error&quot;,</span>
<span class="tok-go">    &quot;path&quot;: &quot;/order/201810300001&quot;,</span>
<span class="tok-go">    &quot;status&quot;: 500,</span>
<span class="tok-go">    &quot;timestamp&quot;: &quot;2025-10-08T02:40:29.444+00:00&quot;</span>
<span class="tok-go">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="title">微服务 service-item 8081 打印尝试了 5 次</div>
<div class="content">
<pre>Processing request on port: 8081 for item ID: 1
Processing request on port: 8081 for item ID: 1
Processing request on port: 8081 for item ID: 1
Processing request on port: 8081 for item ID: 1
Processing request on port: 8081 for item ID: 1</pre>
</div>
</div>
<div class="sect4">
<h5 id="_只是重试没有兜底返回不能使用断路器">只是重试没有兜底返回（不能使用断路器）</h5>
<div class="sidebarblock">
<div class="content">
<div class="title">重试规则</div>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#spring-cloud-feign-overriding-defaults" class="bare">https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/#spring-cloud-feign-overriding-defaults</a></p>
</div>
<div class="literalblock">
<div class="title">spring 官网说 openfeign 默认没有开启重试机制</div>
<div class="content">
<pre>A bean of Retryer.NEVER_RETRY with the type Retryer is created by default, which will disable retrying. Notice this retrying behavior is different from the Feign default one, where it will automatically retry IOExceptions, treating them as transient network related exceptions, and any RetryableException thrown from an ErrorDecoder.</pre>
</div>
</div>
<div class="paragraph">
<p>openfeign 的重试规则源码:
/Users/swot/maven/repository/io/github/openfeign/feign-core/11.10/feign-core-11.10.jar!/feign/Retryer.class</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">Default</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">Retryer</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">maxAttempts</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">period</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">maxPeriod</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">attempt</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kt">long</span><span class="tok-w"> </span><span class="tok-n">sleptForMillis</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">Default</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">this</span><span class="tok-p">(</span><span class="tok-mi">100L</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">.</span><span class="tok-na">toMillis</span><span class="tok-p">(</span><span class="tok-mi">1L</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-mi">5</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这是 OpenFeign 的默认重试器实现，详细解释它的重试规则和延时机制：</p>
</div>
<div class="listingblock">
<div class="title">重试规则参数</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-nf">Default</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">this</span><span class="tok-p">(</span><span class="tok-mi">100L</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TimeUnit</span><span class="tok-p">.</span><span class="tok-na">SECONDS</span><span class="tok-p">.</span><span class="tok-na">toMillis</span><span class="tok-p">(</span><span class="tok-mi">1L</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-mi">5</span><span class="tok-p">);</span>
<span class="tok-p">}</span>
<span class="tok-c1">// 参数含义：period, maxPeriod, maxAttempts</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>核心参数：</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>period: 100L</code> - <strong>基础延时100毫秒</strong></p>
</li>
<li>
<p><code>maxPeriod: 1000L</code> - <strong>最大延时1000毫秒</strong>（1秒）</p>
</li>
<li>
<p><code>maxAttempts: 5</code> - <strong>最多重试5次</strong>（包含初始请求）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>延时机制</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>指数退避策略（OpenFeign 使用 1.5倍指数退避 算法）</p>
<div class="ulist">
<ul>
<li>
<p>第1次重试：等待 100ms × 1.5⁰ = 100ms</p>
</li>
<li>
<p>第2次重试：等待 100ms × 1.5¹ = 150ms</p>
</li>
<li>
<p>第3次重试：等待 100ms × 1.5² = 225ms</p>
</li>
<li>
<p>第4次重试：等待 100ms × 1.5³ ≈ 338ms</p>
</li>
<li>
<p>第5次重试：等待 100ms × 1.5⁴ ≈ 506ms</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>最大延时限制</strong></p>
<div class="ulist">
<ul>
<li>
<p>即使计算出的延时超过 <code>maxPeriod(1000ms)</code>，实际等待时间也不会超过1秒。</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>重试场景，这个重试器在以下情况会触发重试：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTTP连接超时</p>
</li>
<li>
<p>服务端返回5xx错误</p>
</li>
<li>
<p>网络IO异常等可重试的异常</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="title">使用示例</div>
<div class="content">
<pre>// 如果服务调用失败，重试过程如下：
第1次请求 → 失败 → 等待100ms
第2次请求 → 失败 → 等待150ms
第3次请求 → 失败 → 等待225ms
第4次请求 → 失败 → 等待338ms
第5次请求 → 失败 → 停止重试，抛出异常</pre>
</div>
</div>
<div class="paragraph">
<p><strong>注意事项</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>总重试次数 = 初始请求 + 4次重试</strong></p>
</li>
<li>
<p><strong>不适合所有场景</strong>：对于非幂等操作（POST、PUT）要谨慎使用</p>
</li>
<li>
<p>可以通过自定义 <code>Retryer</code> 实现来修改重试策略</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>这种<strong>指数退避+最大限制</strong>的策略既能给服务恢复时间，又避免了无限等待和雪崩效应。</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainjavacomtjiseserviceorderconfigfeignconfig_java_2">file &#8594; service-order/src/main/java/com/tjise/serviceorder/config/FeignConfig.java</h6>

</div>
<div class="sect5">
<h6 id="_retryer_retryer_new_added_重试机制">Retryer retryer &#8594; New Added 重试机制</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Bean</span>
<span class="tok-n">Retryer</span><span class="tok-w"> </span><span class="tok-nf">retryer</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Retryer</span><span class="tok-p">.</span><span class="tok-na">Default</span><span class="tok-p">();</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainresourcesapplication_yml_12">file &#8594; service-order/src/main/resources/application.yml</h6>

</div>
<div class="sect5">
<h6 id="_spring_import_application_feign_yml_2">spring &#8594; import application-feign.yml</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># -- New Added import application-feign.yml 文件 --</span>
<span class="tok-w">        </span><span class="tok-nt">import</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">application-feign.yml</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span>
<span class="tok-w">    </span><span class="tok-nt">cloud</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">resilience4j</span><span class="tok-p">:</span>
<span class="tok-w">                </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_feign_开启断路器测试时需要关闭_feign_断路器功能">feign 开启断路器（测试时需要关闭 feign 断路器功能）</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-c1"># feign:</span>
<span class="tok-w">    </span><span class="tok-c1"># circuitbreaker:</span>
<span class="tok-w">        </span><span class="tok-c1"># enabled: true</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_spring_retry_重试加_fallback_兜底返回未使用断路器_理解">spring Retry 重试加 fallback 兜底返回（未使用断路器）-- 理解</h5>
<div class="sect5">
<h6 id="_file_service_orderpom_xml_9">file &#8594; service-order/pom.xml</h6>

</div>
<div class="sect5">
<h6 id="_retry">retry</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">org</span><span class="tok-nc">.springframework.retry</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-retry</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceorderapplication_java_9">file &#8594; service-order/src/main/java/com/tjise/serviceorder/ServiceOrderApplication.java</h6>

</div>
<div class="sect5">
<h6 id="_class_serviceorderapplication_enablefeignclients_2">class ServiceOrderApplication &#8594; @EnableFeignClients</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 订单服务启动类，Spring Boot 应用程序入口点。</span>
<span class="tok-cm"> */</span>
<span class="tok-nd">@SpringBootApplication</span>
<span class="tok-nd">@EnableEurekaClient</span><span class="tok-w">  </span><span class="tok-c1">// 启用 Eureka 客户端功能</span>
<span class="tok-nd">@EnableFeignClients</span><span class="tok-w">  </span><span class="tok-c1">// 会初始化和配置 feign</span>
<span class="tok-nd">@EnableRetry</span><span class="tok-w">         </span><span class="tok-c1">// --- New Added --- 启用Spring Retry支持</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ServiceOrderApplication</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">SpringApplication</span><span class="tok-p">.</span><span class="tok-na">run</span><span class="tok-p">(</span><span class="tok-n">ServiceOrderApplication</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-c1">// 包含其他代码</span>
<span class="tok-w">    </span><span class="tok-nd">@others</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">负载均衡使用拦截器原理：</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>拦截请求URL</p>
</li>
<li>
<p>识别服务名</p>
</li>
<li>
<p>通过服务发现获取实际地址</p>
</li>
<li>
<p>替换URL并发起请求</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainjavacomtjiseserviceorderserviceelegantretryservice_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/service/ElegantRetryService.java</h6>

</div>
<div class="sect5">
<h6 id="_class_elegantretryservice">class ElegantRetryService</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Slf4j</span>
<span class="tok-nd">@Service</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ElegantRetryService</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemFeignClient</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 优雅的重试实现 - 使用Spring Retry注解</span>
<span class="tok-cm">     * 策略：重试5次 -&gt; 如果都失败 -&gt; 返回降级结果</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@Retryable</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-n">RuntimeException</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">},</span>
<span class="tok-w">        </span><span class="tok-n">maxAttempts</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">5</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">backoff</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nd">@Backoff</span><span class="tok-p">(</span><span class="tok-n">delay</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">500</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">getItemWithElegantRetry</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">itemId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-p">.</span><span class="tok-na">parseLong</span><span class="tok-p">(</span><span class="tok-n">itemId</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;尝试调用商品服务，商品ID: {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">itemFeignClient</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 降级方法 - 当重试5次都失败时调用，是通过 @Recover 找到 fallbackItem 的</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@Recover</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">fallbackItem</span><span class="tok-p">(</span><span class="tok-n">RuntimeException</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">itemId</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-p">.</span><span class="tok-na">parseLong</span><span class="tok-p">(</span><span class="tok-n">itemId</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">warn</span><span class="tok-p">(</span><span class="tok-s">&quot;重试5次后仍然失败，返回降级结果，异常: {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">.</span><span class="tok-na">getMessage</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;降级商品&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kc">null</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;服务暂时不可用&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-n">L</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_file_service_ordersrcmainjavacomtjiseserviceordercontrollerelegantretrycontroller_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/controller/ElegantRetryController.java</h6>

</div>
<div class="sect5">
<h6 id="_class_elegantretrycontroller">class ElegantRetryController</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@Slf4j</span>
<span class="tok-nd">@RestController</span>
<span class="tok-nd">@RequestMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/elegant&quot;</span><span class="tok-p">)</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ElegantRetryController</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ElegantRetryService</span><span class="tok-w"> </span><span class="tok-n">elegantRetryService</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 测试优雅的重试机制</span>
<span class="tok-cm">     * 策略：重试5次 -&gt; 如果都失败 -&gt; 返回降级结果</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-s">&quot;/item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">getItemWithElegantRetry</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-w"> </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;开始调用优雅重试服务，商品ID: {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">elegantRetryService</span><span class="tok-p">.</span><span class="tok-na">getItemWithElegantRetry</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">log</span><span class="tok-p">.</span><span class="tok-na">info</span><span class="tok-p">(</span><span class="tok-s">&quot;最终结果: {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_请求和响应拦截器">请求和响应拦截器</h4>
<div class="imageblock">
<div class="content">
<img src="img/feign_interceptor.png" alt="feign interceptor" width="800">
</div>
</div>
<div class="paragraph">
<p>测试发送
http -v :8091/elegant/item/1</p>
</div>
<div class="literalblock">
<div class="title">在 service-item 微服务打印 header 内容</div>
<div class="content">
<pre>header token = 1ea826d5-3c48-4e5b-890d-a00f59e8a92a
Processing request on port: 8081 for item ID: 1</pre>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainjavacomtjiseserviceorderinterceptorxtokenrequestinterceptor_java">file &#8594; service-order/src/main/java/com/tjise/serviceorder/interceptor/XTokenRequestInterceptor.java</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">package</span><span class="tok-w"> </span><span class="tok-nn">com.tjise.serviceorder.interceptor</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">feign.RequestInterceptor</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">feign.RequestTemplate</span><span class="tok-p">;</span>
<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">org.springframework.stereotype.Component</span><span class="tok-p">;</span>

<span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">java.util.UUID</span><span class="tok-p">;</span>

<span class="tok-nd">@Component</span><span class="tok-w">  </span><span class="tok-c1">// -- New Added -- 会自动应用 IOC 容器中的 RequestInterceptor 组件</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">XTokenRequestInterceptor</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">RequestInterceptor</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 请求拦截器</span>
<span class="tok-cm">     * @param requestTemplate 请求模板</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">apply</span><span class="tok-p">(</span><span class="tok-n">RequestTemplate</span><span class="tok-w"> </span><span class="tok-n">requestTemplate</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;请求拦截器...&quot;</span><span class="tok-p">);</span>
<span class="tok-c1">//        requestTemplate.header(&quot;X-Token&quot;, &quot;123456&quot;);</span>
<span class="tok-w">        </span><span class="tok-n">requestTemplate</span><span class="tok-p">.</span><span class="tok-na">header</span><span class="tok-p">(</span><span class="tok-s">&quot;X-Token&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">UUID</span><span class="tok-p">.</span><span class="tok-na">randomUUID</span><span class="tok-p">().</span><span class="tok-na">toString</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_itemsrcmainjavacomtjiseserviceitemserviceitemservice_java_3">file &#8594; service-item/src/main/java/com/tjise/serviceitem/service/ItemService.java</h5>
<div class="sect5">
<h6 id="_item_queryitembyid_注释模拟超时代码">Item queryItemById &#8594; 注释模拟超时代码</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-cm">/**</span>
<span class="tok-cm"> * 模拟实现商品查询</span>
<span class="tok-cm"> *</span>
<span class="tok-cm"> * @param id</span>
<span class="tok-cm"> * @return</span>
<span class="tok-cm"> */</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-c1">// 模拟超时 100s 大于 FeignClient 默认的 60s 超时，可以实现 FeignClient readTimeout 效果。</span>
<span class="tok-w">    </span><span class="tok-c1">// try {</span>
<span class="tok-w">        </span><span class="tok-c1">// TimeUnit.SECONDS.sleep(100);</span>
<span class="tok-w">    </span><span class="tok-c1">// } catch (InterruptedException e) {</span>
<span class="tok-w">        </span><span class="tok-c1">// throw new RuntimeException(e);</span>
<span class="tok-w">    </span><span class="tok-c1">// }</span>

<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ITEM_MAP</span><span class="tok-p">.</span><span class="tok-na">get</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_itemsrcmainjavacomtjiseserviceitemcontrolleritemcontroller_java_4">file &#8594; service-item/src/main/java/com/tjise/serviceitem/controller/ItemController.java</h5>
<div class="sect5">
<h6 id="_public_class_itemcontroller">public class ItemController</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-nd">@RestController</span>
<span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">ItemController</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Autowired</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-n">ItemService</span><span class="tok-w"> </span><span class="tok-n">itemService</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@Value</span><span class="tok-p">(</span><span class="tok-s">&quot;${server.port}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">serverPort</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">private</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-n">Logger</span><span class="tok-w"> </span><span class="tok-n">logger</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Logger</span><span class="tok-p">.</span><span class="tok-na">getLogger</span><span class="tok-p">(</span>
<span class="tok-w">                         </span><span class="tok-n">ItemController</span><span class="tok-p">.</span><span class="tok-na">class</span><span class="tok-p">.</span><span class="tok-na">getName</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-cm">/**</span>
<span class="tok-cm">     * 对外提供接口服务，查询商品信息</span>
<span class="tok-cm">     *</span>
<span class="tok-cm">     * @param id</span>
<span class="tok-cm">     * @return</span>
<span class="tok-cm">     */</span>
<span class="tok-w">    </span><span class="tok-nd">@GetMapping</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;item/{id}&quot;</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">Item</span><span class="tok-w"> </span><span class="tok-nf">queryItemById</span><span class="tok-p">(</span><span class="tok-nd">@PathVariable</span><span class="tok-p">(</span><span class="tok-s">&quot;id&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">Long</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">,</span>
<span class="tok-w">                              </span><span class="tok-n">HttpServletRequest</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">String</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">.</span><span class="tok-na">getHeader</span><span class="tok-p">(</span><span class="tok-s">&quot;X-Token&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;header token = &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-c1">// 增加了日志打印功能，方便查看是哪个 service-item 提供的服务。</span>
<span class="tok-c1">//        logger.info(&quot;Handling request on port: &quot; + serverPort + &quot; for item ID: &quot; + id);</span>
<span class="tok-w">        </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;Processing request on port: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">serverPort</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot; for item ID: &quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">);</span>

<span class="tok-w">        </span><span class="tok-c1">// -- New Added Begin --- 测试用例，当 ID 为 -1 时抛出异常</span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">System</span><span class="tok-p">.</span><span class="tok-na">out</span><span class="tok-p">.</span><span class="tok-na">println</span><span class="tok-p">(</span><span class="tok-s">&quot;=== 触发异常测试，ID 为 -1 ===&quot;</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-k">throw</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">RuntimeException</span><span class="tok-p">(</span><span class="tok-s">&quot;服务内部错误&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-c1">// -- New Added End --</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-k">this</span><span class="tok-p">.</span><span class="tok-na">itemService</span><span class="tok-p">.</span><span class="tok-na">queryItemById</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">);</span><span class="tok-w">  </span><span class="tok-c1">// 正常返回</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_兜底返回_feign_with_sentinel_fallback">兜底返回 &#8594; Feign with Sentinel fallback</h4>
<div class="imageblock">
<div class="content">
<img src="img/feign_fallback.png" alt="feign fallback" width="800">
</div>
</div>
<div class="paragraph">
<p>前面已经实现过了。参考「使用自带断路器 Feign（Feign 集成 SpringCloud 自带的断路器 Resilience4j，不需要在服务层手动管理断路器）」。</p>
</div>
<div class="paragraph">
<p>下面我们再看如何使用熔断框架 Sentinel 如何实现 Feign 的兜底返回。</p>
</div>
<div class="literalblock">
<div class="title">测试结果</div>
<div class="content">
<pre>&gt; http :8091/order/201810300004
HTTP/1.1 200
Connection: keep-alive
Content-Type: application/json
Date: Fri, 10 Oct 2025 06:28:19 GMT
Keep-Alive: timeout=60
Transfer-Encoding: chunked

{
    "createDate": "2025-10-10T06:27:52.828+00:00",
    "orderDetails": [
        {
            "item": {
                "desc": null,
                "id": -1,
                "pic": null,
                "price": null,
                "title": "Feign 降级商品"
            },
            "orderId": "201810300004"
        }
    ],
    "orderId": "201810300004",
    "updateDate": "2025-10-10T06:27:52.826+00:00",
    "userId": 4
}</pre>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_orderpom_xml_10">file &#8594; service-order/pom.xml</h5>
<div class="sect5">
<h6 id="_sentinel">Sentinel</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scss"><span></span><span class="tok-o">&lt;</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span><span class="tok-nt">com</span><span class="tok-nc">.alibaba.cloud</span><span class="tok-o">&lt;/</span><span class="tok-nt">groupId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span><span class="tok-nt">spring-cloud-starter-alibaba-sentinel</span><span class="tok-o">&lt;/</span><span class="tok-nt">artifactId</span><span class="tok-o">&gt;</span>
<span class="tok-w">    </span><span class="tok-o">&lt;</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span><span class="tok-nt">2021</span><span class="tok-nc">.0.5.0</span><span class="tok-o">&lt;/</span><span class="tok-nt">version</span><span class="tok-o">&gt;</span>
<span class="tok-o">&lt;/</span><span class="tok-nt">dependency</span><span class="tok-o">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_file_service_ordersrcmainresourcesapplication_yml_13">file &#8594; service-order/src/main/resources/application.yml</h5>
<div class="sect5">
<h6 id="_spring_停用_spring_cloud_集成的_resilience4j_断路器">spring &#8594; 停用 spring cloud 集成的 resilience4j 断路器</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">spring</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">import</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">application-feign.yml</span>
<span class="tok-w">    </span><span class="tok-nt">application</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)</span>
<span class="tok-w">        </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-order</span>
<span class="tok-w">    </span><span class="tok-nt">cloud</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-c1"># 使用 spring cloud 集成的 resilience4j</span>
<span class="tok-w">        </span><span class="tok-nt">circuitbreaker</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">resilience4j</span><span class="tok-p">:</span>
<span class="tok-w">                </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">        </span><span class="tok-c1"># sentinel:</span>
<span class="tok-w">            </span><span class="tok-c1"># transport:</span>
<span class="tok-w">                </span><span class="tok-c1"># dashboard: localhost:8858  # Sentinel 控制台地址</span>
<span class="tok-w">            </span><span class="tok-c1"># eager: true  # 立即初始化 Sentinel</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_feign_开启断路器_测试时需要开启_sentinel_支持_feign_断路器功能">feign 开启断路器 &#8594; 测试时需要开启 sentinel 支持 feign 断路器功能</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">feign</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-c1"># 直接使用 resilience4j</span>
<span class="tok-w">    </span><span class="tok-c1"># circuitbreaker:</span>
<span class="tok-w">        </span><span class="tok-c1"># enabled: true</span>
<span class="tok-w">    </span><span class="tok-nt">sentinel</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">enabled</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_10_sentinel">10. Sentinel</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_docker_开启_sentinel_dashboard">docker 开启 sentinel-dashboard</h3>
<div class="imageblock">
<div class="content">
<img src="img/sentinel_dashboard186.png" alt="sentinel dashboard186">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/sentinel_dashboard186_run.png" alt="sentinel dashboard186 run">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="img/sentinel_dashboard186_admin.png" alt="sentinel dashboard186 admin">
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-10-10 15:03:36 +0800
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>