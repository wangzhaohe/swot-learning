#@+leo-ver=5-thin
#@+node:swot.20251005160616.1: * @file service-order/src/main/resources/application.yml
#@@language yaml
#@+others
#@+node:swot.20251005160616.2: ** port
#@+doc
# [source,yaml]
# ----
#@@c
server:
    port: 8091
#@+doc
# ----
#@+node:swot.20251005160616.3: ** spring
#@+doc
# [source, yaml]
# ----
#@@c
# 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)
spring:
    application:
        name: app-order
#@+doc
# ----
#@+node:swot.20251005160616.4: ** eureka
#@+doc
# [source,yaml]
# ----
#@@c
# 服务注册到 eureka 注册中心的地址
eureka:
    client:
        service-url:
            # defaultZone: http://root:root@127.0.0.1:8761/eureka/
            defaultZone: http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/
        register-with-eureka: true  # 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心
        fetch-registry: true        # 是否需要从 eureka 上检索服务
    instance:
        prefer-ip-address: true     # 使用 IP地址 注册而不是主机名
        ip-address: 127.0.0.1       # 客户端在注册时使用自己的 IP，而不是主机名
                                    # 这是生产环境的最佳实践。避免主机名解析问题
#@+doc
# ----
#@+node:swot.20251005160616.5: ** resilience4j
#@+doc
# [source,yaml]
# ----
#@@c
#@@language yaml
resilience4j:
  circuitbreaker:
    instances:
      OrderService:
        sliding-window-size: 5                  # 需要 5次调用来计算失败率
        failure-rate-threshold: 50              # 50% 失败率才跳闸
        wait-duration-in-open-state: 10s        # 10 秒后进入半开状态
        permitted-number-of-calls-in-half-open-state: 2     # 半开状态允许 2 次调用
        sliding-window-type: COUNT_BASED        # 基于调用次数
        record-exceptions:                      # 哪些异常算失败
          - org.springframework.web.reactive.function.client.WebClientResponseException
          - java.lang.RuntimeException
          - java.io.IOException
        ignore-exceptions:                      # 忽略的异常类型
          - java.lang.IllegalArgumentException
#@+doc
# ----
#
# NOTE: 实际生产要宽松一些的。
#
# [caption=]
# 测试 vs 生产
# [cols="1,1,1",options="header"]
# |===
# | 场景    | 测试配置 | 生产配置
# | 窗口大小 | 5 次调用 | 100次调用
# | 故障阈值 | 50%     | 75%
# | 恢复时间 | 10 秒   | 60秒
# | 目的    | 快速验证 | 稳定运行
# |===
#@-others
#@-leo
