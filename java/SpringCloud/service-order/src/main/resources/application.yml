#@+leo-ver=5-thin
#@+node:swot.20251007173755.1: * @file service-order/src/main/resources/application.yml
#@@language yaml
#@+others
#@+node:swot.20251007173755.2: ** @ignore-tree 
#@+node:swot.20251007173755.3: *3* port
#@+doc
# [source,yaml]
# ----
#@@c
server:
    port: 8091
#@+doc
# ----
#@+node:swot.20251007173755.4: *3* spring
#@+doc
# [source, yaml]
# ----
#@@c
# 起个名字作为服务名称(该服务注册到 eureka 注册中心的名称，比如订单服务)
spring:
    application:
        name: app-order
#@+doc
# ----
#@+node:swot.20251007173755.5: *3* eureka
#@+doc
# [source,yaml]
# ----
#@@c
# 服务注册到 eureka 注册中心的地址
eureka:
    client:
        service-url:
            # defaultZone: http://root:root@127.0.0.1:8761/eureka/
            defaultZone: http://root:root@eureka1:8761/eureka/,http://root:root@eureka2:8762/eureka/,http://root:root@eureka3:8763/eureka/
        register-with-eureka: true  # 因为该应用为服务提供者，是 eureka 的一个客户端，需要注册到注册中心
        fetch-registry: true        # 是否需要从 eureka 上检索服务
    instance:
        prefer-ip-address: true     # 使用 IP地址 注册而不是主机名
        ip-address: 127.0.0.1       # 客户端在注册时使用自己的 IP，而不是主机名
                                    # 这是生产环境的最佳实践。避免主机名解析问题
#@+doc
# ----
#@+node:swot.20251007173755.7: *3* resilience4j 要改 OrderService -> app-item
#@+doc
# [source,yaml]
# ----
#@@c
#@@language yaml
resilience4j:
  circuitbreaker:
    instances:
      # OrderService:  这里就要改成与 Feign 要使用的 Eureka 服务名一样才行，如下面改成 app-item
      app-item:
        sliding-window-size: 5                  # 需要 5次调用来计算失败率
        failure-rate-threshold: 50              # 50% 失败率才跳闸
        wait-duration-in-open-state: 10s        # 10 秒后进入半开状态
        permitted-number-of-calls-in-half-open-state: 2     # 半开状态允许 2 次调用
        sliding-window-type: COUNT_BASED        # 基于调用次数
        record-exceptions:                      # 哪些异常算失败
          - org.springframework.web.reactive.function.client.WebClientResponseException
          - java.lang.RuntimeException
          - java.io.IOException
        ignore-exceptions:                      # 忽略的异常类型
          - java.lang.IllegalArgumentException
#@+doc
# ----
#
# NOTE: 实际生产要宽松一些的。
#
# [caption=]
# 测试 vs 生产
# [cols="1,1,1",options="header"]
# |===
# | 场景    | 测试配置 | 生产配置
# | 窗口大小 | 5 次调用 | 100次调用
# | 故障阈值 | 50%     | 75%
# | 恢复时间 | 10 秒   | 60秒
# | 目的    | 快速验证 | 稳定运行
# |===
#@+node:swot.20251007173755.6: ** feign 关闭断路器 -> 如果开启，Spring Cloud 设置了 5s 默认的慢超时
#@+doc
# .注释 feign 的断路器功能才能测出来我们自定义的 readTimeout 60s
# [source,yaml]
# ----
#@@c
#@@language yaml
# feign:
  # circuitbreaker:
    # enabled: true
#@+doc
# ----
#
# 在`Resilience4JCircuitBreakerFactory`或`Resilience4JAutoConfiguration`类中，Spring Cloud 会覆盖 Resilience4j 的默认配置：
#
# [source,java]
# ----
#@@language java
# @Configuration
# @ConditionalOnClass(CircuitBreaker.class)
# public class Resilience4JAutoConfiguration {
#
#     @Bean
#     @ConditionalOnMissingBean
#     public CircuitBreakerConfig circuitBreakerConfig() {
#         return CircuitBreakerConfig.custom()
#             // Spring Cloud 会设置更严格的默认值
#             .slowCallDurationThreshold(Duration.ofSeconds(5))  // 这里设置为5秒
#             .slowCallRateThreshold(100)
#             .build();
#     }
# }
# ----
#@-others
#@-leo
