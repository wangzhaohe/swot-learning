:source-highlighter: pygments
:icons: font
:scripts: cjk
:stem: latexmath
:toc:
:toc: right
:toc-title: 目录
:toclevels: 3
:tip-caption: ⚡
:note-caption: ❕
:important-caption: ❗
:warning-caption: ‼️
:caution-caption: ⚠️

= Windows_制作绿色版_nodejs24_postgresql17_沙盘数据管理系统

++++
<button id="toggleButton">目录开关</button>
<script>
    // 获取按钮和 div 元素
    const toggleButton = document.getElementById('toggleButton');
    const contentDiv = document.getElementById('toc');
    contentDiv.style.display = 'block';

    // 添加点击事件监听器
    toggleButton.addEventListener('click', () => {
        // 切换 div 的显示状态
        // if (contentDiv.style.display === 'none' || contentDiv.style.display === '') {
        if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'block';
        } else {
            contentDiv.style.display = 'none';
        }
    });
</script>
++++

== 2026-01-22 mysql:8 迁移到 postgresql:17


=== step1: export data from mysql:8 to mysql:5.7
. 导出 mysql8 中的数据
* mysqldump -h your_mysql_server_ip -u root -p database_name > export_file_name.sql


. 转换排序编码（mysql5.7 不认 mysql8 的排序）
* sed 's/utf8mb4_0900_ai_ci/utf8mb4_general_ci/g' export_file_name.sql > export_file_name_fixed.sql
* 要使用 mysql5.7 是因为 mysql8 不支持 pgloader


. 启动一个旧版本的 MySQL，它天然支持 #pgloader# 的所有协议（会自动去 pull 镜像）
+
[source,console]
----
podman run --name mysql-bridge \
  -e MYSQL_ROOT_PASSWORD=mypass \
  -p 3307:3306 \
  -d docker.m.daocloud.io/library/mysql:5.7
----


. 等几秒钟容器启动后，创建 database 并导入数据
+
[source,console]
----
mysql -h 127.0.0.1 -P 3307 -u root -pmypass -e "CREATE DATABASE database_name;"
mysql -h 127.0.0.1 -P 3307 -u root -pmypass data_management < export_file_name_fixed.sql
----

=== step2: prepare database postgresql:17
. 下载 postgresql 17 image
+
[source,console]
----
podman pull docker.m.daocloud.io/library/postgres:17
----


. 查看 image
+
[source,console]
----
> podman image list
REPOSITORY                             TAG         IMAGE ID      CREATED      SIZE
docker.m.daocloud.io/library/postgres  17          1268669160cb  9 days ago   461 MB
docker.m.daocloud.io/library/node      22-slim     f9834cd4819c  3 weeks ago  232 MB
----


. 运行 postgresql 容器（数据库密码是 naonao）
+
[source,console]
----
podman run --name pg17-server \
  -e POSTGRES_PASSWORD=naonao \
  -p 5432:5432 \
  -v pgdata_vol:/var/lib/postgresql/data:Z \
  -d docker.m.daocloud.io/library/postgres:17
----
+
[TIP]
====
[loweralpha]
1. 如果想确认这个 pgdata_vol 到底在宿主机的哪个物理位置，可以运行： +
podman volume inspect pgdata_vol

2. pgdata_vol 是自己起的卷名，查看目前电脑上已经有哪些命名卷了，可以运行： +
podman volume ls

3. :Z	SELinux 选项	授权证明，允许读写（在 windows10/11 或者 macos 上可以不加 Z 选项）
====


. 查看容器已经在运行了
+
[source,console]
----
> podman container list
CONTAINER ID  IMAGE                                     COMMAND     CREATED        STATUS        PORTS                   NAMES
eb26e62fd368  docker.m.daocloud.io/library/postgres:17  postgres    7 seconds ago  Up 7 seconds  0.0.0.0:5432->5432/tcp  pg17-server
----

. 创建数据库 data_management
+
[source,console]
----
podman exec -it pg17-server psql -U postgres -c "CREATE DATABASE data_management;"
----

=== step3: import data from mysql:5.7 to postgresql:17
. 创建文件 migrate.load
+
[source,console]
----
LOAD DATABASE
     FROM mysql://root:mypass@127.0.0.1:3307/data_management
     INTO postgresql://postgres:naonao@localhost:5432/data_management

 WITH include drop, create tables, create indexes, reset sequences, foreign keys

  SET maintenance_work_mem to '128MB', 
      work_mem to '12MB'

 CAST 
      -- 1. 强制将所有 tinyint(x) 转换为 boolean，并丢弃修饰符
      type tinyint to boolean drop typemod using tinyint-to-boolean,
      
      -- 2. 针对这种已经变成了 boolean(4) 的情况，显式拦截 boolean 类型并丢弃修饰符
      type boolean to boolean drop typemod,
      
      -- 3. 时间类型转换
      type datetime to timestamptz drop default;
----


. 运行 pgloader 容器执行迁移
+
.在终端中切换到 migrate.load 所在的目录，运行以下命令
[source,console]
----
pgloader migrate.load
----
+
TIP: 在 macos 中安装 pgloader：`brew install pgloader`

. 查看 postgresql 中的数据是否正确

== 2026-01-25 从 podman postgresql17 迁移数据到 windows 绿色包环境


=== step1: 从 Macos 导出数据
从 podman 中导出 postgresql 数据

1. 在容器内生成文件（直接由 pg_dump 写入磁盘，不经过终端管道）
+
[source,console]
----
podman exec pg17-server pg_dump -U postgres -n data_management -Fc data_management -f /tmp/safe_data.dump
----

2. 将文件从容器内部拷贝出来
+
[source,console]
----
podman cp pg17-server:/tmp/safe_data.dump ./data_management.dump
----

3. 验证文件完整性（必须显示为: PostgreSQL custom dump archive）
[source,console]
----
> file ./data_management.dump
data_management.dump: PostgreSQL custom database dump - v1.16-0
----

=== step2: 从 windows 导入数据
. 解压 postgresql-17.7-2-windows-x64-binaries.zip

. 进入 bin 目录
+
[source,console]
----
cd E:\deploy\postgresql-17.7-2-windows-x64-binaries\pgsql\bin
---- 

. 初始化数据库：
+
.C:\pgsql\data 是数据库文件保存目录
[source,console]
----
.\initdb.exe -D C:\pgsql\data -U postgres -W -E UTF8
----

. 启动数据库服务：
+
[source,console]
----
.\pg_ctl.exe -D C:\pgsql\data -l logfile start
----

. 创建数据库：
+
.先指定初始化时自动创建的数据库 postgres 来进行连接，要不然创建不了数据库 data_management。
[source,console]
----
.\psql.exe -U postgres -d postgres -c "CREATE DATABASE data_management;"
----

. 将导出的数据复制到 windows
+
.导入数据
[source,console]
----
.\pg_restore.exe -U postgres -d data_management -v --no-owner "../../../data_management.dump"
----

== 2026-01-28 在 windows 下生成项目 node_modules 目录
. 解压: node-v24.13.0-win-x64.zip

. 移动文件夹：
    * 建议将解压后的 node-v24.13.0-win-x64 文件夹移到一个固定的位置，例如 C:\Program Files\nodejs。

. 设置系统 Path：
    .. 按下 Win + S 搜索 “编辑系统环境变量” 并打开。
    .. 点击 “环境变量” 按钮。
    .. 在“系统变量”栏找到 Path，点击“编辑”。
    .. 点击“新建”，将你刚才 Node.js 文件夹的全路径粘贴进去（例如 C:\Program Files\nodejs）。
    .. 一路点击“确定”保存

. 复制项目 sandbox 到 windows 系统中，然后安装依赖
+
[source,console]
----
cd sandbox/backend
npm install
----

== 2026-01-29 在 windows 下设置 postgresql 密码
在 Windows 环境下，PostgreSQL 的用户信息和密码并不像普通文件那样可以直接“查看”，因为它们是经过哈希加密存储在数据库内部表的。
不过，我们可以通过**登录尝试**来判断是否有密码，并使用 SQL 命令来设置新密码。

---
1. 检查是否有密码
+
* 由于使用的是解压版，默认情况下 PostgreSQL 可能配置为 `trust` 模式（即本地登录不需要密码）。请在终端（`.\bin` 目录下）执行：
+
[source,console]
----
.\psql.exe -U postgres -d postgres
----

* 如果直接进去了（出现 `postgres=#` 提示符）：说明**没有密码**，或者当前处于信任模式。
* 如果提示 `Password for user postgres:**`：说明**有密码**。

2. 设置密码为 `naonao`，无论之前有没有密码，你都可以通过以下步骤将其修改为 `naonao`：
* 方法 A：在 psql 交互界面修改（最推荐）
+
如果你已经成功进入了 `psql`（看到 `postgres=#`），直接输入：
+
[source,sql]
----
ALTER USER postgres WITH PASSWORD 'naonao';
----
+
NOTE: **注意**：末尾的**分号 `;**` 必须带上。执行成功后会显示 `ALTER ROLE`。输入 `\q` 退出。

* 方法 B：单条命令修改
+
如果你不想进入交互界面，可以直接在 CMD/PowerShell 运行：
+
[source,console]
----
.\psql.exe -U postgres -d postgres -c "ALTER USER postgres WITH PASSWORD 'naonao';"
----

3. 关键一步：确保密码生效 (pg_hba.conf)
+
在 Windows 下，解压版默认可能允许免密登录。如果你设置了密码但发现登录时还是不提示输入密码，需要修改配置文件：
+
.. 打开你的数据目录：`C:\pgsql\data`。
.. 找到 **`pg_hba.conf`** 文件，用记事本打开。
.. 拉到最底部，找到类似这样的一行：
+
[source,text]
----
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    all             all             127.0.0.1/32            trust
----

4. 将最后的 **`trust`** 改为 **`scram-sha-256`** (或者 `md5`)：
+
[source,text]
----
host    all             all             127.0.0.1/32            scram-sha-256
----

5. **重启数据库**使配置生效：
+
[source,console]
----
.\pg_ctl.exe restart -D C:\pgsql\data
----

6. 验证密码
+
.重启后，再次尝试登录：
[source,console]
----
.\psql.exe -U postgres
----
+
此时系统应该会强制要求你输入密码，输入 `naonao` 即可进入。

IMPORTANT: 设置好密码后，你的项目配置文件（如 `.env`）里记得也要同步更新数据库密码。

== 2026-01-30 在 windows 下绿色部署 node.js + postgresql
这份文档将为你整理出一套完整的 **绿色版 Node.js + PostgreSQL + WinSW** 部署方案。你可以根据这份文档直接配置并打包发给客户。

该方案实现了：**免安装、零配置（对于客户）、开机自启、崩溃自动重启、后台静默运行。**

=== 1. 目录结构预览
在 windows 开发机上，创建一个名为 `DeployPackage` 的文件夹，结构如下：
+
[source,console]
----
DeployPackage/
├── pgsql/                      # PostgreSQL 15 绿色版解压目录
├── node/                       # Node.js 绿色版解压目录
├── app/                        # 你的 Express 项目代码
│   ├── node_modules/           # 预先执行过 npm install 的包
│   └── backend/index.js        # 入口文件
├── data/                       # (空文件夹) 用于存放数据库数据
├── logs/                       # (空文件夹) 用于存放运行日志
├── hongfeng-data-service.exe   # 重命名后的 WinSW-x64.exe
├── hongfeng-data-service.xml   # WinSW 配置文件
├── temp_pwd.txt                # 默认密码
├── start_server.bat            # 核心启动脚本
└── 一键启动服务.bat              # 客户运行的脚本
----

=== 2. 核心启动脚本 (`start_server.bat`)
这个脚本负责按顺序拉起 postgresql & Node.js。

[source,shell]
----
@echo off
set PROJECT_DIR=%~dp0
set PG_PATH=%PROJECT_DIR%pgsql\bin
set DATA_PATH=%PROJECT_DIR%data
set NODE_PATH=%PROJECT_DIR%node

echo [1/2] 正在启动 PostgreSQL...
:: 启动数据库进程
"%PG_PATH%\pg_ctl.exe" -D "%DATA_PATH%" -l "%PROJECT_DIR%logs\pgsql.log" start

:: 等待 5 秒确保数据库完全就绪
timeout /t 5 /nobreak > nul

echo [2/2] 正在启动 Node.js 服务...
:: 临时设置环境变量
set PATH=%NODE_PATH%;%PATH%
:: 验证一下是否使用了自已的 node（可选）
node -v >> "%PROJECT_DIR%logs\startup_debug.log"

cd /d "%PROJECT_DIR%app\backend"
:: 启动你的程序
node app.js
----

=== 3. WinSW 配置文件 (`hongfeng-data-service.xml`)
注意文件名必须与 `.exe` 文件名严格一致。

[source,xml]
----
<service>
  <id>ExpressAppService</id>
  <name>HongFeng data Service</name>
  <description>Node.js Express + PostgreSQL 17 绿色版后台服务</description>
  
  <executable>%BASE%\start_server.bat</executable>
  <workingdirectory>%BASE%</workingdirectory>
  
  <onfailure action="restart" delay="30 sec"/>
  
  <log mode="roll">
    <logpath>%BASE%\logs</logpath>
  </log>
</service>
----

=== 4. 客户一键启动脚本 (`一键启动服务.bat`)
[source,shell]
----
@echo off
setlocal enabledelayedexpansion
:: 强制切换到当前脚本所在目录
cd /d "%~dp0"

:: 设置 CMD 窗口编码为简体中文，防止显示乱码
chcp 936 >nul

title 红丰数据服务 - 一键部署工具

echo ==========================================
echo    正在初始化系统组件，请稍候...
echo ==========================================

:: 0. 检查管理员权限
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo [错误] 请右键点击此脚本，选择“以管理员身份运行”！
    pause
    exit
)

:: 1. 初始化数据库 (仅在首次安装时执行)
if not exist "data\PG_VERSION" (
    echo [1/4] 正在首次初始化数据库...
    if exist "temp_pwd.txt" (
        :: 使用指定的密码文件初始化
        "pgsql\bin\initdb.exe" -D "data" -U postgres -A scram-sha-256 --pwfile="temp_pwd.txt"
        echo 数据库初始化完成。
        :: 根据你的需求，初始化完后可以删除密码文件以保安全
        :: del temp_pwd.txt
    ) else (
        echo [错误] 根目录下未找到 temp_pwd.txt (内需包含初始密码 naonao)
        pause
        exit
    )
) else (
    echo [1/4] 数据库目录已存在，跳过初始化。
)

:: 2. 配置防火墙规则 (允许 8019 端口入站)
set PORT=8019
set RULE_NAME="HongFeng_Service_Port"

echo [2/4] 正在配置防火墙规则...
:: 先尝试删除可能存在的旧规则，确保规则名唯一且配置最新
netsh advfirewall firewall delete rule name=%RULE_NAME% >nul 2>&1
:: 添加新规则：针对 8019 端口放行所有 TCP 流量
netsh advfirewall firewall add rule name=%RULE_NAME% dir=in action=allow protocol=TCP localport=%PORT% description="Allow HongFeng Data Service" >nul 2>&1

if %errorlevel% equ 0 (
    echo      防火墙规则已配置，准许局域网通过 %PORT% 端口访问。
) else (
    echo      [警告] 防火墙配置失败，请确保没有第三方安全软件拦截。
)

:: 3. 注册并启动 Windows 服务 (WinSW)
echo [3/4] 正在注册并启动后台服务...
set SERVICE_EXE=hongfeng-data-service.exe

if exist "%SERVICE_EXE%" (
    :: 先停掉并卸载旧服务（如果存在），确保重新覆盖安装
    %SERVICE_EXE% stop >nul 2>&1
    %SERVICE_EXE% uninstall >nul 2>&1
    
    :: 安装并启动
    %SERVICE_EXE% install
    if !errorlevel! equ 0 (
        %SERVICE_EXE% start
        echo      后台服务已成功注册并启动。
    ) else (
        echo      [错误] 服务安装失败，请检查 XML 配置文件是否正确。
    )
) else (
    echo [错误] 未找到服务程序 %SERVICE_EXE%，请检查文件名是否正确。
)

:: 4. 自动获取本机局域网 IP 地址
echo [4/4] 正在生成访问报告...
set "IP=127.0.0.1"
:: 查找路由表中默认网关所在的活动 IP
for /f "tokens=4" %%a in ('route print ^| findstr "\<0.0.0.0\>"') do (
    set "IP=%%a"
)

echo ==========================================
echo    系统部署成功！
echo    您可以关闭此窗口，系统将在后台持续运行。
echo.
echo    本地访问地址: http://localhost:%PORT%
echo    局域网访问地址: http://%IP%:%PORT%
echo.
echo    如需停止服务，请运行: %SERVICE_EXE% stop
echo ==========================================
pause
----

=== 5. 部署步骤（你的操作）
1. **准备环境**：
* 下载 [PostgreSQL Binary Zip](https://www.enterprisedb.com/download-postgresql-binaries) 并解压到 `pgsql`。
* 下载 [Node.js Windows Zip](https://nodejs.org/en/download/prebuilt-binaries) 并解压到 `node`。
* 下载 [WinSW-x64.exe](https://github.com/winsw/winsw/releases) 并重命名为 hongfeng-data-serveice.exe

2. **配置代码**：
* 确保你的 Express(基于node.js的项目) 代码中
** PostgreSQL 的连接字符串指向 `localhost:5432`
** 用户名为 `postgres`
** 密码为空（因为 `initdb` 时用了 `-A trust`，如需密码可另行配置）

IMPORTANT: 前面已经设置密码为 `naonao`

3. **打包**：
* 使用 7-Zip 或 WinRAR 将整个 `DeployPackage` 文件夹压缩。

4. 发送给客户做单机部署

=== 6. 交付给客户的操作说明
**尊敬的客户，请按以下步骤部署系统：**

1. 解压压缩包到任意目录（路径请勿包含中文或空格）。
2. 进入文件夹，找到 **`一键启动服务.bat`**。
3. **右键点击**该文件，选择 **“以管理员身份运行”**。
4. 等待黑色窗口显示“系统部署成功”后，即可关闭窗口。
5. 打开浏览器，访问 `http://localhost:8019` 即可使用。
6. 确认开机启动生效方法
.. 查看操作系统服务中是否有 「hongfeng data Service」 正在运行，且启动类型为自动，说明开机自启已经注册成功。
.. 重启电脑，浏览器能访问 `http://localhost:8019` 说明开机自启生效

=== 7. 如何停止服务或卸载服务？
如果后续需要停止服务，在命令行运行：

* `hongfeng-data-service.exe stop` (停止运行)
* `hongfeng-data-service.exe uninstall` (从系统中彻底删除服务)

=== 8. 一键备份数据库.bat
[source,shell]
----
@echo off
setlocal enabledelayedexpansion
:: 切换到当前目录
cd /d "%~dp0"

:: 设置编码为中文
chcp 936 >nul

title 红枫数据服务 - 数据库备份工具

:: =================配置区==================
set PG_DUMP_EXE="%~dp0pgsql\bin\pg_dump.exe"
set BACKUP_DIR="%~dp0backups"
set DB_USER=postgres
set DB_NAME=postgres
:: 设置导出密码的环境变量（防止弹出输入密码提示）
set PGPASSWORD=naonao
:: =========================================

echo ==========================================
echo    正在启动数据库备份，请稍候...
echo ==========================================

:: 1. 创建备份文件夹
if not exist %BACKUP_DIR% (
    mkdir %BACKUP_DIR%
    echo 已创建备份目录: %BACKUP_DIR%
)

:: 2. 生成时间戳文件名 (格式: YYYYMMDD_HHMM)
set TIMESTAMP=%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%
:: 处理小时是个位数时可能出现的空格情况
set TIMESTAMP=%TIMESTAMP: =0%

set FILE_NAME=db_backup_%TIMESTAMP%.sql
set FULL_PATH=%BACKUP_DIR%\%FILE_NAME%

:: 3. 执行备份
echo 正在导出数据到: %FILE_NAME%...
%PG_DUMP_EXE% -U %DB_USER% -h localhost -p 5432 -F p -f %FULL_PATH% %DB_NAME%

if %errorlevel% equ 0 (
    echo.
    echo ==========================================
    echo    备份成功！
    echo    文件位置: %FULL_PATH%
    echo ==========================================
) else (
    echo.
    echo [错误] 备份失败！请检查数据库是否正在运行。
)

:: 清除密码环境变量
set PGPASSWORD=
pause
----

=== 9. 一键停止并卸载服务.bat
[source,console]
----
@echo off
setlocal enabledelayedexpansion
:: 强制切换到当前脚本所在目录
cd /d "%~dp0"

:: 设置 CMD 窗口编码为简体中文
chcp 936 >nul

title 红枫数据服务 - 卸载工具

echo ==========================================
echo    警告：正在准备停止并卸载系统服务
echo ==========================================

:: 0. 检查管理员权限
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo [错误] 请右键点击此脚本，选择“以管理员身份运行”！
    pause
    exit
)

set SERVICE_EXE=hongfeng-data-service.exe
set RULE_NAME="HongFeng_Service_Port"

:: 1. 停止并卸载 Windows 服务
echo [1/3] 正在停止后台进程并注销服务...
if exist "%SERVICE_EXE%" (
    %SERVICE_EXE% stop >nul 2>&1
    %SERVICE_EXE% uninstall
    if !errorlevel! equ 0 (
        echo      服务已成功从系统中移除。
    ) else (
        echo      [提示] 服务可能未在运行或已被移除。
    )
) else (
    echo [错误] 未找到主程序 %SERVICE_EXE%。
)

:: 2. 彻底关闭残留的 PostgreSQL 进程 (可选，防残留)
echo [2/3] 正在清理数据库残留进程...
taskkill /f /im postgres.exe >nul 2>&1

:: 3. 清理防火墙规则
echo [3/3] 正在移除防火墙开放端口...
netsh advfirewall firewall delete rule name=%RULE_NAME% >nul 2>&1
if %errorlevel% equ 0 (
    echo      防火墙规则已清理。
)

echo ==========================================
echo    卸载完成！
echo    注意：数据库数据文件 (data 目录) 已保留，未被删除。
echo ==========================================
pause
----

